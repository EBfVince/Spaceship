/*! For license information please see LICENSES */
(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{448:function(t,e,n){"use strict";n.d(e,"a",(function(){return w}));var r=n(444),o=n(446),c=n(449),h=n(450);class l{constructor(t,e){this._delegate=t,this.firebase=e,Object(c._addComponent)(t,new o.a("app-compat",(()=>this),"PUBLIC")),this.container=t.container}get automaticDataCollectionEnabled(){return this._delegate.automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this._delegate.automaticDataCollectionEnabled=t}get name(){return this._delegate.name}get options(){return this._delegate.options}delete(){return new Promise((t=>{this._delegate.checkDestroyed(),t()})).then((()=>(this.firebase.INTERNAL.removeApp(this.name),Object(c.deleteApp)(this._delegate))))}_getService(t,e=c._DEFAULT_ENTRY_NAME){var n;this._delegate.checkDestroyed();const r=this._delegate.container.getProvider(t);return r.isInitialized()||"EXPLICIT"!==(null===(n=r.getComponent())||void 0===n?void 0:n.instantiationMode)||r.initialize(),r.getImmediate({identifier:e})}_removeServiceInstance(t,e=c._DEFAULT_ENTRY_NAME){this._delegate.container.getProvider(t).clearInstance(e)}_addComponent(component){Object(c._addComponent)(this._delegate,component)}_addOrOverwriteComponent(component){Object(c._addOrOverwriteComponent)(this._delegate,component)}toJSON(){return{name:this.name,automaticDataCollectionEnabled:this.automaticDataCollectionEnabled,options:this.options}}}const d={"no-app":"No Firebase App '{$appName}' has been created - call Firebase App.initializeApp()","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance."},f=new r.b("app-compat","Firebase",d);const m=function t(){const e=function(t){const e={},n={__esModule:!0,initializeApp:function(o,h={}){const l=c.initializeApp(o,h);if(Object(r.f)(e,l.name))return e[l.name];const d=new t(l,n);return e[l.name]=d,d},app:o,registerVersion:c.registerVersion,setLogLevel:c.setLogLevel,onLog:c.onLog,apps:null,SDK_VERSION:c.SDK_VERSION,INTERNAL:{registerComponent:function(component){const e=component.name,h=e.replace("-compat","");if(c._registerComponent(component)&&"PUBLIC"===component.type){const c=(t=o())=>{if("function"!=typeof t[h])throw f.create("invalid-app-argument",{appName:e});return t[h]()};void 0!==component.serviceProps&&Object(r.j)(c,component.serviceProps),n[h]=c,t.prototype[h]=function(...t){return this._getService.bind(this,e).apply(this,component.multipleInstances?t:[])}}return"PUBLIC"===component.type?n[h]:null},removeApp:function(t){delete e[t]},useAsService:function(t,e){return"serverAuth"===e?null:e},modularAPIs:c}};function o(t){if(t=t||c._DEFAULT_ENTRY_NAME,!Object(r.f)(e,t))throw f.create("no-app",{appName:t});return e[t]}return n.default=n,Object.defineProperty(n,"apps",{get:function(){return Object.keys(e).map((t=>e[t]))}}),o.App=t,n}(l);return e.INTERNAL=Object.assign(Object.assign({},e.INTERNAL),{createFirebaseNamespace:t,extendNamespace:function(t){Object(r.j)(e,t)},createSubscribe:r.h,ErrorFactory:r.b,deepExtend:r.j}),e}(),y=new h.b("@firebase/app-compat");if(Object(r.r)()&&void 0!==self.firebase){y.warn("\n    Warning: Firebase is already defined in the global scope. Please make sure\n    Firebase library is only loaded once.\n  ");const t=self.firebase.SDK_VERSION;t&&t.indexOf("LITE")>=0&&y.warn("\n    Warning: You are trying to load Firebase while using Firebase Performance standalone script.\n    You should load Firebase Performance with this instance of Firebase to avoid loading duplicate code.\n    ")}const w=m;var v;Object(c.registerVersion)("@firebase/app-compat","0.2.30",v)},506:function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return ll})),n.d(e,"b",(function(){return uh})),n.d(e,"c",(function(){return Qc})),n.d(e,"d",(function(){return Lc})),n.d(e,"e",(function(){return pl})),n.d(e,"f",(function(){return ch})),n.d(e,"g",(function(){return A})),n.d(e,"h",(function(){return lh})),n.d(e,"i",(function(){return yl})),n.d(e,"j",(function(){return wl})),n.d(e,"k",(function(){return K})),n.d(e,"l",(function(){return Ll})),n.d(e,"m",(function(){return Ee})),n.d(e,"n",(function(){return X})),n.d(e,"o",(function(){return Y})),n.d(e,"p",(function(){return kc})),n.d(e,"q",(function(){return x})),n.d(e,"r",(function(){return fe})),n.d(e,"s",(function(){return I})),n.d(e,"t",(function(){return Cc})),n.d(e,"u",(function(){return kl})),n.d(e,"v",(function(){return zl})),n.d(e,"w",(function(){return Gl})),n.d(e,"x",(function(){return eh})),n.d(e,"y",(function(){return qc})),n.d(e,"z",(function(){return jc})),n.d(e,"A",(function(){return Pc})),n.d(e,"B",(function(){return Nl})),n.d(e,"C",(function(){return Ul})),n.d(e,"D",(function(){return sh})),n.d(e,"E",(function(){return Uc})),n.d(e,"F",(function(){return Xc})),n.d(e,"G",(function(){return Jc})),n.d(e,"H",(function(){return rh})),n.d(e,"I",(function(){return sl})),n.d(e,"J",(function(){return rl})),n.d(e,"K",(function(){return Hc})),n.d(e,"L",(function(){return Ml})),n.d(e,"M",(function(){return _l})),n.d(e,"N",(function(){return El})),n.d(e,"O",(function(){return Tl})),n.d(e,"P",(function(){return Sl})),n.d(e,"Q",(function(){return xl})),n.d(e,"R",(function(){return Cl})),n.d(e,"S",(function(){return Kl})),n.d(e,"T",(function(){return Xh})),n.d(e,"U",(function(){return Jh})),n.d(e,"V",(function(){return ih})),n.d(e,"W",(function(){return oh})),n.d(e,"X",(function(){return Ol})),n.d(e,"Y",(function(){return Rl})),n.d(e,"Z",(function(){return Hh})),n.d(e,"ab",(function(){return zh})),n.d(e,"bb",(function(){return Gc})),n.d(e,"cb",(function(){return Bc})),n.d(e,"db",(function(){return jl})),n.d(e,"eb",(function(){return Bl})),n.d(e,"fb",(function(){return Dl})),n.d(e,"gb",(function(){return w})),n.d(e,"hb",(function(){return bl})),n.d(e,"ib",(function(){return el})),n.d(e,"jb",(function(){return tl})),n.d(e,"kb",(function(){return Al})),n.d(e,"lb",(function(){return nh})),n.d(e,"mb",(function(){return $h}));var r=n(449),o=n(446),c=n(450),h=n(444),l=n(507);const d="@firebase/firestore";class f{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}f.UNAUTHENTICATED=new f(null),f.GOOGLE_CREDENTIALS=new f("google-credentials-uid"),f.FIRST_PARTY=new f("first-party-uid"),f.MOCK_USER=new f("mock-user");let m="10.10.0";const b=new c.b("@firebase/firestore");function y(){return b.logLevel}function w(t){b.setLogLevel(t)}function v(t,...e){if(b.logLevel<=c.a.DEBUG){const n=e.map(E);b.debug(`Firestore (${m}): ${t}`,...n)}}function _(t,...e){if(b.logLevel<=c.a.ERROR){const n=e.map(E);b.error(`Firestore (${m}): ${t}`,...n)}}function I(t,...e){if(b.logLevel<=c.a.WARN){const n=e.map(E);b.warn(`Firestore (${m}): ${t}`,...n)}}function E(t){if("string"==typeof t)return t;try{return function(t){return JSON.stringify(t)}(t)}catch(e){return t}}function T(t="Unexpected state"){const e=`FIRESTORE (${m}) INTERNAL ASSERTION FAILED: `+t;throw _(e),new Error(e)}function S(t,e){t||T()}function x(t,e){t||T()}function C(t,e){return t}const D={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class A extends h.c{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class N{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class k{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class O{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(f.UNAUTHENTICATED)))}shutdown(){}}class R{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class M{constructor(t){this.t=t,this.currentUser=f.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let o=new N;this.o=()=>{this.i++,this.currentUser=this.u(),o.resolve(),o=new N,t.enqueueRetryable((()=>r(this.currentUser)))};const c=()=>{const e=o;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},h=t=>{v("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),c()};this.t.onInit((t=>h(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?h(t):(v("FirebaseAuthCredentialsProvider","Auth not yet detected"),o.resolve(),o=new N)}}),0),c()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(v("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(S("string"==typeof e.accessToken),new k(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return S(null===t||"string"==typeof t),new f(t)}}class P{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=f.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class F{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new P(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable((()=>e(f.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class L{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class V{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){const n=t=>{null!=t.error&&v("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.R;return this.R=t.token,v("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const r=t=>{v("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.A.onInit((t=>r(t))),setTimeout((()=>{if(!this.appCheck){const t=this.A.getImmediate({optional:!0});t?r(t):v("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(S("string"==typeof t.token),this.R=t.token,new L(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function j(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class U{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const r=j(40);for(let i=0;i<r.length;++i)n.length<20&&r[i]<e&&(n+=t.charAt(r[i]%t.length))}return n}}function B(t,e){return t<e?-1:t>e?1:0}function G(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function z(t){return t+"\0"}class K{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new A(D.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new A(D.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new A(D.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new A(D.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return K.fromMillis(Date.now())}static fromDate(t){return K.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new K(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?B(this.nanoseconds,t.nanoseconds):B(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ${constructor(t){this.timestamp=t}static fromTimestamp(t){return new $(t)}static min(){return new $(new K(0,0))}static max(){return new $(new K(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Q{constructor(t,e,n){void 0===e?e=0:e>t.length&&T(),void 0===n?n=t.length-e:n>t.length-e&&T(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===Q.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Q?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),i=e.get(r);if(n<i)return-1;if(n>i)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class W extends Q{construct(t,e,n){return new W(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new A(D.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new W(e)}static emptyPath(){return new W([])}}const H=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Y extends Q{construct(t,e,n){return new Y(t,e,n)}static isValidIdentifier(t){return H.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Y.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Y(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const o=()=>{if(0===n.length)throw new A(D.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new A(D.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new A(D.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(o(),r++)}if(o(),i)throw new A(D.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Y(e)}static emptyPath(){return new Y([])}}class X{constructor(t){this.path=t}static fromPath(t){return new X(W.fromString(t))}static fromName(t){return new X(W.fromString(t).popFirst(5))}static empty(){return new X(W.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===W.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return W.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new X(new W(t.slice()))}}class J{constructor(t,e,n,r){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=r}}function Z(t){return t.fields.find((t=>2===t.kind))}function tt(t){return t.fields.filter((t=>2!==t.kind))}J.UNKNOWN_ID=-1;class et{constructor(t,e){this.fieldPath=t,this.kind=e}}class nt{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new nt(0,ot.min())}}function st(t,e){const n=t.toTimestamp().seconds,r=t.toTimestamp().nanoseconds+1,i=$.fromTimestamp(1e9===r?new K(n+1,0):new K(n,r));return new ot(i,X.empty(),e)}function it(t){return new ot(t.readTime,t.key,-1)}class ot{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new ot($.min(),X.empty(),-1)}static max(){return new ot($.max(),X.empty(),-1)}}function at(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=X.comparator(t.documentKey,e.documentKey),0!==n?n:B(t.largestBatchId,e.largestBatchId))}const ut="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ct{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function ht(t){if(t.code!==D.FAILED_PRECONDITION||t.message!==ut)throw t;v("LocalStore","Unexpectedly lost primary lease")}class lt{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&T(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new lt(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof lt?e:lt.resolve(e)}catch(t){return lt.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):lt.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):lt.reject(e)}static resolve(t){return new lt(((e,n)=>{e(t)}))}static reject(t){return new lt(((e,n)=>{n(t)}))}static waitFor(t){return new lt(((e,n)=>{let r=0,i=0,s=!1;t.forEach((t=>{++r,t.next((()=>{++i,s&&i===r&&e()}),(t=>n(t)))})),s=!0,i===r&&e()}))}static or(t){let e=lt.resolve(!1);for(const n of t)e=e.next((t=>t?lt.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}static mapArray(t,e){return new lt(((n,r)=>{const i=t.length,s=new Array(i);let o=0;for(let c=0;c<i;c++){const a=c;e(t[a]).next((t=>{s[a]=t,++o,o===i&&n(s)}),(t=>r(t)))}}))}static doWhile(t,e){return new lt(((n,r)=>{const o=()=>{!0===t()?e().next((()=>{o()}),r):n()};o()}))}}class ft{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new N,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new pt(t,e.error)):this.V.resolve()},this.transaction.onerror=e=>{const n=_t(e.target.error);this.V.reject(new pt(t,n))}}static open(t,e,n,r){try{return new ft(e,t.transaction(r,n))}catch(t){throw new pt(e,t)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(v("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new wt(e)}}class mt{constructor(t,e,n){this.name=t,this.version=e,this.p=n,12.2===mt.S(Object(h.q)())&&_("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return v("SimpleDb","Removing database:",t),vt(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!Object(h.v)())return!1;if(mt.C())return!0;const t=Object(h.q)(),e=mt.S(t),n=0<e&&e<10,r=mt.v(t),i=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||i)}static C(){var e;return void 0!==t&&"YES"===(null===(e=t.__PRIVATE_env)||void 0===e?void 0:e.F)}static M(t,e){return t.store(e)}static S(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async O(t){return this.db||(v("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new pt(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new A(D.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new A(D.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new pt(t,r))},r.onupgradeneeded=t=>{v("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.p.N(e,r.transaction,t.oldVersion,this.version).next((()=>{v("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.L&&(this.db.onversionchange=t=>this.L(t)),this.db}B(t){this.L=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const i="readonly"===e;let s=0;for(;;){++s;try{this.db=await this.O(t);const e=ft.open(this.db,t,i?"readonly":"readwrite",n),s=r(e).next((t=>(e.g(),t))).catch((t=>(e.abort(t),lt.reject(t)))).toPromise();return s.catch((()=>{})),await e.m,s}catch(t){const e=t,n="FirebaseError"!==e.name&&s<3;if(v("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class gt{constructor(t){this.k=t,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(t){this.k=t}done(){this.q=!0}U(t){this.K=t}delete(){return vt(this.k.delete())}}class pt extends A{constructor(t,e){super(D.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function yt(t){return"IndexedDbTransactionError"===t.name}class wt{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(v("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(v("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),vt(n)}add(t){return v("SimpleDb","ADD",this.store.name,t,t),vt(this.store.add(t))}get(t){return vt(this.store.get(t)).next((e=>(void 0===e&&(e=null),v("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return v("SimpleDb","DELETE",this.store.name,t),vt(this.store.delete(t))}count(){return v("SimpleDb","COUNT",this.store.name),vt(this.store.count())}W(t,e){const n=this.options(t,e),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const t=r.getAll(n.range);return new lt(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}{const t=this.cursor(n),e=[];return this.G(t,((t,n)=>{e.push(n)})).next((()=>e))}}j(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new lt(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}H(t,e){v("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.J=!1;const r=this.cursor(n);return this.G(r,((t,e,n)=>n.delete()))}Y(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.G(r,e)}Z(t){const e=this.cursor({});return new lt(((n,r)=>{e.onerror=t=>{const e=_t(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}G(t,e){const n=[];return new lt(((r,i)=>{t.onerror=t=>{i(t.target.error)},t.onsuccess=t=>{const i=t.target.result;if(!i)return void r();const s=new gt(i),o=e(i.primaryKey,i.value,s);if(o instanceof lt){const t=o.catch((t=>(s.done(),lt.reject(t))));n.push(t)}s.isDone?r():null===s.$?i.continue():i.continue(s.$)}})).next((()=>lt.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.J?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function vt(t){return new lt(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=_t(t.target.error);n(e)}}))}let bt=!1;function _t(t){const e=mt.S(Object(h.q)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new A("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return bt||(bt=!0,setTimeout((()=>{throw t}),0)),t}}return t}class It{constructor(t,e){this.asyncQueue=t,this.X=e,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(t){v("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{v("IndexBackfiller",`Documents written: ${await this.X.te()}`)}catch(t){yt(t)?v("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):await ht(t)}await this.ee(6e4)}))}}class Et{constructor(t,e){this.localStore=t,this.persistence=e}async te(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.ne(e,t)))}ne(t,e){const n=new Set;let r=e,i=!0;return lt.doWhile((()=>!0===i&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return v("IndexBackfiller",`Processing collection: ${e}`),this.re(t,e,r).next((t=>{r-=t,n.add(e)}));i=!1})))).next((()=>e-r))}re(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((r=>this.localStore.localDocuments.getNextDocuments(t,e,r,n).next((n=>{const i=n.changes;return this.localStore.indexManager.updateIndexEntries(t,i).next((()=>this.ie(r,n))).next((n=>(v("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>i.size))}))))}ie(t,e){let n=t;return e.changes.forEach(((t,e)=>{const r=it(e);at(r,n)>0&&(n=r)})),new ot(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Tt{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.se(t),this.oe=t=>e.writeSequenceNumber(t))}se(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.oe&&this.oe(t),t}}function St(t){return null==t}function xt(t){return 0===t&&1/t==-1/0}function Ct(t){return"number"==typeof t&&Number.isInteger(t)&&!xt(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}function Dt(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Nt(e)),e=At(t.get(n),e);return Nt(e)}function At(t,e){let n=e;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function Nt(t){return t+""}function kt(t){const e=t.length;if(S(e>=2),2===e)return S(""===t.charAt(0)&&""===t.charAt(1)),W.emptyPath();const n=e-2,r=[];let o="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&T(),t.charAt(e+1)){case"":const s=t.substring(i,e);let n;0===o.length?n=s:(o+=s,n=o,o=""),r.push(n);break;case"":o+=t.substring(i,e),o+="\0";break;case"":o+=t.substring(i,e+1);break;default:T()}i=e+2}return new W(r)}Tt._e=-1;const Ot=["userId","batchId"];function Rt(t,e){return[t,Dt(e)]}function Mt(t,e,n){return[t,Dt(e),n]}const Pt={},Ft=["prefixPath","collectionGroup","readTime","documentId"],Lt=["prefixPath","collectionGroup","documentId"],Vt=["collectionGroup","readTime","prefixPath","documentId"],qt=["canonicalId","targetId"],jt=["targetId","path"],q=["path","targetId"],Ut=["collectionId","parent"],Bt=["indexId","uid"],Gt=["uid","sequenceNumber"],zt=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Kt=["indexId","uid","orderedDocumentKey"],$t=["userId","collectionPath","documentId"],Qt=["userId","collectionPath","largestBatchId"],Wt=["userId","collectionGroup","largestBatchId"],Ht=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Yt=[...Ht,"documentOverlays"],Xt=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Jt=Xt,Zt=[...Jt,"indexConfiguration","indexState","indexEntries"];class te extends ct{constructor(t,e){super(),this.ae=t,this.currentSequenceNumber=e}}function ee(t,e){const n=C(t);return mt.M(n.ae,e)}function ne(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function re(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function se(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class ie{constructor(t,e){this.comparator=t,this.root=e||ae.EMPTY}insert(t,e){return new ie(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,ae.BLACK,null,null))}remove(t){return new ie(this.comparator,this.root.remove(t,this.comparator).copy(null,null,ae.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new oe(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new oe(this.root,t,this.comparator,!1)}getReverseIterator(){return new oe(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new oe(this.root,t,this.comparator,!0)}}class oe{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!t.isEmpty();)if(i=e?n(t.key,e):1,e&&r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class ae{constructor(t,e,n,r,i){this.key=t,this.value=e,this.color=null!=n?n:ae.RED,this.left=null!=r?r:ae.EMPTY,this.right=null!=i?i:ae.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,i){return new ae(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const i=n(t,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return ae.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return ae.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,ae.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,ae.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw T();if(this.right.isRed())throw T();const t=this.left.check();if(t!==this.right.check())throw T();return t+(this.isRed()?0:1)}}ae.EMPTY=null,ae.RED=!0,ae.BLACK=!1,ae.EMPTY=new class{constructor(){this.size=0}get key(){throw T()}get value(){throw T()}get color(){throw T()}get left(){throw T()}get right(){throw T()}copy(t,e,n,r,i){return this}insert(t,e,n){return new ae(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ue{constructor(t){this.comparator=t,this.data=new ie(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new ce(this.data.getIterator())}getIteratorFrom(t){return new ce(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof ue))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new ue(this.comparator);return e.data=t,e}}class ce{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function he(t){return t.hasNext()?t.getNext():void 0}class le{constructor(t){this.fields=t,t.sort(Y.comparator)}static empty(){return new le([])}unionWith(t){let e=new ue(Y.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new le(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return G(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}class de extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function fe(){return"undefined"!=typeof atob}class me{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(t){try{return atob(t)}catch(t){throw"undefined"!=typeof DOMException&&t instanceof DOMException?new de("Invalid base64 string: "+t):t}}(t);return new me(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new me(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return B(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}me.EMPTY_BYTE_STRING=new me("");const ge=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function pe(t){if(S(!!t),"string"==typeof t){let e=0;const n=ge.exec(t);if(S(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:ye(t.seconds),nanos:ye(t.nanos)}}function ye(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function we(t){return"string"==typeof t?me.fromBase64String(t):me.fromUint8Array(t)}function ve(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function be(t){const e=t.mapValue.fields.__previous_value__;return ve(e)?be(e):e}function _e(t){const e=pe(t.mapValue.fields.__local_write_time__.timestampValue);return new K(e.seconds,e.nanos)}class Ie{constructor(t,e,n,r,i,s,o,c,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=o,this.longPollingOptions=c,this.useFetchStreams=a}}class Ee{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new Ee("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Ee&&t.projectId===this.projectId&&t.database===this.database}}const Te={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Se={nullValue:"NULL_VALUE"};function xe(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?ve(t)?4:je(t)?9007199254740991:10:T()}function Ce(t,e){if(t===e)return!0;const n=xe(t);if(n!==xe(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return _e(t).isEqual(_e(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=pe(t.timestampValue),r=pe(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return we(t.bytesValue).isEqual(we(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return ye(t.geoPointValue.latitude)===ye(e.geoPointValue.latitude)&&ye(t.geoPointValue.longitude)===ye(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return ye(t.integerValue)===ye(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=ye(t.doubleValue),r=ye(e.doubleValue);return n===r?xt(n)===xt(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return G(t.arrayValue.values||[],e.arrayValue.values||[],Ce);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(ne(n)!==ne(r))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===r[t]||!Ce(n[t],r[t])))return!1;return!0}(t,e);default:return T()}}function De(t,e){return void 0!==(t.values||[]).find((t=>Ce(t,e)))}function Ae(t,e){if(t===e)return 0;const n=xe(t),r=xe(e);if(n!==r)return B(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return B(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=ye(t.integerValue||t.doubleValue),r=ye(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return Ne(t.timestampValue,e.timestampValue);case 4:return Ne(_e(t),_e(e));case 5:return B(t.stringValue,e.stringValue);case 6:return function(t,e){const n=we(t),r=we(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let t=0;t<n.length&&t<r.length;t++){const e=B(n[t],r[t]);if(0!==e)return e}return B(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=B(ye(t.latitude),ye(e.latitude));return 0!==n?n:B(ye(t.longitude),ye(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let t=0;t<n.length&&t<r.length;++t){const e=Ae(n[t],r[t]);if(e)return e}return B(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===Te.mapValue&&e===Te.mapValue)return 0;if(t===Te.mapValue)return 1;if(e===Te.mapValue)return-1;const n=t.fields||{},r=Object.keys(n),i=e.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let t=0;t<r.length&&t<s.length;++t){const e=B(r[t],s[t]);if(0!==e)return e;const o=Ae(n[r[t]],i[s[t]]);if(0!==o)return o}return B(r.length,s.length)}(t.mapValue,e.mapValue);default:throw T()}}function Ne(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return B(t,e);const n=pe(t),r=pe(e),i=B(n.seconds,r.seconds);return 0!==i?i:B(n.nanos,r.nanos)}function ke(t){return Oe(t)}function Oe(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=pe(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?function(t){return we(t).toBase64()}(t.bytesValue):"referenceValue"in t?function(t){return X.fromName(t).toString()}(t.referenceValue):"geoPointValue"in t?function(t){return`geo(${t.latitude},${t.longitude})`}(t.geoPointValue):"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=Oe(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const i of e)r?r=!1:n+=",",n+=`${i}:${Oe(t.fields[i])}`;return n+"}"}(t.mapValue):T()}function Re(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function Me(t){return!!t&&"integerValue"in t}function Pe(t){return!!t&&"arrayValue"in t}function Fe(t){return!!t&&"nullValue"in t}function Le(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Ve(t){return!!t&&"mapValue"in t}function qe(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return re(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=qe(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=qe(t.arrayValue.values[n]);return e}return Object.assign({},t)}function je(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function Ue(t){return"nullValue"in t?Se:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?Re(Ee.empty(),X.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:T()}function Be(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?Re(Ee.empty(),X.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?Te:T()}function Ge(t,e){const n=Ae(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function ze(t,e){const n=Ae(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class Ke{constructor(t){this.value=t}static empty(){return new Ke({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Ve(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=qe(e)}setAll(t){let e=Y.emptyPath(),n={},r=[];t.forEach(((t,i)=>{if(!e.isImmediateParentOf(i)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=i.popLast()}t?n[i.lastSegment()]=qe(t):r.push(i.lastSegment())}));const i=this.getFieldsMap(e);this.applyChanges(i,n,r)}delete(t){const e=this.field(t.popLast());Ve(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Ce(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];Ve(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){re(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new Ke(qe(this.value))}}function $e(t){const e=[];return re(t.fields,((t,n)=>{const r=new Y([t]);if(Ve(n)){const t=$e(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new le(e)}class Qe{constructor(t,e,n,r,i,s,o){this.key=t,this.documentType=e,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=o}static newInvalidDocument(t){return new Qe(t,0,$.min(),$.min(),$.min(),Ke.empty(),0)}static newFoundDocument(t,e,n,r){return new Qe(t,1,e,$.min(),n,r,0)}static newNoDocument(t,e){return new Qe(t,2,e,$.min(),$.min(),Ke.empty(),0)}static newUnknownDocument(t,e){return new Qe(t,3,e,$.min(),$.min(),Ke.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual($.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Ke.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Ke.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=$.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Qe&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Qe(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class We{constructor(t,e){this.position=t,this.inclusive=e}}function He(t,e,n){let r=0;for(let i=0;i<t.position.length;i++){const s=e[i],o=t.position[i];if(r=s.field.isKeyField()?X.comparator(X.fromName(o.referenceValue),n.key):Ae(o,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function Ye(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!Ce(t.position[n],e.position[n]))return!1;return!0}class Xe{constructor(t,e="asc"){this.field=t,this.dir=e}}function Je(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}class Ze{}class tn extends Ze{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.createKeyFieldInFilter(t,e,n):new ln(t,e,n):"array-contains"===e?new gn(t,n):"in"===e?new pn(t,n):"not-in"===e?new yn(t,n):"array-contains-any"===e?new wn(t,n):new tn(t,e,n)}static createKeyFieldInFilter(t,e,n){return"in"===e?new dn(t,n):new fn(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Ae(e,this.value)):null!==e&&xe(this.value)===xe(e)&&this.matchesComparison(Ae(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return T()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class en extends Ze{constructor(t,e){super(),this.filters=t,this.op=e,this.ue=null}static create(t,e){return new en(t,e)}matches(t){return nn(this)?void 0===this.filters.find((e=>!e.matches(t))):void 0!==this.filters.find((e=>e.matches(t)))}getFlattenedFilters(){return null!==this.ue||(this.ue=this.filters.reduce(((t,e)=>t.concat(e.getFlattenedFilters())),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function nn(t){return"and"===t.op}function rn(t){return"or"===t.op}function sn(t){return on(t)&&nn(t)}function on(t){for(const e of t.filters)if(e instanceof en)return!1;return!0}function an(t){if(t instanceof tn)return t.field.canonicalString()+t.op.toString()+ke(t.value);if(sn(t))return t.filters.map((t=>an(t))).join(",");{const e=t.filters.map((t=>an(t))).join(",");return`${t.op}(${e})`}}function un(t,e){return t instanceof tn?function(t,e){return e instanceof tn&&t.op===e.op&&t.field.isEqual(e.field)&&Ce(t.value,e.value)}(t,e):t instanceof en?function(t,e){return e instanceof en&&t.op===e.op&&t.filters.length===e.filters.length&&t.filters.reduce(((t,n,r)=>t&&un(n,e.filters[r])),!0)}(t,e):void T()}function cn(t,e){const n=t.filters.concat(e);return en.create(n,t.op)}function hn(t){return t instanceof tn?function(t){return`${t.field.canonicalString()} ${t.op} ${ke(t.value)}`}(t):t instanceof en?function(t){return t.op.toString()+" {"+t.getFilters().map(hn).join(" ,")+"}"}(t):"Filter"}class ln extends tn{constructor(t,e,n){super(t,e,n),this.key=X.fromName(n.referenceValue)}matches(t){const e=X.comparator(t.key,this.key);return this.matchesComparison(e)}}class dn extends tn{constructor(t,e){super(t,"in",e),this.keys=mn("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class fn extends tn{constructor(t,e){super(t,"not-in",e),this.keys=mn("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function mn(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>X.fromName(t.referenceValue)))}class gn extends tn{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Pe(e)&&De(e.arrayValue,this.value)}}class pn extends tn{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&De(this.value.arrayValue,e)}}class yn extends tn{constructor(t,e){super(t,"not-in",e)}matches(t){if(De(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!De(this.value.arrayValue,e)}}class wn extends tn{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Pe(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>De(this.value.arrayValue,t)))}}class vn{constructor(t,e=null,n=[],r=[],i=null,s=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=o,this.ce=null}}function bn(t,e=null,n=[],r=[],i=null,s=null,o=null){return new vn(t,e,n,r,i,s,o)}function _n(t){const e=C(t);if(null===e.ce){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>an(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),St(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>ke(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>ke(t))).join(",")),e.ce=t}return e.ce}function In(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!Je(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let n=0;n<t.filters.length;n++)if(!un(t.filters[n],e.filters[n]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Ye(t.startAt,e.startAt)&&Ye(t.endAt,e.endAt)}function En(t){return X.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function Tn(t,e){return t.filters.filter((t=>t instanceof tn&&t.field.isEqual(e)))}function Sn(t,e,n){let r=Se,i=!0;for(const n of Tn(t,e)){let t=Se,e=!0;switch(n.op){case"<":case"<=":t=Ue(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=Se}Ge({value:r,inclusive:i},{value:t,inclusive:e})<0&&(r=t,i=e)}if(null!==n)for(let s=0;s<t.orderBy.length;++s)if(t.orderBy[s].field.isEqual(e)){const t=n.position[s];Ge({value:r,inclusive:i},{value:t,inclusive:n.inclusive})<0&&(r=t,i=n.inclusive);break}return{value:r,inclusive:i}}function xn(t,e,n){let r=Te,i=!0;for(const n of Tn(t,e)){let t=Te,e=!0;switch(n.op){case">=":case">":t=Be(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=Te}ze({value:r,inclusive:i},{value:t,inclusive:e})>0&&(r=t,i=e)}if(null!==n)for(let s=0;s<t.orderBy.length;++s)if(t.orderBy[s].field.isEqual(e)){const t=n.position[s];ze({value:r,inclusive:i},{value:t,inclusive:n.inclusive})>0&&(r=t,i=n.inclusive);break}return{value:r,inclusive:i}}class Cn{constructor(t,e=null,n=[],r=[],i=null,s="F",o=null,c=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=o,this.endAt=c,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}}function Dn(t,e,n,r,i,s,o,c){return new Cn(t,e,n,r,i,s,o,c)}function An(t){return new Cn(t)}function Nn(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function kn(t){return null!==t.collectionGroup}function On(t){const e=C(t);if(null===e.le){e.le=[];const t=new Set;for(const n of e.explicitOrderBy)e.le.push(n),t.add(n.field.canonicalString());const n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc",r=function(t){let e=new ue(Y.comparator);return t.filters.forEach((t=>{t.getFlattenedFilters().forEach((t=>{t.isInequality()&&(e=e.add(t.field))}))})),e}(e);r.forEach((r=>{t.has(r.canonicalString())||r.isKeyField()||e.le.push(new Xe(r,n))})),t.has(Y.keyField().canonicalString())||e.le.push(new Xe(Y.keyField(),n))}return e.le}function Rn(t){const e=C(t);return e.he||(e.he=Mn(e,On(t))),e.he}function Mn(t,e){if("F"===t.limitType)return bn(t.path,t.collectionGroup,e,t.filters,t.limit,t.startAt,t.endAt);{e=e.map((t=>{const e="desc"===t.dir?"asc":"desc";return new Xe(t.field,e)}));const n=t.endAt?new We(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new We(t.startAt.position,t.startAt.inclusive):null;return bn(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}}function Pn(t,e){const n=t.filters.concat([e]);return new Cn(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}function Fn(t,e,n){return new Cn(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Ln(t,e){return In(Rn(t),Rn(e))&&t.limitType===e.limitType}function Vn(t){return`${_n(Rn(t))}|lt:${t.limitType}`}function qn(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>hn(t))).join(", ")}]`),St(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>ke(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>ke(t))).join(",")),`Target(${e})`}(Rn(t))}; limitType=${t.limitType})`}function jn(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):X.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of On(t))if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const r=He(t,e,n);return t.inclusive?r<=0:r<0}(t.startAt,On(t),e))&&!(t.endAt&&!function(t,e,n){const r=He(t,e,n);return t.inclusive?r>=0:r>0}(t.endAt,On(t),e))}(t,e)}function Un(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function Bn(t){return(e,n)=>{let r=!1;for(const i of On(t)){const t=Gn(i,e,n);if(0!==t)return t;r=r||i.field.isKeyField()}return 0}}function Gn(t,e,n){const r=t.field.isKeyField()?X.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),i=n.data.field(t);return null!==r&&null!==i?Ae(r,i):T()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return T()}}class zn{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(t){re(this.inner,((e,n)=>{for(const[e,r]of n)t(e,r)}))}isEmpty(){return se(this.inner)}size(){return this.innerSize}}const Kn=new ie(X.comparator);function $n(){return Kn}const Qn=new ie(X.comparator);function Wn(...t){let e=Qn;for(const n of t)e=e.insert(n.key,n);return e}function Hn(t){let e=Qn;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function Yn(){return Jn()}function Xn(){return Jn()}function Jn(){return new zn((t=>t.toString()),((t,e)=>t.isEqual(e)))}const Zn=new ie(X.comparator),er=new ue(X.comparator);function nr(...t){let e=er;for(const n of t)e=e.add(n);return e}const rr=new ue(B);function sr(){return rr}function ir(t,e){if(t.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:xt(e)?"-0":e}}function or(t){return{integerValue:""+t}}function ar(t,e){return Ct(e)?or(e):ir(t,e)}class ur{constructor(){this._=void 0}}function cr(t,e,n){return t instanceof fr?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&ve(e)&&(e=be(e)),e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof mr?gr(t,e):t instanceof pr?yr(t,e):function(t,e){const n=dr(t,e),r=vr(n)+vr(t.Ie);return Me(n)&&Me(t.Ie)?or(r):ir(t.serializer,r)}(t,e)}function lr(t,e,n){return t instanceof mr?gr(t,e):t instanceof pr?yr(t,e):n}function dr(t,e){return t instanceof wr?function(t){return Me(t)||function(t){return!!t&&"doubleValue"in t}(t)}(e)?e:{integerValue:0}:null}class fr extends ur{}class mr extends ur{constructor(t){super(),this.elements=t}}function gr(t,e){const n=_r(e);for(const e of t.elements)n.some((t=>Ce(t,e)))||n.push(e);return{arrayValue:{values:n}}}class pr extends ur{constructor(t){super(),this.elements=t}}function yr(t,e){let n=_r(e);for(const e of t.elements)n=n.filter((t=>!Ce(t,e)));return{arrayValue:{values:n}}}class wr extends ur{constructor(t,e){super(),this.serializer=t,this.Ie=e}}function vr(t){return ye(t.integerValue||t.doubleValue)}function _r(t){return Pe(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Ir{constructor(t,e){this.field=t,this.transform=e}}class Er{constructor(t,e){this.version=t,this.transformResults=e}}class Tr{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Tr}static exists(t){return new Tr(void 0,t)}static updateTime(t){return new Tr(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Sr(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class xr{}function Cr(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new Lr(t.key,Tr.none()):new Or(t.key,t.data,Tr.none());{const n=t.data,r=Ke.empty();let i=new ue(Y.comparator);for(let t of e.fields)if(!i.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?r.delete(t):r.set(t,e),i=i.add(t)}return new Rr(t.key,r,new le(i.toArray()),Tr.none())}}function Dr(t,e,n){t instanceof Or?function(t,e,n){const r=t.value.clone(),i=Pr(t.fieldTransforms,e,n.transformResults);r.setAll(i),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Rr?function(t,e,n){if(!Sr(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=Pr(t.fieldTransforms,e,n.transformResults),i=e.data;i.setAll(Mr(t)),i.setAll(r),e.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Ar(t,e,n,r){return t instanceof Or?function(t,e,n,r){if(!Sr(t.precondition,e))return n;const i=t.value.clone(),s=Fr(t.fieldTransforms,r,e);return i.setAll(s),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null}(t,e,n,r):t instanceof Rr?function(t,e,n,r){if(!Sr(t.precondition,e))return n;const i=Fr(t.fieldTransforms,r,e),s=e.data;return s.setAll(Mr(t)),s.setAll(i),e.convertToFoundDocument(e.version,s).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,r):function(t,e,n){return Sr(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function Nr(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),i=dr(r.transform,t||null);null!=i&&(null===n&&(n=Ke.empty()),n.set(r.field,i))}return n||null}function kr(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&G(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof mr&&e instanceof mr||t instanceof pr&&e instanceof pr?G(t.elements,e.elements,Ce):t instanceof wr&&e instanceof wr?Ce(t.Ie,e.Ie):t instanceof fr&&e instanceof fr}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class Or extends xr{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Rr extends xr{constructor(t,e,n,r,i=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function Mr(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function Pr(t,e,n){const r=new Map;S(t.length===n.length);for(let i=0;i<n.length;i++){const s=t[i],o=s.transform,c=e.data.field(s.field);r.set(s.field,lr(o,c,n[i]))}return r}function Fr(t,e,n){const r=new Map;for(const i of t){const t=i.transform,s=n.data.field(i.field);r.set(i.field,cr(t,s,e))}return r}class Lr extends xr{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Vr extends xr{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class qr{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const r=this.mutations[e];r.key.isEqual(t.key)&&Dr(r,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=Ar(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=Ar(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=Xn();return this.mutations.forEach((r=>{const i=t.get(r.key),s=i.overlayedDocument;let o=this.applyToLocalView(s,i.mutatedFields);o=e.has(r.key)?null:o;const c=Cr(s,o);null!==c&&n.set(r.key,c),s.isValidDocument()||s.convertToNoDocument($.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),nr())}isEqual(t){return this.batchId===t.batchId&&G(this.mutations,t.mutations,((t,e)=>kr(t,e)))&&G(this.baseMutations,t.baseMutations,((t,e)=>kr(t,e)))}}class jr{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){S(t.mutations.length===n.length);let r=Zn;const i=t.mutations;for(let t=0;t<i.length;t++)r=r.insert(i[t].key,n[t].version);return new jr(t,e,n,r)}}class Ur{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Br{constructor(t,e){this.count=t,this.unchangedNames=e}}var Gr,zr;function Kr(t){switch(t){default:return T();case D.CANCELLED:case D.UNKNOWN:case D.DEADLINE_EXCEEDED:case D.RESOURCE_EXHAUSTED:case D.INTERNAL:case D.UNAVAILABLE:case D.UNAUTHENTICATED:return!1;case D.INVALID_ARGUMENT:case D.NOT_FOUND:case D.ALREADY_EXISTS:case D.PERMISSION_DENIED:case D.FAILED_PRECONDITION:case D.ABORTED:case D.OUT_OF_RANGE:case D.UNIMPLEMENTED:case D.DATA_LOSS:return!0}}function $r(t){if(void 0===t)return _("GRPC error has no .code"),D.UNKNOWN;switch(t){case Gr.OK:return D.OK;case Gr.CANCELLED:return D.CANCELLED;case Gr.UNKNOWN:return D.UNKNOWN;case Gr.DEADLINE_EXCEEDED:return D.DEADLINE_EXCEEDED;case Gr.RESOURCE_EXHAUSTED:return D.RESOURCE_EXHAUSTED;case Gr.INTERNAL:return D.INTERNAL;case Gr.UNAVAILABLE:return D.UNAVAILABLE;case Gr.UNAUTHENTICATED:return D.UNAUTHENTICATED;case Gr.INVALID_ARGUMENT:return D.INVALID_ARGUMENT;case Gr.NOT_FOUND:return D.NOT_FOUND;case Gr.ALREADY_EXISTS:return D.ALREADY_EXISTS;case Gr.PERMISSION_DENIED:return D.PERMISSION_DENIED;case Gr.FAILED_PRECONDITION:return D.FAILED_PRECONDITION;case Gr.ABORTED:return D.ABORTED;case Gr.OUT_OF_RANGE:return D.OUT_OF_RANGE;case Gr.UNIMPLEMENTED:return D.UNIMPLEMENTED;case Gr.DATA_LOSS:return D.DATA_LOSS;default:return T()}}(zr=Gr||(Gr={}))[zr.OK=0]="OK",zr[zr.CANCELLED=1]="CANCELLED",zr[zr.UNKNOWN=2]="UNKNOWN",zr[zr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",zr[zr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",zr[zr.NOT_FOUND=5]="NOT_FOUND",zr[zr.ALREADY_EXISTS=6]="ALREADY_EXISTS",zr[zr.PERMISSION_DENIED=7]="PERMISSION_DENIED",zr[zr.UNAUTHENTICATED=16]="UNAUTHENTICATED",zr[zr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",zr[zr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",zr[zr.ABORTED=10]="ABORTED",zr[zr.OUT_OF_RANGE=11]="OUT_OF_RANGE",zr[zr.UNIMPLEMENTED=12]="UNIMPLEMENTED",zr[zr.INTERNAL=13]="INTERNAL",zr[zr.UNAVAILABLE=14]="UNAVAILABLE",zr[zr.DATA_LOSS=15]="DATA_LOSS";let Qr=null;function Wr(){return new TextEncoder}const Hr=new l.d([4294967295,4294967295],0);function Yr(t){const e=Wr().encode(t),n=new l.e;return n.update(e),new Uint8Array(n.digest())}function Xr(t){const e=new DataView(t.buffer),n=e.getUint32(0,!0),r=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new l.d([n,r],0),new l.d([i,s],0)]}class Jr{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new Zr(`Invalid padding: ${e}`);if(n<0)throw new Zr(`Invalid hash count: ${n}`);if(t.length>0&&0===this.hashCount)throw new Zr(`Invalid hash count: ${n}`);if(0===t.length&&0!==e)throw new Zr(`Invalid padding when bitmap length is 0: ${e}`);this.Te=8*t.length-e,this.Ee=l.d.fromNumber(this.Te)}de(t,e,n){let r=t.add(e.multiply(l.d.fromNumber(n)));return 1===r.compare(Hr)&&(r=new l.d([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Ee).toNumber()}Ae(t){return 0!=(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(0===this.Te)return!1;const e=Yr(t),[n,r]=Xr(e);for(let t=0;t<this.hashCount;t++){const e=this.de(n,r,t);if(!this.Ae(e))return!1}return!0}static create(t,e,n){const r=t%8==0?0:8-t%8,i=new Uint8Array(Math.ceil(t/8)),s=new Jr(i,r,e);return n.forEach((t=>s.insert(t))),s}insert(t){if(0===this.Te)return;const e=Yr(t),[n,r]=Xr(e);for(let t=0;t<this.hashCount;t++){const e=this.de(n,r,t);this.Re(e)}}Re(t){const e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}}class Zr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class ts{constructor(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(t,e,n){const r=new Map;return r.set(t,es.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new ts($.min(),r,new ie(B),$n(),nr())}}class es{constructor(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new es(n,e,nr(),nr(),nr())}}class ns{constructor(t,e,n,r){this.Ve=t,this.removedTargetIds=e,this.key=n,this.me=r}}class rs{constructor(t,e){this.targetId=t,this.fe=e}}class ss{constructor(t,e,n=me.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class is{constructor(){this.ge=0,this.pe=us(),this.ye=me.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(t){t.approximateByteSize()>0&&(this.Se=!0,this.ye=t)}ve(){let t=nr(),e=nr(),n=nr();return this.pe.forEach(((r,i)=>{switch(i){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:T()}})),new es(this.ye,this.we,t,e,n)}Fe(){this.Se=!1,this.pe=us()}Me(t,e){this.Se=!0,this.pe=this.pe.insert(t,e)}xe(t){this.Se=!0,this.pe=this.pe.remove(t)}Oe(){this.ge+=1}Ne(){this.ge-=1,S(this.ge>=0)}Le(){this.Se=!0,this.we=!0}}class os{constructor(t){this.Be=t,this.ke=new Map,this.qe=$n(),this.Qe=as(),this.Ke=new ie(B)}$e(t){for(const e of t.Ve)t.me&&t.me.isFoundDocument()?this.Ue(e,t.me):this.We(e,t.key,t.me);for(const e of t.removedTargetIds)this.We(e,t.key,t.me)}Ge(t){this.forEachTarget(t,(e=>{const n=this.ze(e);switch(t.state){case 0:this.je(e)&&n.Ce(t.resumeToken);break;case 1:n.Ne(),n.be||n.Fe(),n.Ce(t.resumeToken);break;case 2:n.Ne(),n.be||this.removeTarget(e);break;case 3:this.je(e)&&(n.Le(),n.Ce(t.resumeToken));break;case 4:this.je(e)&&(this.He(e),n.Ce(t.resumeToken));break;default:T()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.ke.forEach(((t,n)=>{this.je(n)&&e(n)}))}Je(t){const e=t.targetId,n=t.fe.count,r=this.Ye(e);if(r){const i=r.target;if(En(i))if(0===n){const t=new X(i.path);this.We(e,t,Qe.newNoDocument(t,$.min()))}else S(1===n);else{const r=this.Ze(e);if(r!==n){const n=this.Xe(t),i=n?this.et(n,t,r):1;if(0!==i){this.He(e);const t=2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(e,t)}null==Qr||Qr.tt(function(t,e,n,r,i){var s,o,c,a,u,h;const l={localCacheCount:t,existenceFilterCount:e.count,databaseId:n.database,projectId:n.projectId},d=e.unchangedNames;return d&&(l.bloomFilter={applied:0===i,hashCount:null!==(s=null==d?void 0:d.hashCount)&&void 0!==s?s:0,bitmapLength:null!==(a=null===(c=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===c?void 0:c.length)&&void 0!==a?a:0,padding:null!==(h=null===(u=null==d?void 0:d.bits)||void 0===u?void 0:u.padding)&&void 0!==h?h:0,mightContain:t=>{var e;return null!==(e=null==r?void 0:r.mightContain(t))&&void 0!==e&&e}}),l}(r,t.fe,this.Be.nt(),n,i))}}}}Xe(t){const e=t.fe.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:i=0}=e;let s,o;try{s=we(n).toUint8Array()}catch(t){if(t instanceof de)return I("Decoding the base64 bloom filter in existence filter failed ("+t.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw t}try{o=new Jr(s,r,i)}catch(t){return I(t instanceof Zr?"BloomFilter error: ":"Applying bloom filter failed: ",t),null}return 0===o.Te?null:o}et(t,e,n){return e.fe.count===n-this.rt(t,e.targetId)?0:2}rt(t,e){const n=this.Be.getRemoteKeysForTarget(e);let r=0;return n.forEach((n=>{const i=this.Be.nt(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;t.mightContain(s)||(this.We(e,n,null),r++)})),r}it(t){const e=new Map;this.ke.forEach(((n,r)=>{const i=this.Ye(r);if(i){if(n.current&&En(i.target)){const e=new X(i.target.path);null!==this.qe.get(e)||this.st(r,e)||this.We(r,e,Qe.newNoDocument(e,t))}n.De&&(e.set(r,n.ve()),n.Fe())}}));let n=nr();this.Qe.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.Ye(t);return!e||"TargetPurposeLimboResolution"===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))})),this.qe.forEach(((e,n)=>n.setReadTime(t)));const r=new ts(t,e,this.Ke,this.qe,n);return this.qe=$n(),this.Qe=as(),this.Ke=new ie(B),r}Ue(t,e){if(!this.je(t))return;const n=this.st(t,e.key)?2:0;this.ze(t).Me(e.key,n),this.qe=this.qe.insert(e.key,e),this.Qe=this.Qe.insert(e.key,this.ot(e.key).add(t))}We(t,e,n){if(!this.je(t))return;const r=this.ze(t);this.st(t,e)?r.Me(e,1):r.xe(e),this.Qe=this.Qe.insert(e,this.ot(e).delete(t)),n&&(this.qe=this.qe.insert(e,n))}removeTarget(t){this.ke.delete(t)}Ze(t){const e=this.ze(t).ve();return this.Be.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Oe(t){this.ze(t).Oe()}ze(t){let e=this.ke.get(t);return e||(e=new is,this.ke.set(t,e)),e}ot(t){let e=this.Qe.get(t);return e||(e=new ue(B),this.Qe=this.Qe.insert(t,e)),e}je(t){const e=null!==this.Ye(t);return e||v("WatchChangeAggregator","Detected inactive target",t),e}Ye(t){const e=this.ke.get(t);return e&&e.be?null:this.Be._t(t)}He(t){this.ke.set(t,new is),this.Be.getRemoteKeysForTarget(t).forEach((e=>{this.We(t,e,null)}))}st(t,e){return this.Be.getRemoteKeysForTarget(t).has(e)}}function as(){return new ie(X.comparator)}function us(){return new ie(X.comparator)}const cs={asc:"ASCENDING",desc:"DESCENDING"},hs={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ls={and:"AND",or:"OR"};class ds{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function fs(t,e){return t.useProto3Json||St(e)?e:{value:e}}function ms(t,e){return t.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function gs(t,e){return t.useProto3Json?e.toBase64():e.toUint8Array()}function ps(t,e){return ms(t,e.toTimestamp())}function ys(t){return S(!!t),$.fromTimestamp(function(t){const e=pe(t);return new K(e.seconds,e.nanos)}(t))}function ws(t,e){return vs(t,e).canonicalString()}function vs(t,e){const n=function(t){return new W(["projects",t.projectId,"databases",t.database])}(t).child("documents");return void 0===e?n:n.child(e)}function bs(t){const e=W.fromString(t);return S(Bs(e)),e}function _s(t,e){return ws(t.databaseId,e.path)}function Is(t,e){const n=bs(e);if(n.get(1)!==t.databaseId.projectId)throw new A(D.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new A(D.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new X(xs(n))}function Es(t,e){return ws(t.databaseId,e)}function Ts(t){const e=bs(t);return 4===e.length?W.emptyPath():xs(e)}function Ss(t){return new W(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function xs(t){return S(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Cs(t,e,n){return{name:_s(t,e),fields:n.value.mapValue.fields}}function Ds(t,e,n){const r=Is(t,e.name),i=ys(e.updateTime),s=e.createTime?ys(e.createTime):$.min(),o=new Ke({mapValue:{fields:e.fields}}),c=Qe.newFoundDocument(r,i,s,o);return n&&c.setHasCommittedMutations(),n?c.setHasCommittedMutations():c}function As(t,e){let n;if(e instanceof Or)n={update:Cs(t,e.key,e.value)};else if(e instanceof Lr)n={delete:_s(t,e.key)};else if(e instanceof Rr)n={update:Cs(t,e.key,e.data),updateMask:Us(e.fieldMask)};else{if(!(e instanceof Vr))return T();n={verify:_s(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof fr)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof mr)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof pr)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof wr)return{fieldPath:e.field.canonicalString(),increment:n.Ie};throw T()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:ps(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:T()}(t,e.precondition)),n}function Ns(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Tr.updateTime(ys(t.updateTime)):void 0!==t.exists?Tr.exists(t.exists):Tr.none()}(e.currentDocument):Tr.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)S("REQUEST_TIME"===e.setToServerValue),n=new fr;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new mr(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new pr(t)}else"increment"in e?n=new wr(t,e.increment):T();const r=Y.fromServerFormat(e.fieldPath);return new Ir(r,n)}(t,e))):[];if(e.update){e.update.name;const i=Is(t,e.update.name),s=new Ke({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new le(e.map((t=>Y.fromServerFormat(t))))}(e.updateMask);return new Rr(i,s,t,n,r)}return new Or(i,s,n,r)}if(e.delete){const r=Is(t,e.delete);return new Lr(r,n)}if(e.verify){const r=Is(t,e.verify);return new Vr(r,n)}return T()}function ks(t,e){return{documents:[Es(t,e.path)]}}function Os(t,e){const n={structuredQuery:{}},r=e.path;let i;null!==e.collectionGroup?(i=r,n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=Es(t,i);const s=function(t){if(0!==t.length)return js(en.create(t,"and"))}(e.filters);s&&(n.structuredQuery.where=s);const o=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Vs(t.field),direction:Ps(t.dir)}}(t)))}(e.orderBy);o&&(n.structuredQuery.orderBy=o);const c=fs(t,e.limit);return null!==c&&(n.structuredQuery.limit=c),e.startAt&&(n.structuredQuery.startAt=function(t){return{before:t.inclusive,values:t.position}}(e.startAt)),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),{ut:n,parent:i}}function Rs(t){let e=Ts(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let i=null;if(r>0){S(1===r);const t=n.from[0];t.allDescendants?i=t.collectionId:e=e.child(t.collectionId)}let s=[];n.where&&(s=function(t){const e=Ms(t);return e instanceof en&&sn(e)?e.getFilters():[e]}(n.where));let o=[];n.orderBy&&(o=function(t){return t.map((t=>function(t){return new Xe(qs(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t)))}(n.orderBy));let c=null;n.limit&&(c=function(t){let e;return e="object"==typeof t?t.value:t,St(e)?null:e}(n.limit));let a=null;n.startAt&&(a=function(t){const e=!!t.before,n=t.values||[];return new We(n,e)}(n.startAt));let u=null;return n.endAt&&(u=function(t){const e=!t.before,n=t.values||[];return new We(n,e)}(n.endAt)),Dn(e,i,o,s,c,"F",a,u)}function Ms(t){return void 0!==t.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const e=qs(t.unaryFilter.field);return tn.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=qs(t.unaryFilter.field);return tn.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=qs(t.unaryFilter.field);return tn.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=qs(t.unaryFilter.field);return tn.create(i,"!=",{nullValue:"NULL_VALUE"});default:return T()}}(t):void 0!==t.fieldFilter?function(t){return tn.create(qs(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return T()}}(t.fieldFilter.op),t.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return en.create(t.compositeFilter.filters.map((t=>Ms(t))),function(t){switch(t){case"AND":return"and";case"OR":return"or";default:return T()}}(t.compositeFilter.op))}(t):T()}function Ps(t){return cs[t]}function Fs(t){return hs[t]}function Ls(t){return ls[t]}function Vs(t){return{fieldPath:t.canonicalString()}}function qs(t){return Y.fromServerFormat(t.fieldPath)}function js(t){return t instanceof tn?function(t){if("=="===t.op){if(Le(t.value))return{unaryFilter:{field:Vs(t.field),op:"IS_NAN"}};if(Fe(t.value))return{unaryFilter:{field:Vs(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Le(t.value))return{unaryFilter:{field:Vs(t.field),op:"IS_NOT_NAN"}};if(Fe(t.value))return{unaryFilter:{field:Vs(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Vs(t.field),op:Fs(t.op),value:t.value}}}(t):t instanceof en?function(t){const e=t.getFilters().map((t=>js(t)));return 1===e.length?e[0]:{compositeFilter:{op:Ls(t.op),filters:e}}}(t):T()}function Us(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Bs(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}class Gs{constructor(t,e,n,r,i=$.min(),s=$.min(),o=me.EMPTY_BYTE_STRING,c=null){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=o,this.expectedCount=c}withSequenceNumber(t){return new Gs(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new Gs(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new Gs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new Gs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}class zs{constructor(t){this.ct=t}}function Ks(t,e){const n=e.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:$s(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(t,e){return{name:_s(t,e.key),fields:e.data.value.mapValue.fields,updateTime:ms(t,e.version.toTimestamp()),createTime:ms(t,e.createTime.toTimestamp())}}(t.ct,e);else if(e.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Qs(e.version)};else{if(!e.isUnknownDocument())return T();r.unknownDocument={path:n.path.toArray(),version:Qs(e.version)}}return r}function $s(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Qs(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Ws(t){const e=new K(t.seconds,t.nanoseconds);return $.fromTimestamp(e)}function Hs(t,e){const n=(e.baseMutations||[]).map((e=>Ns(t.ct,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const r=e.mutations[t+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const r=e.mutations.map((e=>Ns(t.ct,e))),i=K.fromMillis(e.localWriteTimeMs);return new qr(e.batchId,i,n,r)}function Ys(t){const e=Ws(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Ws(t.lastLimboFreeSnapshotVersion):$.min();let r;return r=function(t){return void 0!==t.documents}(t.query)?function(t){return S(1===t.documents.length),Rn(An(Ts(t.documents[0])))}(t.query):function(t){return Rn(Rs(t))}(t.query),new Gs(r,t.targetId,"TargetPurposeListen",t.lastListenSequenceNumber,e,n,me.fromBase64String(t.resumeToken))}function Xs(t,e){const n=Qs(e.snapshotVersion),r=Qs(e.lastLimboFreeSnapshotVersion);let i;i=En(e.target)?ks(t.ct,e.target):Os(t.ct,e.target).ut;const s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:_n(e.target),readTime:n,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Js(t){const e=Rs({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Fn(e,e.limit,"L"):e}function Zs(t,e){return new Ur(e.largestBatchId,Ns(t.ct,e.overlayMutation))}function ti(t,e){const n=e.path.lastSegment();return[t,Dt(e.path.popLast()),n]}function ei(t,e,n,r){return{indexId:t,uid:e,sequenceNumber:n,readTime:Qs(r.readTime),documentKey:Dt(r.documentKey.path),largestBatchId:r.largestBatchId}}class ni{getBundleMetadata(t,e){return ri(t).get(e).next((t=>{if(t)return function(t){return{id:t.bundleId,createTime:Ws(t.createTime),version:t.version}}(t)}))}saveBundleMetadata(t,e){return ri(t).put(function(t){return{bundleId:t.id,createTime:Qs(ys(t.createTime)),version:t.version}}(e))}getNamedQuery(t,e){return si(t).get(e).next((t=>{if(t)return function(t){return{name:t.name,query:Js(t.bundledQuery),readTime:Ws(t.readTime)}}(t)}))}saveNamedQuery(t,e){return si(t).put(function(t){return{name:t.name,readTime:Qs(ys(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function ri(t){return ee(t,"bundles")}function si(t){return ee(t,"namedQueries")}class ii{constructor(t,e){this.serializer=t,this.userId=e}static lt(t,e){const n=e.uid||"";return new ii(t,n)}getOverlay(t,e){return oi(t).get(ti(this.userId,e)).next((t=>t?Zs(this.serializer,t):null))}getOverlays(t,e){const n=Yn();return lt.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const r=[];return n.forEach(((n,i)=>{const s=new Ur(e,i);r.push(this.ht(t,s))})),lt.waitFor(r)}removeOverlaysForBatchId(t,e,n){const r=new Set;e.forEach((t=>r.add(Dt(t.getCollectionPath()))));const i=[];return r.forEach((e=>{const r=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);i.push(oi(t).H("collectionPathOverlayIndex",r))})),lt.waitFor(i)}getOverlaysForCollection(t,e,n){const r=Yn(),i=Dt(e),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return oi(t).W("collectionPathOverlayIndex",s).next((t=>{for(const e of t){const t=Zs(this.serializer,e);r.set(t.getKey(),t)}return r}))}getOverlaysForCollectionGroup(t,e,n,r){const i=Yn();let s;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return oi(t).Y({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=Zs(this.serializer,e);i.size()<r||o.largestBatchId===s?(i.set(o.getKey(),o),s=o.largestBatchId):n.done()})).next((()=>i))}ht(t,e){return oi(t).put(function(t,e,n){const[r,i,s]=ti(e,n.mutation.key);return{userId:e,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:As(t.ct,n.mutation)}}(this.serializer,this.userId,e))}}function oi(t){return ee(t,"documentOverlays")}class ai{constructor(){}Pt(t,e){this.It(t,e),e.Tt()}It(t,e){if("nullValue"in t)this.Et(e,5);else if("booleanValue"in t)this.Et(e,10),e.dt(t.booleanValue?1:0);else if("integerValue"in t)this.Et(e,15),e.dt(ye(t.integerValue));else if("doubleValue"in t){const n=ye(t.doubleValue);isNaN(n)?this.Et(e,13):(this.Et(e,15),xt(n)?e.dt(0):e.dt(n))}else if("timestampValue"in t){const n=t.timestampValue;this.Et(e,20),"string"==typeof n?e.At(n):(e.At(`${n.seconds||""}`),e.dt(n.nanos||0))}else if("stringValue"in t)this.Rt(t.stringValue,e),this.Vt(e);else if("bytesValue"in t)this.Et(e,30),e.ft(we(t.bytesValue)),this.Vt(e);else if("referenceValue"in t)this.gt(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.Et(e,45),e.dt(n.latitude||0),e.dt(n.longitude||0)}else"mapValue"in t?je(t)?this.Et(e,Number.MAX_SAFE_INTEGER):(this.yt(t.mapValue,e),this.Vt(e)):"arrayValue"in t?(this.wt(t.arrayValue,e),this.Vt(e)):T()}Rt(t,e){this.Et(e,25),this.St(t,e)}St(t,e){e.At(t)}yt(t,e){const n=t.fields||{};this.Et(e,55);for(const t of Object.keys(n))this.Rt(t,e),this.It(n[t],e)}wt(t,e){const n=t.values||[];this.Et(e,50);for(const t of n)this.It(t,e)}gt(t,e){this.Et(e,37),X.fromName(t).path.forEach((t=>{this.Et(e,60),this.St(t,e)}))}Et(t,e){t.dt(e)}Vt(t){t.dt(2)}}function ui(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function ci(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const r=ui(255&t[n]);if(e+=r,8!==r)break}return e}(t);return Math.ceil(e/8)}ai.bt=new ai;class hi{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ct(n.value),n=e.next();this.vt()}Ft(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Mt(n.value),n=e.next();this.xt()}Ot(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ct(t);else if(t<2048)this.Ct(960|t>>>6),this.Ct(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ct(480|t>>>12),this.Ct(128|63&t>>>6),this.Ct(128|63&t);else{const t=e.codePointAt(0);this.Ct(240|t>>>18),this.Ct(128|63&t>>>12),this.Ct(128|63&t>>>6),this.Ct(128|63&t)}}this.vt()}Nt(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Mt(t);else if(t<2048)this.Mt(960|t>>>6),this.Mt(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Mt(480|t>>>12),this.Mt(128|63&t>>>6),this.Mt(128|63&t);else{const t=e.codePointAt(0);this.Mt(240|t>>>18),this.Mt(128|63&t>>>12),this.Mt(128|63&t>>>6),this.Mt(128|63&t)}}this.xt()}Lt(t){const e=this.Bt(t),n=ci(e);this.kt(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}qt(t){const e=this.Bt(t),n=ci(e);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(t){this.kt(t.length),this.buffer.set(t,this.position),this.position+=t.length}Wt(){return this.buffer.slice(0,this.position)}Bt(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ct(t){const e=255&t;0===e?(this.Kt(0),this.Kt(255)):255===e?(this.Kt(255),this.Kt(0)):this.Kt(e)}Mt(t){const e=255&t;0===e?(this.Ut(0),this.Ut(255)):255===e?(this.Ut(255),this.Ut(0)):this.Ut(t)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(t){this.kt(1),this.buffer[this.position++]=t}Ut(t){this.kt(1),this.buffer[this.position++]=~t}kt(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class di{constructor(t){this.Gt=t}ft(t){this.Gt.Dt(t)}At(t){this.Gt.Ot(t)}dt(t){this.Gt.Lt(t)}Tt(){this.Gt.Qt()}}class fi{constructor(t){this.Gt=t}ft(t){this.Gt.Ft(t)}At(t){this.Gt.Nt(t)}dt(t){this.Gt.qt(t)}Tt(){this.Gt.$t()}}class mi{constructor(){this.Gt=new hi,this.zt=new di(this.Gt),this.jt=new fi(this.Gt)}seed(t){this.Gt.seed(t)}Ht(t){return 0===t?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class gi{constructor(t,e,n,r){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=r}Jt(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new gi(this.indexId,this.documentKey,this.arrayValue,n)}}function pi(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=yi(t.arrayValue,e.arrayValue),0!==n?n:(n=yi(t.directionalValue,e.directionalValue),0!==n?n:X.comparator(t.documentKey,e.documentKey)))}function yi(t,e){for(let n=0;n<t.length&&n<e.length;++n){const r=t[n]-e[n];if(0!==r)return r}return t.length-e.length}class wi{constructor(t){this.Yt=new ue(((t,e)=>Y.comparator(t.field,e.field))),this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Zt=t.orderBy,this.Xt=[];for(const e of t.filters){const t=e;t.isInequality()?this.Yt=this.Yt.add(t):this.Xt.push(t)}}get en(){return this.Yt.size>1}tn(t){if(S(t.collectionGroup===this.collectionId),this.en)return!1;const e=Z(t);if(void 0!==e&&!this.nn(e))return!1;const n=tt(t);let r=new Set,i=0,s=0;for(;i<n.length&&this.nn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.Yt.size>0){const t=this.Yt.getIterator().getNext();if(!r.has(t.field.canonicalString())){const e=n[i];if(!this.rn(t,e)||!this.sn(this.Zt[s++],e))return!1}++i}for(;i<n.length;++i){const t=n[i];if(s>=this.Zt.length||!this.sn(this.Zt[s++],t))return!1}return!0}on(){if(this.en)return null;let t=new ue(Y.comparator);const e=[];for(const n of this.Xt)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)e.push(new et(n.field,2));else{if(t.has(n.field))continue;t=t.add(n.field),e.push(new et(n.field,0))}for(const n of this.Zt)n.field.isKeyField()||t.has(n.field)||(t=t.add(n.field),e.push(new et(n.field,"asc"===n.dir?0:1)));return new J(J.UNKNOWN_ID,this.collectionId,e,nt.empty())}nn(t){for(const e of this.Xt)if(this.rn(e,t))return!0;return!1}rn(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}sn(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}function vi(t){var e,n;if(S(t instanceof tn||t instanceof en),t instanceof tn){if(t instanceof pn){const r=(null===(n=null===(e=t.value.arrayValue)||void 0===e?void 0:e.values)||void 0===n?void 0:n.map((e=>tn.create(t.field,"==",e))))||[];return en.create(r,"or")}return t}const r=t.filters.map((t=>vi(t)));return en.create(r,t.op)}function bi(t){if(0===t.getFilters().length)return[];const e=Ti(vi(t));return S(Ei(e)),_i(e)||Ii(e)?[e]:e.getFilters()}function _i(t){return t instanceof tn}function Ii(t){return t instanceof en&&sn(t)}function Ei(t){return _i(t)||Ii(t)||function(t){if(t instanceof en&&rn(t)){for(const e of t.getFilters())if(!_i(e)&&!Ii(e))return!1;return!0}return!1}(t)}function Ti(t){if(S(t instanceof tn||t instanceof en),t instanceof tn)return t;if(1===t.filters.length)return Ti(t.filters[0]);const e=t.filters.map((t=>Ti(t)));let n=en.create(e,t.op);return n=Ci(n),Ei(n)?n:(S(n instanceof en),S(nn(n)),S(n.filters.length>1),n.filters.reduce(((t,e)=>Si(t,e))))}function Si(t,e){let n;return S(t instanceof tn||t instanceof en),S(e instanceof tn||e instanceof en),n=t instanceof tn?e instanceof tn?function(t,e){return en.create([t,e],"and")}(t,e):xi(t,e):e instanceof tn?xi(e,t):function(t,e){if(S(t.filters.length>0&&e.filters.length>0),nn(t)&&nn(e))return cn(t,e.getFilters());const n=rn(t)?t:e,r=rn(t)?e:t,i=n.filters.map((t=>Si(t,r)));return en.create(i,"or")}(t,e),Ci(n)}function xi(t,e){if(nn(e))return cn(e,t.getFilters());{const n=e.filters.map((e=>Si(t,e)));return en.create(n,"or")}}function Ci(t){if(S(t instanceof tn||t instanceof en),t instanceof tn)return t;const e=t.getFilters();if(1===e.length)return Ci(e[0]);if(on(t))return t;const n=e.map((t=>Ci(t))),r=[];return n.forEach((e=>{e instanceof tn?r.push(e):e instanceof en&&(e.op===t.op?r.push(...e.filters):r.push(e))})),1===r.length?r[0]:en.create(r,t.op)}class Di{constructor(){this._n=new Ai}addToCollectionParentIndex(t,e){return this._n.add(e),lt.resolve()}getCollectionParents(t,e){return lt.resolve(this._n.getEntries(e))}addFieldIndex(t,e){return lt.resolve()}deleteFieldIndex(t,e){return lt.resolve()}deleteAllFieldIndexes(t){return lt.resolve()}createTargetIndexes(t,e){return lt.resolve()}getDocumentsMatchingTarget(t,e){return lt.resolve(null)}getIndexType(t,e){return lt.resolve(0)}getFieldIndexes(t,e){return lt.resolve([])}getNextCollectionGroupToUpdate(t){return lt.resolve(null)}getMinOffset(t,e){return lt.resolve(ot.min())}getMinOffsetFromCollectionGroup(t,e){return lt.resolve(ot.min())}updateCollectionGroup(t,e,n){return lt.resolve()}updateIndexEntries(t,e){return lt.resolve()}}class Ai{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new ue(W.comparator),i=!r.has(n);return this.index[e]=r.add(n),i}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new ue(W.comparator)).toArray()}}const Ni=new Uint8Array(0);class ki{constructor(t,e){this.databaseId=e,this.an=new Ai,this.un=new zn((t=>_n(t)),((t,e)=>In(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.an.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.an.add(e)}));const i={collectionId:n,parent:Dt(r)};return Oi(t).put(i)}return lt.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[z(e),""],!1,!0);return Oi(t).W(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push(kt(r.parent))}return n}))}addFieldIndex(t,e){const n=Mi(t),r=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete r.indexId;const i=n.add(r);if(e.indexState){const n=Pi(t);return i.next((t=>{n.put(ei(t,this.uid,e.indexState.sequenceNumber,e.indexState.offset))}))}return i.next()}deleteFieldIndex(t,e){const n=Mi(t),r=Pi(t),i=Ri(t);return n.delete(e.indexId).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>i.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}deleteAllFieldIndexes(t){const e=Mi(t),n=Ri(t),r=Pi(t);return e.H().next((()=>n.H())).next((()=>r.H()))}createTargetIndexes(t,e){return lt.forEach(this.cn(e),(e=>this.getIndexType(t,e).next((n=>{if(0===n||1===n){const n=new wi(e).on();if(null!=n)return this.addFieldIndex(t,n)}}))))}getDocumentsMatchingTarget(t,e){const n=Ri(t);let r=!0;const i=new Map;return lt.forEach(this.cn(e),(e=>this.ln(t,e).next((t=>{r&&(r=!!t),i.set(e,t)})))).next((()=>{if(r){let t=nr();const r=[];return lt.forEach(i,((i,s)=>{v("IndexedDbIndexManager",`Using index ${function(t){return`id=${t.indexId}|cg=${t.collectionGroup}|f=${t.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`}(i)} to execute ${_n(e)}`);const o=function(t,e){const n=Z(e);if(void 0===n)return null;for(const e of Tn(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(s,i),c=function(t,e){const n=new Map;for(const r of tt(e))for(const e of Tn(t,r.fieldPath))switch(e.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(s,i),a=function(t,e){const n=[];let r=!0;for(const i of tt(e)){const e=0===i.kind?Sn(t,i.fieldPath,t.startAt):xn(t,i.fieldPath,t.startAt);n.push(e.value),r&&(r=e.inclusive)}return new We(n,r)}(s,i),u=function(t,e){const n=[];let r=!0;for(const i of tt(e)){const e=0===i.kind?xn(t,i.fieldPath,t.endAt):Sn(t,i.fieldPath,t.endAt);n.push(e.value),r&&(r=e.inclusive)}return new We(n,r)}(s,i),h=this.hn(i,s,a),l=this.hn(i,s,u),d=this.Pn(i,s,c),f=this.In(i.indexId,o,h,a.inclusive,l,u.inclusive,d);return lt.forEach(f,(i=>n.j(i,e.limit).next((e=>{e.forEach((e=>{const n=X.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),r.push(n))}))}))))})).next((()=>r))}return lt.resolve(null)}))}cn(t){let e=this.un.get(t);return e||(e=0===t.filters.length?[t]:bi(en.create(t.filters,"and")).map((e=>bn(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt))),this.un.set(t,e),e)}In(t,e,n,r,i,s,o){const c=(null!=e?e.length:1)*Math.max(n.length,i.length),a=c/(null!=e?e.length:1),u=[];for(let h=0;h<c;++h){const c=e?this.Tn(e[h/a]):Ni,l=this.En(t,c,n[h%a],r),d=this.dn(t,c,i[h%a],s),f=o.map((e=>this.En(t,c,e,!0)));u.push(...this.createRange(l,d,f))}return u}En(t,e,n,r){const i=new gi(t,X.empty(),e,n);return r?i:i.Jt()}dn(t,e,n,r){const i=new gi(t,X.empty(),e,n);return r?i.Jt():i}ln(t,e){const n=new wi(e),r=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,r).next((t=>{let e=null;for(const r of t)n.tn(r)&&(!e||r.fields.length>e.fields.length)&&(e=r);return e}))}getIndexType(t,e){let n=2;const r=this.cn(e);return lt.forEach(r,(e=>this.ln(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new ue(Y.comparator),n=!1;for(const r of t.filters)for(const t of r.getFlattenedFilters())t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field));for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>function(t){return null!==t.limit}(e)&&r.length>1&&2===n?1:n))}An(t,e){const n=new mi;for(const r of tt(t)){const t=e.data.field(r.fieldPath);if(null==t)return null;const i=n.Ht(r.kind);ai.bt.Pt(t,i)}return n.Wt()}Tn(t){const e=new mi;return ai.bt.Pt(t,e.Ht(0)),e.Wt()}Rn(t,e){const n=new mi;return ai.bt.Pt(Re(this.databaseId,e),n.Ht(function(t){const e=tt(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Wt()}Pn(t,e,n){if(null===n)return[];let r=[];r.push(new mi);let i=0;for(const s of tt(t)){const t=n[i++];for(const n of r)if(this.Vn(e,s.fieldPath)&&Pe(t))r=this.mn(r,s,t);else{const e=n.Ht(s.kind);ai.bt.Pt(t,e)}}return this.fn(r)}hn(t,e,n){return this.Pn(t,e,n.position)}fn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Wt();return e}mn(t,e,n){const r=[...t],i=[];for(const t of n.arrayValue.values||[])for(const n of r){const r=new mi;r.seed(n.Wt()),ai.bt.Pt(t,r.Ht(e.kind)),i.push(r)}return i}Vn(t,e){return!!t.filters.find((t=>t instanceof tn&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=Mi(t),r=Pi(t);return(e?n.W("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.W()).next((t=>{const e=[];return lt.forEach(t,(t=>r.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new nt(e.sequenceNumber,new ot(Ws(e.readTime),new X(kt(e.documentKey)),e.largestBatchId)):nt.empty(),r=t.fields.map((([t,e])=>new et(Y.fromServerFormat(t),e)));return new J(t.indexId,t.collectionGroup,r,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:B(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const r=Mi(t),i=Pi(t);return this.gn(t).next((t=>r.W("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>lt.forEach(e,(e=>i.put(ei(e.indexId,this.uid,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return lt.forEach(e,((e,r)=>{const i=n.get(e.collectionGroup);return(i?lt.resolve(i):this.getFieldIndexes(t,e.collectionGroup)).next((i=>(n.set(e.collectionGroup,i),lt.forEach(i,(n=>this.pn(t,e,n).next((e=>{const i=this.yn(r,n);return e.isEqual(i)?lt.resolve():this.wn(t,r,n,e,i)})))))))}))}Sn(t,e,n,r){return Ri(t).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Rn(n,e.key),documentKey:e.key.path.toArray()})}bn(t,e,n,r){return Ri(t).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Rn(n,e.key),e.key.path.toArray()])}pn(t,e,n){const r=Ri(t);let i=new ue(pi);return r.Y({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.Rn(n,e)])},((t,r)=>{i=i.add(new gi(n.indexId,e,r.arrayValue,r.directionalValue))})).next((()=>i))}yn(t,e){let n=new ue(pi);const r=this.An(e,t);if(null==r)return n;const i=Z(e);if(null!=i){const s=t.data.field(i.fieldPath);if(Pe(s))for(const i of s.arrayValue.values||[])n=n.add(new gi(e.indexId,t.key,this.Tn(i),r))}else n=n.add(new gi(e.indexId,t.key,Ni,r));return n}wn(t,e,n,r,i){v("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const s=[];return function(t,e,n,r,i){const s=t.getIterator(),o=e.getIterator();let c=he(s),a=he(o);for(;c||a;){let t=!1,e=!1;if(c&&a){const r=n(c,a);r<0?e=!0:r>0&&(t=!0)}else null!=c?e=!0:t=!0;t?(r(a),a=he(o)):e?(i(c),c=he(s)):(c=he(s),a=he(o))}}(r,i,pi,(r=>{s.push(this.Sn(t,e,n,r))}),(r=>{s.push(this.bn(t,e,n,r))})),lt.waitFor(s)}gn(t){let e=1;return Pi(t).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,r)=>{r.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>pi(t,e))).filter(((t,e,n)=>!e||0!==pi(t,n[e-1])));const r=[];r.push(t);for(const i of n){const n=pi(i,t),s=pi(i,e);if(0===n)r[0]=t.Jt();else if(n>0&&s<0)r.push(i),r.push(i.Jt());else if(s>0)break}r.push(e);const i=[];for(let t=0;t<r.length;t+=2){if(this.Dn(r[t],r[t+1]))return[];const e=[r[t].indexId,this.uid,r[t].arrayValue,r[t].directionalValue,Ni,[]],n=[r[t+1].indexId,this.uid,r[t+1].arrayValue,r[t+1].directionalValue,Ni,[]];i.push(IDBKeyRange.bound(e,n))}return i}Dn(t,e){return pi(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(Fi)}getMinOffset(t,e){return lt.mapArray(this.cn(e),(e=>this.ln(t,e).next((t=>t||T())))).next(Fi)}}function Oi(t){return ee(t,"collectionParents")}function Ri(t){return ee(t,"indexEntries")}function Mi(t){return ee(t,"indexConfiguration")}function Pi(t){return ee(t,"indexState")}function Fi(t){S(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let r=1;r<t.length;r++){const i=t[r].indexState.offset;at(i,e)<0&&(e=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new ot(e.readTime,e.documentKey,n)}const Li={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Vi{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Vi(t,Vi.DEFAULT_COLLECTION_PERCENTILE,Vi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function qi(t,e,n){const r=t.store("mutations"),i=t.store("documentMutations"),s=[],o=IDBKeyRange.only(n.batchId);let c=0;const a=r.Y({range:o},((t,e,n)=>(c++,n.delete())));s.push(a.next((()=>{S(1===c)})));const u=[];for(const t of n.mutations){const r=Mt(e,t.key.path,n.batchId);s.push(i.delete(r)),u.push(t.key)}return lt.waitFor(s).next((()=>u))}function ji(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw T();e=t.noDocument}return JSON.stringify(e).length}Vi.DEFAULT_COLLECTION_PERCENTILE=10,Vi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Vi.DEFAULT=new Vi(41943040,Vi.DEFAULT_COLLECTION_PERCENTILE,Vi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Vi.DISABLED=new Vi(-1,0,0);class Ui{constructor(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.Cn={}}static lt(t,e,n,r){S(""!==t.uid);const i=t.isAuthenticated()?t.uid:"";return new Ui(i,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Gi(t).Y({index:"userMutationsIndex",range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const i=zi(t),s=Gi(t);return s.add({}).next((o=>{S("number"==typeof o);const c=new qr(o,e,n,r),a=function(t,e,n){const r=n.baseMutations.map((e=>As(t.ct,e))),i=n.mutations.map((e=>As(t.ct,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,c),u=[];let h=new ue(((t,e)=>B(t.canonicalString(),e.canonicalString())));for(const t of r){const e=Mt(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),u.push(s.put(a)),u.push(i.put(e,Pt))}return h.forEach((e=>{u.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Cn[o]=c.keys()})),lt.waitFor(u).next((()=>c))}))}lookupMutationBatch(t,e){return Gi(t).get(e).next((t=>t?(S(t.userId===this.userId),Hs(this.serializer,t)):null))}vn(t,e){return this.Cn[e]?lt.resolve(this.Cn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Cn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let i=null;return Gi(t).Y({index:"userMutationsIndex",range:r},((t,e,r)=>{e.userId===this.userId&&(S(e.batchId>=n),i=Hs(this.serializer,e)),r.done()})).next((()=>i))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Gi(t).Y({index:"userMutationsIndex",range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Gi(t).W("userMutationsIndex",e).next((t=>t.map((t=>Hs(this.serializer,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=Rt(this.userId,e.path),r=IDBKeyRange.lowerBound(n),i=[];return zi(t).Y({range:r},((n,r,s)=>{const[o,c,a]=n,u=kt(c);if(o===this.userId&&e.path.isEqual(u))return Gi(t).get(a).next((t=>{if(!t)throw T();S(t.userId===this.userId),i.push(Hs(this.serializer,t))}));s.done()})).next((()=>i))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new ue(B);const r=[];return e.forEach((e=>{const i=Rt(this.userId,e.path),s=IDBKeyRange.lowerBound(i),o=zi(t).Y({range:s},((t,r,i)=>{const[s,o,c]=t,a=kt(o);s===this.userId&&e.path.isEqual(a)?n=n.add(c):i.done()}));r.push(o)})),lt.waitFor(r).next((()=>this.Fn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,i=Rt(this.userId,n),s=IDBKeyRange.lowerBound(i);let o=new ue(B);return zi(t).Y({range:s},((t,e,i)=>{const[s,c,a]=t,u=kt(c);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(a)):i.done()})).next((()=>this.Fn(t,o)))}Fn(t,e){const n=[],r=[];return e.forEach((e=>{r.push(Gi(t).get(e).next((t=>{if(null===t)throw T();S(t.userId===this.userId),n.push(Hs(this.serializer,t))})))})),lt.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return qi(t.ae,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.Mn(e.batchId)})),lt.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}Mn(t){delete this.Cn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return lt.resolve();const n=IDBKeyRange.lowerBound(function(t){return[t]}(this.userId)),r=[];return zi(t).Y({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=kt(t[1]);r.push(e)}else n.done()})).next((()=>{S(0===r.length)}))}))}containsKey(t,e){return Bi(t,this.userId,e)}xn(t){return Ki(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Bi(t,e,n){const r=Rt(e,n.path),i=r[1],s=IDBKeyRange.lowerBound(r);let o=!1;return zi(t).Y({range:s,J:!0},((t,n,r)=>{const[s,c,a]=t;s===e&&c===i&&(o=!0),r.done()})).next((()=>o))}function Gi(t){return ee(t,"mutations")}function zi(t){return ee(t,"documentMutations")}function Ki(t){return ee(t,"mutationQueues")}class $i{constructor(t){this.On=t}next(){return this.On+=2,this.On}static Nn(){return new $i(0)}static Ln(){return new $i(-1)}}class Qi{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Bn(t).next((e=>{const n=new $i(e.highestTargetId);return e.highestTargetId=n.next(),this.kn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Bn(t).next((t=>$.fromTimestamp(new K(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Bn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Bn(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.kn(t,r))))}addTargetData(t,e){return this.qn(t,e).next((()=>this.Bn(t).next((n=>(n.targetCount+=1,this.Qn(e,n),this.kn(t,n))))))}updateTargetData(t,e){return this.qn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>Wi(t).delete(e.targetId))).next((()=>this.Bn(t))).next((e=>(S(e.targetCount>0),e.targetCount-=1,this.kn(t,e))))}removeTargets(t,e,n){let r=0;const i=[];return Wi(t).Y(((s,o)=>{const c=Ys(o);c.sequenceNumber<=e&&null===n.get(c.targetId)&&(r++,i.push(this.removeTargetData(t,c)))})).next((()=>lt.waitFor(i))).next((()=>r))}forEachTarget(t,e){return Wi(t).Y(((t,n)=>{const r=Ys(n);e(r)}))}Bn(t){return Hi(t).get("targetGlobalKey").next((t=>(S(null!==t),t)))}kn(t,e){return Hi(t).put("targetGlobalKey",e)}qn(t,e){return Wi(t).put(Xs(this.serializer,e))}Qn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Bn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=_n(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let i=null;return Wi(t).Y({range:r,index:"queryTargetsIndex"},((t,n,r)=>{const s=Ys(n);In(e,s.target)&&(i=s,r.done())})).next((()=>i))}addMatchingKeys(t,e,n){const r=[],i=Yi(t);return e.forEach((e=>{const s=Dt(e.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(t,n,e))})),lt.waitFor(r)}removeMatchingKeys(t,e,n){const r=Yi(t);return lt.forEach(e,(e=>{const i=Dt(e.path);return lt.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=Yi(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=Yi(t);let i=nr();return r.Y({range:n,J:!0},((t,e,n)=>{const r=kt(t[1]),s=new X(r);i=i.add(s)})).next((()=>i))}containsKey(t,e){const n=Dt(e.path),r=IDBKeyRange.bound([n],[z(n)],!1,!0);let i=0;return Yi(t).Y({index:"documentTargetsIndex",J:!0,range:r},(([t,e],n,r)=>{0!==t&&(i++,r.done())})).next((()=>i>0))}_t(t,e){return Wi(t).get(e).next((t=>t?Ys(t):null))}}function Wi(t){return ee(t,"targets")}function Hi(t){return ee(t,"targetGlobal")}function Yi(t){return ee(t,"targetDocuments")}function Xi([t,e],[n,r]){const i=B(t,n);return 0===i?B(e,r):i}class Ji{constructor(t){this.Kn=t,this.buffer=new ue(Xi),this.$n=0}Un(){return++this.$n}Wn(t){const e=[t,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Xi(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Zi{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}zn(t){v("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){yt(t)?v("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await ht(t)}await this.zn(3e5)}))}}class to{constructor(t,e){this.jn=t,this.params=e}calculateTargetCount(t,e){return this.jn.Hn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return lt.resolve(Tt._e);const n=new Ji(e);return this.jn.forEachTarget(t,(t=>n.Wn(t.sequenceNumber))).next((()=>this.jn.Jn(t,(t=>n.Wn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.jn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.jn.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(v("LruGarbageCollector","Garbage collection skipped; disabled"),lt.resolve(Li)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(v("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Li):this.Yn(t,e)))}getCacheSize(t){return this.jn.getCacheSize(t)}Yn(t,e){let n,r,i,s,o,a,u;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(v("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,s=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(i=e,a=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),y()<=c.a.DEBUG&&v("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${s-h}ms\n\tDetermined least recently used ${r} in `+(o-s)+"ms\n"+`\tRemoved ${i} targets in `+(a-o)+"ms\n"+`\tRemoved ${t} documents in `+(u-a)+"ms\n"+`Total Duration: ${u-h}ms`),lt.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:t}))))}}function eo(t,e){return new to(t,e)}class no{constructor(t,e){this.db=t,this.garbageCollector=eo(this,e)}Hn(t){const e=this.Zn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Zn(t){let e=0;return this.Jn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Jn(t,e){return this.Xn(t,((t,n)=>e(n)))}addReference(t,e,n){return ro(t,n)}removeReference(t,e,n){return ro(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return ro(t,e)}er(t,e){return function(t,e){let n=!1;return Ki(t).Z((r=>Bi(t,r,e).next((t=>(t&&(n=!0),lt.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let i=0;return this.Xn(t,((s,o)=>{if(o<=e){const e=this.er(t,s).next((e=>{if(!e)return i++,n.getEntry(t,s).next((()=>(n.removeEntry(s,$.min()),Yi(t).delete(function(t){return[0,Dt(t.path)]}(s)))))}));r.push(e)}})).next((()=>lt.waitFor(r))).next((()=>n.apply(t))).next((()=>i))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return ro(t,e)}Xn(t,e){const n=Yi(t);let r,i=Tt._e;return n.Y({index:"documentTargetsIndex"},(([t,n],{path:s,sequenceNumber:o})=>{0===t?(i!==Tt._e&&e(new X(kt(r)),i),i=o,r=s):i=Tt._e})).next((()=>{i!==Tt._e&&e(new X(kt(r)),i)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function ro(t,e){return Yi(t).put(function(t,e){return{targetId:0,path:Dt(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class so{constructor(){this.changes=new zn((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Qe.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?lt.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class io{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return co(t).put(n)}removeEntry(t,e,n){return co(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],$s(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.tr(t,n))))}getEntry(t,e){let n=Qe.newInvalidDocument(e);return co(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(ho(e))},((t,r)=>{n=this.nr(e,r)})).next((()=>n))}rr(t,e){let n={size:0,document:Qe.newInvalidDocument(e)};return co(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(ho(e))},((t,r)=>{n={document:this.nr(e,r),size:ji(r)}})).next((()=>n))}getEntries(t,e){let n=$n();return this.ir(t,e,((t,e)=>{const r=this.nr(t,e);n=n.insert(t,r)})).next((()=>n))}sr(t,e){let n=$n(),r=new ie(X.comparator);return this.ir(t,e,((t,e)=>{const i=this.nr(t,e);n=n.insert(t,i),r=r.insert(t,ji(e))})).next((()=>({documents:n,_r:r})))}ir(t,e,n){if(e.isEmpty())return lt.resolve();let r=new ue(fo);e.forEach((t=>r=r.add(t)));const i=IDBKeyRange.bound(ho(r.first()),ho(r.last())),s=r.getIterator();let o=s.getNext();return co(t).Y({index:"documentKeyIndex",range:i},((t,e,r)=>{const i=X.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&fo(o,i)<0;)n(o,null),o=s.getNext();o&&o.isEqual(i)&&(n(o,e),o=s.hasNext()?s.getNext():null),o?r.U(ho(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=s.hasNext()?s.getNext():null}))}getDocumentsMatchingQuery(t,e,n,r,i){const s=e.path,o=[s.popLast().toArray(),s.lastSegment(),$s(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],c=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return co(t).W(IDBKeyRange.bound(o,c,!0)).next((t=>{null==i||i.incrementDocumentReadCount(t.length);let n=$n();for(const i of t){const t=this.nr(X.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);t.isFoundDocument()&&(jn(e,t)||r.has(t.key))&&(n=n.insert(t.key,t))}return n}))}getAllFromCollectionGroup(t,e,n,r){let i=$n();const s=lo(e,n),o=lo(e,ot.max());return co(t).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(s,o,!0)},((t,e,n)=>{const s=this.nr(X.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);i=i.insert(s.key,s),i.size===r&&n.done()})).next((()=>i))}newChangeBuffer(t){return new ao(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return uo(t).get("remoteDocumentGlobalKey").next((t=>(S(!!t),t)))}tr(t,e){return uo(t).put("remoteDocumentGlobalKey",e)}nr(t,e){if(e){const t=function(t,e){let n;if(e.document)n=Ds(t.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=X.fromSegments(e.noDocument.path),r=Ws(e.noDocument.readTime);n=Qe.newNoDocument(t,r),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return T();{const t=X.fromSegments(e.unknownDocument.path),r=Ws(e.unknownDocument.version);n=Qe.newUnknownDocument(t,r)}}return e.readTime&&n.setReadTime(function(t){const e=new K(t[0],t[1]);return $.fromTimestamp(e)}(e.readTime)),n}(this.serializer,e);if(!t.isNoDocument()||!t.version.isEqual($.min()))return t}return Qe.newInvalidDocument(t)}}function oo(t){return new io(t)}class ao extends so{constructor(t,e){super(),this.ar=t,this.trackRemovals=e,this.ur=new zn((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new ue(((t,e)=>B(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((i,s)=>{const o=this.ur.get(i);if(e.push(this.ar.removeEntry(t,i,o.readTime)),s.isValidDocument()){const c=Ks(this.ar.serializer,s);r=r.add(i.path.popLast());const a=ji(c);n+=a-o.size,e.push(this.ar.addEntry(t,i,c))}else if(n-=o.size,this.trackRemovals){const n=Ks(this.ar.serializer,s.convertToNoDocument($.min()));e.push(this.ar.addEntry(t,i,n))}})),r.forEach((n=>{e.push(this.ar.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.ar.updateMetadata(t,n)),lt.waitFor(e)}getFromCache(t,e){return this.ar.rr(t,e).next((t=>(this.ur.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.ar.sr(t,e).next((({documents:t,_r:e})=>(e.forEach(((e,n)=>{this.ur.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function uo(t){return ee(t,"remoteDocumentGlobal")}function co(t){return ee(t,"remoteDocumentsV14")}function ho(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function lo(t,e){const n=e.documentKey.path.toArray();return[t,$s(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function fo(t,e){const n=t.path.toArray(),r=e.path.toArray();let i=0;for(let t=0;t<n.length-2&&t<r.length-2;++t)if(i=B(n[t],r[t]),i)return i;return i=B(n.length,r.length),i||(i=B(n[n.length-2],r[r.length-2]),i||B(n[n.length-1],r[r.length-1]))}class mo{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class go{constructor(t,e,n,r){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((r=>(n=r,this.remoteDocumentCache.getEntry(t,e)))).next((t=>(null!==n&&Ar(n.mutation,t,le.empty(),K.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,nr()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=nr()){const r=Yn();return this.populateOverlays(t,r,e).next((()=>this.computeViews(t,e,r,n).next((t=>{let e=Wn();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=Yn();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,nr())))}populateOverlays(t,e,n){const r=[];return n.forEach((t=>{e.has(t)||r.push(t)})),this.documentOverlayCache.getOverlays(t,r).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,r){let i=$n();const s=Jn(),o=Jn();return e.forEach(((t,e)=>{const o=n.get(e.key);r.has(e.key)&&(void 0===o||o.mutation instanceof Rr)?i=i.insert(e.key,e):void 0!==o?(s.set(e.key,o.mutation.getFieldMask()),Ar(o.mutation,e,o.mutation.getFieldMask(),K.now())):s.set(e.key,le.empty())})),this.recalculateAndSaveOverlays(t,i).next((t=>(t.forEach(((t,e)=>s.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new mo(e,null!==(n=s.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=Jn();let r=new ie(((t,e)=>t-e)),i=nr();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const i of t)i.keys().forEach((t=>{const s=e.get(t);if(null===s)return;let o=n.get(t)||le.empty();o=i.applyToLocalView(s,o),n.set(t,o);const c=(r.get(i.batchId)||nr()).add(t);r=r.insert(i.batchId,c)}))})).next((()=>{const s=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),c=r.key,a=r.value,u=Xn();a.forEach((t=>{if(!i.has(t)){const r=Cr(e.get(t),n.get(t));null!==r&&u.set(t,r),i=i.add(t)}})),s.push(this.documentOverlayCache.saveOverlays(t,c,u))}return lt.waitFor(s)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n,r){return function(t){return X.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):kn(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,r):this.getDocumentsMatchingCollectionQuery(t,e,n,r)}getNextDocuments(t,e,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,r).next((i=>{const s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,r-i.size):lt.resolve(Yn());let o=-1,c=i;return s.next((e=>lt.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),i.get(e)?lt.resolve():this.remoteDocumentCache.getEntry(t,e).next((t=>{c=c.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,i))).next((()=>this.computeViews(t,c,e,nr()))).next((t=>({batchId:o,changes:Hn(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new X(e)).next((t=>{let e=Wn();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n,r){const i=e.collectionGroup;let s=Wn();return this.indexManager.getCollectionParents(t,i).next((o=>lt.forEach(o,(o=>{const c=function(t,e){return new Cn(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,o.child(i));return this.getDocumentsMatchingCollectionQuery(t,c,n,r).next((t=>{t.forEach(((t,e)=>{s=s.insert(t,e)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(t,e,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next((s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,i,r)))).next((t=>{i.forEach(((e,n)=>{const r=n.getKey();null===t.get(r)&&(t=t.insert(r,Qe.newInvalidDocument(r)))}));let n=Wn();return t.forEach(((t,r)=>{const s=i.get(t);void 0!==s&&Ar(s.mutation,r,le.empty(),K.now()),jn(e,r)&&(n=n.insert(t,r))})),n}))}}class po{constructor(t){this.serializer=t,this.cr=new Map,this.lr=new Map}getBundleMetadata(t,e){return lt.resolve(this.cr.get(e))}saveBundleMetadata(t,e){return this.cr.set(e.id,function(t){return{id:t.id,version:t.version,createTime:ys(t.createTime)}}(e)),lt.resolve()}getNamedQuery(t,e){return lt.resolve(this.lr.get(e))}saveNamedQuery(t,e){return this.lr.set(e.name,function(t){return{name:t.name,query:Js(t.bundledQuery),readTime:ys(t.readTime)}}(e)),lt.resolve()}}class yo{constructor(){this.overlays=new ie(X.comparator),this.hr=new Map}getOverlay(t,e){return lt.resolve(this.overlays.get(e))}getOverlays(t,e){const n=Yn();return lt.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,r)=>{this.ht(t,e,r)})),lt.resolve()}removeOverlaysForBatchId(t,e,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((t=>this.overlays=this.overlays.remove(t))),this.hr.delete(n)),lt.resolve()}getOverlaysForCollection(t,e,n){const r=Yn(),i=e.length+1,s=new X(e.child("")),o=this.overlays.getIteratorFrom(s);for(;o.hasNext();){const t=o.getNext().value,s=t.getKey();if(!e.isPrefixOf(s.path))break;s.path.length===i&&t.largestBatchId>n&&r.set(t.getKey(),t)}return lt.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let i=new ie(((t,e)=>t-e));const s=this.overlays.getIterator();for(;s.hasNext();){const t=s.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=i.get(t.largestBatchId);null===e&&(e=Yn(),i=i.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=Yn(),c=i.getIterator();for(;c.hasNext()&&(c.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=r)););return lt.resolve(o)}ht(t,e,n){const r=this.overlays.get(n.key);if(null!==r){const t=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new Ur(e,n));let i=this.hr.get(e);void 0===i&&(i=nr(),this.hr.set(e,i)),this.hr.set(e,i.add(n.key))}}class wo{constructor(){this.Pr=new ue(vo.Ir),this.Tr=new ue(vo.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(t,e){const n=new vo(t,e);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.Ar(new vo(t,e))}Rr(t,e){t.forEach((t=>this.removeReference(t,e)))}Vr(t){const e=new X(new W([])),n=new vo(e,t),r=new vo(e,t+1),i=[];return this.Tr.forEachInRange([n,r],(t=>{this.Ar(t),i.push(t.key)})),i}mr(){this.Pr.forEach((t=>this.Ar(t)))}Ar(t){this.Pr=this.Pr.delete(t),this.Tr=this.Tr.delete(t)}gr(t){const e=new X(new W([])),n=new vo(e,t),r=new vo(e,t+1);let i=nr();return this.Tr.forEachInRange([n,r],(t=>{i=i.add(t.key)})),i}containsKey(t){const e=new vo(t,0),n=this.Pr.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class vo{constructor(t,e){this.key=t,this.pr=e}static Ir(t,e){return X.comparator(t.key,e.key)||B(t.pr,e.pr)}static Er(t,e){return B(t.pr,e.pr)||X.comparator(t.key,e.key)}}class bo{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.yr=1,this.wr=new ue(vo.Ir)}checkEmpty(t){return lt.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,r){const i=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const s=new qr(i,e,n,r);this.mutationQueue.push(s);for(const e of r)this.wr=this.wr.add(new vo(e.key,i)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return lt.resolve(s)}lookupMutationBatch(t,e){return lt.resolve(this.Sr(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this.br(n),i=r<0?0:r;return lt.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}getHighestUnacknowledgedBatchId(){return lt.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(t){return lt.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new vo(e,0),r=new vo(e,Number.POSITIVE_INFINITY),i=[];return this.wr.forEachInRange([n,r],(t=>{const e=this.Sr(t.pr);i.push(e)})),lt.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new ue(B);return e.forEach((t=>{const e=new vo(t,0),r=new vo(t,Number.POSITIVE_INFINITY);this.wr.forEachInRange([e,r],(t=>{n=n.add(t.pr)}))})),lt.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let i=n;X.isDocumentKey(i)||(i=i.child(""));const s=new vo(new X(i),0);let o=new ue(B);return this.wr.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.pr)),!0)}),s),lt.resolve(this.Dr(o))}Dr(t){const e=[];return t.forEach((t=>{const n=this.Sr(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){S(0===this.Cr(e.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return lt.forEach(e.mutations,(r=>{const i=new vo(r.key,e.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this.wr=n}))}Mn(t){}containsKey(t,e){const n=new vo(e,0),r=this.wr.firstAfterOrEqual(n);return lt.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.mutationQueue.length,lt.resolve()}Cr(t,e){return this.br(t)}br(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}Sr(t){const e=this.br(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class _o{constructor(t){this.vr=t,this.docs=new ie(X.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,r=this.docs.get(n),i=r?r.size:0,s=this.vr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return lt.resolve(n?n.document.mutableCopy():Qe.newInvalidDocument(e))}getEntries(t,e){let n=$n();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():Qe.newInvalidDocument(t))})),lt.resolve(n)}getDocumentsMatchingQuery(t,e,n,r){let i=$n();const s=e.path,o=new X(s.child("")),c=this.docs.getIteratorFrom(o);for(;c.hasNext();){const{key:t,value:{document:o}}=c.getNext();if(!s.isPrefixOf(t.path))break;t.path.length>s.length+1||at(it(o),n)<=0||(r.has(o.key)||jn(e,o))&&(i=i.insert(o.key,o.mutableCopy()))}return lt.resolve(i)}getAllFromCollectionGroup(t,e,n,r){T()}Fr(t,e){return lt.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Io(this)}getSize(t){return lt.resolve(this.size)}}class Io extends so{constructor(t){super(),this.ar=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?e.push(this.ar.addEntry(t,r)):this.ar.removeEntry(n)})),lt.waitFor(e)}getFromCache(t,e){return this.ar.getEntry(t,e)}getAllFromCache(t,e){return this.ar.getEntries(t,e)}}class Eo{constructor(t){this.persistence=t,this.Mr=new zn((t=>_n(t)),In),this.lastRemoteSnapshotVersion=$.min(),this.highestTargetId=0,this.Or=0,this.Nr=new wo,this.targetCount=0,this.Lr=$i.Nn()}forEachTarget(t,e){return this.Mr.forEach(((t,n)=>e(n))),lt.resolve()}getLastRemoteSnapshotVersion(t){return lt.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return lt.resolve(this.Or)}allocateTargetId(t){return this.highestTargetId=this.Lr.next(),lt.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Or&&(this.Or=e),lt.resolve()}qn(t){this.Mr.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Lr=new $i(e),this.highestTargetId=e),t.sequenceNumber>this.Or&&(this.Or=t.sequenceNumber)}addTargetData(t,e){return this.qn(e),this.targetCount+=1,lt.resolve()}updateTargetData(t,e){return this.qn(e),lt.resolve()}removeTargetData(t,e){return this.Mr.delete(e.target),this.Nr.Vr(e.targetId),this.targetCount-=1,lt.resolve()}removeTargets(t,e,n){let r=0;const i=[];return this.Mr.forEach(((s,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Mr.delete(s),i.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),lt.waitFor(i).next((()=>r))}getTargetCount(t){return lt.resolve(this.targetCount)}getTargetData(t,e){const n=this.Mr.get(e)||null;return lt.resolve(n)}addMatchingKeys(t,e,n){return this.Nr.dr(e,n),lt.resolve()}removeMatchingKeys(t,e,n){this.Nr.Rr(e,n);const r=this.persistence.referenceDelegate,i=[];return r&&e.forEach((e=>{i.push(r.markPotentiallyOrphaned(t,e))})),lt.waitFor(i)}removeMatchingKeysForTargetId(t,e){return this.Nr.Vr(e),lt.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Nr.gr(e);return lt.resolve(n)}containsKey(t,e){return lt.resolve(this.Nr.containsKey(e))}}class To{constructor(t,e){this.Br={},this.overlays={},this.kr=new Tt(0),this.qr=!1,this.qr=!0,this.referenceDelegate=t(this),this.Qr=new Eo(this),this.indexManager=new Di,this.remoteDocumentCache=function(t){return new _o(t)}((t=>this.referenceDelegate.Kr(t))),this.serializer=new zs(e),this.$r=new po(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new yo,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Br[t.toKey()];return n||(n=new bo(e,this.referenceDelegate),this.Br[t.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(t,e,n){v("MemoryPersistence","Starting transaction:",t);const r=new So(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((t=>this.referenceDelegate.Wr(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}Gr(t,e){return lt.or(Object.values(this.Br).map((n=>()=>n.containsKey(t,e))))}}class So extends ct{constructor(t){super(),this.currentSequenceNumber=t}}class xo{constructor(t){this.persistence=t,this.zr=new wo,this.jr=null}static Hr(t){return new xo(t)}get Jr(){if(this.jr)return this.jr;throw T()}addReference(t,e,n){return this.zr.addReference(n,e),this.Jr.delete(n.toString()),lt.resolve()}removeReference(t,e,n){return this.zr.removeReference(n,e),this.Jr.add(n.toString()),lt.resolve()}markPotentiallyOrphaned(t,e){return this.Jr.add(e.toString()),lt.resolve()}removeTarget(t,e){this.zr.Vr(e.targetId).forEach((t=>this.Jr.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Jr.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Ur(){this.jr=new Set}Wr(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return lt.forEach(this.Jr,(n=>{const r=X.fromPath(n);return this.Yr(t,r).next((t=>{t||e.removeEntry(r,$.min())}))})).next((()=>(this.jr=null,e.apply(t))))}updateLimboDocument(t,e){return this.Yr(t,e).next((t=>{t?this.Jr.delete(e.toString()):this.Jr.add(e.toString())}))}Kr(t){return 0}Yr(t,e){return lt.or([()=>lt.resolve(this.zr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Gr(t,e)])}}class Co{constructor(t){this.serializer=t}N(t,e,n,r){const i=new ft("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ot,{unique:!0}),t.createObjectStore("documentMutations")}(t),Do(t),function(t){t.createObjectStore("remoteDocuments")}(t));let s=lt.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),Do(t)),s=s.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:$.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(i)))),n<4&&r>=4&&(0!==n&&(s=s.next((()=>function(t,e){return e.store("mutations").W().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ot,{unique:!0});const r=e.store("mutations"),i=n.map((t=>r.put(t)));return lt.waitFor(i)}))}(t,i)))),s=s.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&r>=5&&(s=s.next((()=>this.Xr(i)))),n<6&&r>=6&&(s=s.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.ei(i))))),n<7&&r>=7&&(s=s.next((()=>this.ti(i)))),n<8&&r>=8&&(s=s.next((()=>this.ni(t,i)))),n<9&&r>=9&&(s=s.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&r>=10&&(s=s.next((()=>this.ri(i)))),n<11&&r>=11&&(s=s.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&r>=12&&(s=s.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:$t});e.createIndex("collectionPathOverlayIndex",Qt,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",Wt,{unique:!1})}(t)}))),n<13&&r>=13&&(s=s.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Ft});e.createIndex("documentKeyIndex",Lt),e.createIndex("collectionGroupIndex",Vt)}(t))).next((()=>this.ii(t,i))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(s=s.next((()=>this.si(t,i)))),n<15&&r>=15&&(s=s.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:Bt}).createIndex("sequenceNumberIndex",Gt,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:zt}).createIndex("documentKeyIndex",Kt,{unique:!1})}(t)))),s}ei(t){let e=0;return t.store("remoteDocuments").Y(((t,n)=>{e+=ji(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Xr(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.W().next((e=>lt.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",r).next((n=>lt.forEach(n,(n=>{S(n.userId===e.userId);const r=Hs(this.serializer,n);return qi(t,e.userId,r).next((()=>{}))}))))}))))}ti(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const r=[];return n.Y(((n,i)=>{const s=new W(n),o=function(t){return[0,Dt(t)]}(s);r.push(e.get(o).next((n=>n?lt.resolve():(n=>e.put({targetId:0,path:Dt(n),sequenceNumber:t.highestListenSequenceNumber}))(s))))})).next((()=>lt.waitFor(r)))}))}ni(t,e){t.createObjectStore("collectionParents",{keyPath:Ut});const n=e.store("collectionParents"),r=new Ai,o=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Dt(r)})}};return e.store("remoteDocuments").Y({J:!0},((t,e)=>{const n=new W(t);return o(n.popLast())})).next((()=>e.store("documentMutations").Y({J:!0},(([t,e,n],r)=>{const i=kt(e);return o(i.popLast())}))))}ri(t){const e=t.store("targets");return e.Y(((t,n)=>{const r=Ys(n),i=Xs(this.serializer,r);return e.put(i)}))}ii(t,e){const n=e.store("remoteDocuments"),r=[];return n.Y(((t,n)=>{const i=e.store("remoteDocumentsV14"),s=function(t){return t.document?new X(W.fromString(t.document.name).popFirst(5)):t.noDocument?X.fromSegments(t.noDocument.path):t.unknownDocument?X.fromSegments(t.unknownDocument.path):T()}(n).path.toArray(),o={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(o))})).next((()=>lt.waitFor(r)))}si(t,e){const n=e.store("mutations"),r=oo(this.serializer),i=new To(xo.Hr,this.serializer.ct);return n.W().next((t=>{const n=new Map;return t.forEach((t=>{var e;let r=null!==(e=n.get(t.userId))&&void 0!==e?e:nr();Hs(this.serializer,t).keys().forEach((t=>r=r.add(t))),n.set(t.userId,r)})),lt.forEach(n,((t,n)=>{const s=new f(n),o=ii.lt(this.serializer,s),c=i.getIndexManager(s),a=Ui.lt(s,this.serializer,c,i.referenceDelegate);return new go(r,a,o,c).recalculateAndSaveOverlaysForDocumentKeys(new te(e,Tt._e),t).next()}))}))}}function Do(t){t.createObjectStore("targetDocuments",{keyPath:jt}).createIndex("documentTargetsIndex",q,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",qt,{unique:!0}),t.createObjectStore("targetGlobal")}const Ao="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class No{constructor(t,e,n,r,i,s,o,c,a,u,h=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.oi=i,this.window=s,this.document=o,this._i=a,this.ai=u,this.ui=h,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=t=>Promise.resolve(),!No.D())throw new A(D.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new no(this,r),this.Ti=e+"main",this.serializer=new zs(c),this.Ei=new mt(this.Ti,this.ui,new Co(this.serializer)),this.Qr=new Qi(this.referenceDelegate,this.serializer),this.remoteDocumentCache=oo(this.serializer),this.$r=new ni,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,!1===u&&_("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new A(D.FAILED_PRECONDITION,Ao);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Qr.getHighestSequenceNumber(t)))})).then((t=>{this.kr=new Tt(t,this._i)})).then((()=>{this.qr=!0})).catch((t=>(this.Ei&&this.Ei.close(),Promise.reject(t))))}fi(t){return this.Ii=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ei.B((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.oi.enqueueAndForget((async()=>{this.started&&await this.Ai()})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>Oo(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.gi(t).next((t=>{t||(this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))))}))})).next((()=>this.pi(t))).next((e=>this.isPrimary&&!e?this.yi(t).next((()=>!1)):!!e&&this.wi(t).next((()=>!0)))))).catch((t=>{if(yt(t))return v("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return v("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.oi.enqueueRetryable((()=>this.Ii(t))),this.isPrimary=t}))}gi(t){return ko(t).get("owner").next((t=>lt.resolve(this.Si(t))))}bi(t){return Oo(t).delete(this.clientId)}async Di(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=ee(t,"clientMetadata");return e.W().next((t=>{const n=this.vi(t,18e5),r=t.filter((t=>-1===n.indexOf(t)));return lt.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.di)for(const e of t)this.di.removeItem(this.Fi(e.clientId))}}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ai().then((()=>this.Di())).then((()=>this.mi()))))}Si(t){return!!t&&t.ownerId===this.clientId}pi(t){return this.ai?lt.resolve(!0):ko(t).get("owner").next((e=>{if(null!==e&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)){if(this.Si(e)&&this.networkEnabled)return!0;if(!this.Si(e)){if(!e.allowTabSynchronization)throw new A(D.FAILED_PRECONDITION,Ao);return!1}}return!(!this.networkEnabled||!this.inForeground)||Oo(t).W().next((t=>void 0===this.vi(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&v("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new te(t,Tt._e);return this.yi(e).next((()=>this.bi(e)))})),this.Ei.close(),this.Li()}vi(t,e){return t.filter((t=>this.Ci(t.updateTimeMs,e)&&!this.Mi(t.clientId)))}Bi(){return this.runTransaction("getActiveClients","readonly",(t=>Oo(t).W().next((t=>this.vi(t,18e5).map((t=>t.clientId))))))}get started(){return this.qr}getMutationQueue(t,e){return Ui.lt(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new ki(t,this.serializer.ct.databaseId)}getDocumentOverlayCache(t){return ii.lt(this.serializer,t)}getBundleCache(){return this.$r}runTransaction(t,e,n){v("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite",i=function(t){return 15===t?Zt:14===t?Jt:13===t?Xt:12===t?Yt:11===t?Ht:void T()}(this.ui);let s;return this.Ei.runTransaction(t,r,i,(r=>(s=new te(r,this.kr?this.kr.next():Tt._e),"readwrite-primary"===e?this.gi(s).next((t=>!!t||this.pi(s))).next((e=>{if(!e)throw _(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))),new A(D.FAILED_PRECONDITION,ut);return n(s)})).next((t=>this.wi(s).next((()=>t)))):this.ki(s).next((()=>n(s)))))).then((t=>(s.raiseOnCommittedEvent(),t)))}ki(t){return ko(t).get("owner").next((t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)&&!this.Si(t)&&!(this.ai||this.allowTabSynchronization&&t.allowTabSynchronization))throw new A(D.FAILED_PRECONDITION,Ao)}))}wi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return ko(t).put("owner",e)}static D(){return mt.D()}yi(t){const e=ko(t);return e.get("owner").next((t=>this.Si(t)?(v("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):lt.resolve()))}Ci(t,e){const n=Date.now();return!(t<n-e||t>n&&(_(`Detected an update time that is in the future: ${t} > ${n}`),1))}Ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.li=()=>{this.oi.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ai())))},this.document.addEventListener("visibilitychange",this.li),this.inForeground="visible"===this.document.visibilityState)}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.ci=()=>{this.xi();const t=/(?:Version|Mobile)\/1[456]/;Object(h.z)()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(t){var e;try{const n=null!==(null===(e=this.di)||void 0===e?void 0:e.getItem(this.Fi(t)));return v("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return _("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(t){_("Failed to set zombie client id.",t)}}Li(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch(t){}}Fi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function ko(t){return ee(t,"owner")}function Oo(t){return ee(t,"clientMetadata")}function Ro(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class Mo{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.qi=n,this.Qi=r}static Ki(t,e){let n=nr(),r=nr();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new Mo(t,e.fromCache,n,r)}}class Po{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}class Fo{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=Object(h.z)()?8:mt.v(Object(h.q)())>0?6:4}initialize(t,e){this.zi=t,this.indexManager=e,this.$i=!0}getDocumentsMatchingQuery(t,e,n,r){const i={result:null};return this.ji(t,e).next((t=>{i.result=t})).next((()=>{if(!i.result)return this.Hi(t,e,r,n).next((t=>{i.result=t}))})).next((()=>{if(i.result)return;const n=new Po;return this.Ji(t,e,n).next((r=>{if(i.result=r,this.Ui)return this.Yi(t,e,n,r.size)}))})).next((()=>i.result))}Yi(t,e,n,r){return n.documentReadCount<this.Wi?(y()<=c.a.DEBUG&&v("QueryEngine","SDK will not create cache indexes for query:",qn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),lt.resolve()):(y()<=c.a.DEBUG&&v("QueryEngine","Query:",qn(e),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Gi*r?(y()<=c.a.DEBUG&&v("QueryEngine","The SDK decides to create cache indexes for query:",qn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Rn(e))):lt.resolve())}ji(t,e){if(Nn(e))return lt.resolve(null);let n=Rn(e);return this.indexManager.getIndexType(t,n).next((r=>0===r?null:(null!==e.limit&&1===r&&(e=Fn(e,null,"F"),n=Rn(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((r=>{const i=nr(...r);return this.zi.getDocuments(t,i).next((r=>this.indexManager.getMinOffset(t,n).next((n=>{const s=this.Zi(e,r);return this.Xi(e,s,i,n.readTime)?this.ji(t,Fn(e,null,"F")):this.es(t,s,e,n)}))))})))))}Hi(t,e,n,r){return Nn(e)||r.isEqual($.min())?lt.resolve(null):this.zi.getDocuments(t,n).next((i=>{const s=this.Zi(e,i);return this.Xi(e,s,n,r)?lt.resolve(null):(y()<=c.a.DEBUG&&v("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),qn(e)),this.es(t,s,e,st(r,-1)).next((t=>t)))}))}Zi(t,e){let n=new ue(Bn(t));return e.forEach(((e,r)=>{jn(t,r)&&(n=n.add(r))})),n}Xi(t,e,n,r){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const i="F"===t.limitType?e.last():e.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Ji(t,e,n){return y()<=c.a.DEBUG&&v("QueryEngine","Using full collection scan to execute query:",qn(e)),this.zi.getDocumentsMatchingQuery(t,e,ot.min(),n)}es(t,e,n,r){return this.zi.getDocumentsMatchingQuery(t,n,r).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class Lo{constructor(t,e,n,r){this.persistence=t,this.ts=e,this.serializer=r,this.ns=new ie(B),this.rs=new zn((t=>_n(t)),In),this.ss=new Map,this.os=t.getRemoteDocumentCache(),this.Qr=t.getTargetCache(),this.$r=t.getBundleCache(),this._s(n)}_s(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new go(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.ns)))}}function Vo(t,e,n,r){return new Lo(t,e,n,r)}async function qo(t,e){const n=C(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let r;return n.mutationQueue.getAllMutationBatches(t).next((i=>(r=i,n._s(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const i=[],s=[];let o=nr();for(const t of r){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){s.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({us:t,removedBatchIds:i,addedBatchIds:s})))}))}))}function jo(t){const e=C(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Qr.getLastRemoteSnapshotVersion(t)))}function Uo(t,e,n){let r=nr(),i=nr();return n.forEach((t=>r=r.add(t))),e.getEntries(t,r).next((t=>{let r=$n();return n.forEach(((n,s)=>{const o=t.get(n);s.isFoundDocument()!==o.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual($.min())?(e.removeEntry(n,s.readTime),r=r.insert(n,s)):!o.isValidDocument()||s.version.compareTo(o.version)>0||0===s.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(s),r=r.insert(n,s)):v("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",s.version)})),{cs:r,ls:i}}))}function Bo(t,e){const n=C(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function Go(t,e){const n=C(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.Qr.getTargetData(t,e).next((i=>i?(r=i,lt.resolve(r)):n.Qr.allocateTargetId(t).next((i=>(r=new Gs(e,i,"TargetPurposeListen",t.currentSequenceNumber),n.Qr.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.ns.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ns=n.ns.insert(t.targetId,t),n.rs.set(e,t.targetId)),t}))}async function zo(t,e,n){const r=C(t),i=r.ns.get(e),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,(t=>r.persistence.referenceDelegate.removeTarget(t,i)))}catch(t){if(!yt(t))throw t;v("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.ns=r.ns.remove(e),r.rs.delete(i.target)}function Ko(t,e,n){const r=C(t);let i=$.min(),s=nr();return r.persistence.runTransaction("Execute query","readwrite",(t=>function(t,e,n){const r=C(t),i=r.rs.get(n);return void 0!==i?lt.resolve(r.ns.get(i)):r.Qr.getTargetData(e,n)}(r,t,Rn(e)).next((e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(t,e.targetId).next((t=>{s=t}))})).next((()=>r.ts.getDocumentsMatchingQuery(t,e,n?i:$.min(),n?s:nr()))).next((t=>(Wo(r,Un(e),t),{documents:t,hs:s})))))}function $o(t,e){const n=C(t),r=C(n.Qr),i=n.ns.get(e);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",(t=>r._t(t,e).next((t=>t?t.target:null))))}function Qo(t,e){const n=C(t),r=n.ss.get(e)||$.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.os.getAllFromCollectionGroup(t,e,st(r,-1),Number.MAX_SAFE_INTEGER))).then((t=>(Wo(n,e,t),t)))}function Wo(t,e,n){let r=t.ss.get(e)||$.min();n.forEach(((t,e)=>{e.readTime.compareTo(r)>0&&(r=e.readTime)})),t.ss.set(e,r)}async function Ho(t,e,n=nr()){const r=await Go(t,Rn(Js(e.bundledQuery))),i=C(t);return i.persistence.runTransaction("Save named query","readwrite",(t=>{const s=ys(e.readTime);if(r.snapshotVersion.compareTo(s)>=0)return i.$r.saveNamedQuery(t,e);const o=r.withResumeToken(me.EMPTY_BYTE_STRING,s);return i.ns=i.ns.insert(o.targetId,o),i.Qr.updateTargetData(t,o).next((()=>i.Qr.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>i.Qr.addMatchingKeys(t,n,r.targetId))).next((()=>i.$r.saveNamedQuery(t,e)))}))}function Yo(t,e){return`firestore_clients_${t}_${e}`}function Xo(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function Jo(t,e){return`firestore_targets_${t}_${e}`}class Zo{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Es(t,e,n){const r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code,s&&(i=new A(r.error.code,r.error.message))),s?new Zo(t,e,r.state,i):(_("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}ds(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class ta{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Es(t,e){const n=JSON.parse(e);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(r=new A(n.error.code,n.error.message))),i?new ta(t,n.state,r):(_("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}ds(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class ea{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Es(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=sr();for(let t=0;r&&t<n.activeTargetIds.length;++t)r=Ct(n.activeTargetIds[t]),i=i.add(n.activeTargetIds[t]);return r?new ea(t,i):(_("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class na{constructor(t,e){this.clientId=t,this.onlineState=e}static Es(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new na(e.clientId,e.onlineState):(_("SharedClientState",`Failed to parse online state: ${t}`),null)}}class ra{constructor(){this.activeTargetIds=sr()}As(t){this.activeTargetIds=this.activeTargetIds.add(t)}Rs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}ds(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class sa{constructor(t,e,n,r,i){this.window=t,this.oi=e,this.persistenceKey=n,this.Vs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new ie(B),this.started=!1,this.ys=[];const s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.ws=Yo(this.persistenceKey,this.Vs),this.Ss=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new ra),this.bs=new RegExp(`^firestore_clients_${s}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${s}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${s}_(\\d+)$`),this.vs=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Fs=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Bi();for(const e of t){if(e===this.Vs)continue;const t=this.getItem(Yo(this.persistenceKey,e));if(t){const n=ea.Es(e,t);n&&(this.ps=this.ps.insert(n.clientId,n))}}this.Ms();const e=this.storage.getItem(this.vs);if(e){const t=this.xs(e);t&&this.Os(t)}for(const t of this.ys)this.gs(t);this.ys=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Ss,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(t){let e=!1;return this.ps.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Ls(t,"pending")}updateMutationState(t,e,n){this.Ls(t,e,n),this.Bs(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(Jo(this.persistenceKey,t));if(n){const r=ta.Es(t,n);r&&(e=r.state)}}return this.ks.As(t),this.Ms(),e}removeLocalQueryTarget(t){this.ks.Rs(t),this.Ms()}isLocalQueryTarget(t){return this.ks.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Jo(this.persistenceKey,t))}updateQueryState(t,e,n){this.qs(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Bs(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Qs(t)}notifyBundleLoaded(t){this.Ks(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return v("SharedClientState","READ",t,e),e}setItem(t,e){v("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){v("SharedClientState","REMOVE",t),this.storage.removeItem(t)}gs(t){const e=t;if(e.storageArea===this.storage){if(v("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ws)return void _("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.bs.test(e.key)){if(null==e.newValue){const t=this.$s(e.key);return this.Us(t,null)}{const t=this.Ws(e.key,e.newValue);if(t)return this.Us(t.clientId,t)}}else if(this.Ds.test(e.key)){if(null!==e.newValue){const t=this.Gs(e.key,e.newValue);if(t)return this.zs(t)}}else if(this.Cs.test(e.key)){if(null!==e.newValue){const t=this.js(e.key,e.newValue);if(t)return this.Hs(t)}}else if(e.key===this.vs){if(null!==e.newValue){const t=this.xs(e.newValue);if(t)return this.Os(t)}}else if(e.key===this.Ss){const t=function(t){let e=Tt._e;if(null!=t)try{const n=JSON.parse(t);S("number"==typeof n),e=n}catch(t){_("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Tt._e&&this.sequenceNumberHandler(t)}else if(e.key===this.Fs){const t=this.Js(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Ys(t))))}}else this.ys.push(e)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Ls(t,e,n){const r=new Zo(this.currentUser,t,e,n),i=Xo(this.persistenceKey,this.currentUser,t);this.setItem(i,r.ds())}Bs(t){const e=Xo(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Qs(t){const e={clientId:this.Vs,onlineState:t};this.storage.setItem(this.vs,JSON.stringify(e))}qs(t,e,n){const r=Jo(this.persistenceKey,t),i=new ta(t,e,n);this.setItem(r,i.ds())}Ks(t){const e=JSON.stringify(Array.from(t));this.setItem(this.Fs,e)}$s(t){const e=this.bs.exec(t);return e?e[1]:null}Ws(t,e){const n=this.$s(t);return ea.Es(n,e)}Gs(t,e){const n=this.Ds.exec(t),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return Zo.Es(new f(i),r,e)}js(t,e){const n=this.Cs.exec(t),r=Number(n[1]);return ta.Es(r,e)}xs(t){return na.Es(t)}Js(t){return JSON.parse(t)}async zs(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Zs(t.batchId,t.state,t.error);v("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}Hs(t){return this.syncEngine.Xs(t.targetId,t.state,t.error)}Us(t,e){const n=e?this.ps.insert(t,e):this.ps.remove(t),r=this.Ns(this.ps),i=this.Ns(n),s=[],o=[];return i.forEach((t=>{r.has(t)||s.push(t)})),r.forEach((t=>{i.has(t)||o.push(t)})),this.syncEngine.eo(s,o).then((()=>{this.ps=n}))}Os(t){this.ps.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ns(t){let e=sr();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class ia{constructor(){this.no=new ra,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.no.As(t),this.ro[t]||"not-current"}updateQueryState(t,e,n){this.ro[t]=e}removeLocalQueryTarget(t){this.no.Rs(t)}isLocalQueryTarget(t){return this.no.activeTargetIds.has(t)}clearQueryState(t){delete this.ro[t]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(t){return this.no.activeTargetIds.has(t)}start(){return this.no=new ra,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class oa{io(t){}shutdown(){}}class aa{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(t){this.uo.push(t)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){v("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.uo)t(0)}ao(){v("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.uo)t(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let ua=null;function ca(){return null===ua?ua=268435456+Math.round(2147483648*Math.random()):ua++,"0x"+ua.toString(16)}const ha={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class la{constructor(t){this.lo=t.lo,this.ho=t.ho}Po(t){this.Io=t}To(t){this.Eo=t}onMessage(t){this.Ao=t}close(){this.ho()}send(t){this.lo(t)}Ro(){this.Io()}Vo(t){this.Eo(t)}mo(t){this.Ao(t)}}const da="WebChannelConnection";class fa extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.fo=e+"://"+t.host,this.po=`projects/${n}/databases/${r}`,this.yo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get wo(){return!1}So(t,e,n,r,i){const s=ca(),o=this.bo(t,e.toUriEncodedString());v("RestConnection",`Sending RPC '${t}' ${s}:`,o,n);const c={"google-cloud-resource-prefix":this.po,"x-goog-request-params":this.yo};return this.Do(c,r,i),this.Co(t,o,c,n).then((e=>(v("RestConnection",`Received RPC '${t}' ${s}: `,e),e)),(e=>{throw I("RestConnection",`RPC '${t}' ${s} failed with error: `,e,"url: ",o,"request:",n),e}))}vo(t,e,n,r,i,s){return this.So(t,e,n,r,i)}Do(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+m,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}bo(t,e){const n=ha[t];return`${this.fo}/v1/${e}:${n}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Co(t,e,n,r){const i=ca();return new Promise(((s,o)=>{const c=new l.h;c.setWithCredentials(!0),c.listenOnce(l.c.COMPLETE,(()=>{try{switch(c.getLastErrorCode()){case l.a.NO_ERROR:const e=c.getResponseJson();v(da,`XHR for RPC '${t}' ${i} received:`,JSON.stringify(e)),s(e);break;case l.a.TIMEOUT:v(da,`RPC '${t}' ${i} timed out`),o(new A(D.DEADLINE_EXCEEDED,"Request time out"));break;case l.a.HTTP_ERROR:const n=c.getStatus();if(v(da,`RPC '${t}' ${i} failed with status:`,n,"response text:",c.getResponseText()),n>0){let t=c.getResponseJson();Array.isArray(t)&&(t=t[0]);const e=null==t?void 0:t.error;if(e&&e.status&&e.message){const t=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(D).indexOf(e)>=0?e:D.UNKNOWN}(e.status);o(new A(t,e.message))}else o(new A(D.UNKNOWN,"Server responded with status "+c.getStatus()))}else o(new A(D.UNAVAILABLE,"Connection failed."));break;default:T()}}finally{v(da,`RPC '${t}' ${i} completed.`)}}));const a=JSON.stringify(r);v(da,`RPC '${t}' ${i} sending request:`,r),c.send(e,"POST",a,n,15)}))}Fo(t,e,n){const r=ca(),i=[this.fo,"/","google.firestore.v1.Firestore","/",t,"/channel"],s=Object(l.i)(),o=Object(l.j)(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},a=this.longPollingOptions.timeoutSeconds;void 0!==a&&(c.longPollingTimeout=Math.round(1e3*a)),this.useFetchStreams&&(c.useFetchStreams=!0),this.Do(c.initMessageHeaders,e,n),c.encodeInitMessageHeaders=!0;const u=i.join("");v(da,`Creating RPC '${t}' stream ${r}: ${u}`,c);const h=s.createWebChannel(u,c);let d=!1,f=!1;const m=new la({lo:e=>{f?v(da,`Not sending because RPC '${t}' stream ${r} is closed:`,e):(d||(v(da,`Opening RPC '${t}' stream ${r} transport.`),h.open(),d=!0),v(da,`RPC '${t}' stream ${r} sending:`,e),h.send(e))},ho:()=>h.close()}),y=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return y(h,l.g.EventType.OPEN,(()=>{f||v(da,`RPC '${t}' stream ${r} transport opened.`)})),y(h,l.g.EventType.CLOSE,(()=>{f||(f=!0,v(da,`RPC '${t}' stream ${r} transport closed`),m.Vo())})),y(h,l.g.EventType.ERROR,(e=>{f||(f=!0,I(da,`RPC '${t}' stream ${r} transport errored:`,e),m.Vo(new A(D.UNAVAILABLE,"The operation could not be completed")))})),y(h,l.g.EventType.MESSAGE,(e=>{var n;if(!f){const i=e.data[0];S(!!i);const s=i,o=s.error||(null===(n=s[0])||void 0===n?void 0:n.error);if(o){v(da,`RPC '${t}' stream ${r} received error:`,o);const e=o.status;let n=function(t){const e=Gr[t];if(void 0!==e)return $r(e)}(e),i=o.message;void 0===n&&(n=D.INTERNAL,i="Unknown error status: "+e+" with message "+o.message),f=!0,m.Vo(new A(n,i)),h.close()}else v(da,`RPC '${t}' stream ${r} received:`,i),m.mo(i)}})),y(o,l.b.STAT_EVENT,(e=>{e.stat===l.f.PROXY?v(da,`RPC '${t}' stream ${r} detected buffering proxy`):e.stat===l.f.NOPROXY&&v(da,`RPC '${t}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{m.Ro()}),0),m}}function ma(){return"undefined"!=typeof window?window:null}function ga(){return"undefined"!=typeof document?document:null}function pa(t){return new ds(t,!0)}class ya{constructor(t,e,n=1e3,r=1.5,i=6e4){this.oi=t,this.timerId=e,this.Mo=n,this.xo=r,this.Oo=i,this.No=0,this.Lo=null,this.Bo=Date.now(),this.reset()}reset(){this.No=0}ko(){this.No=this.Oo}qo(t){this.cancel();const e=Math.floor(this.No+this.Qo()),n=Math.max(0,Date.now()-this.Bo),r=Math.max(0,e-n);r>0&&v("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.No} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Lo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Bo=Date.now(),t()))),this.No*=this.xo,this.No<this.Mo&&(this.No=this.Mo),this.No>this.Oo&&(this.No=this.Oo)}Ko(){null!==this.Lo&&(this.Lo.skipDelay(),this.Lo=null)}cancel(){null!==this.Lo&&(this.Lo.cancel(),this.Lo=null)}Qo(){return(Math.random()-.5)*this.No}}class wa{constructor(t,e,n,r,i,s,o,c){this.oi=t,this.$o=n,this.Uo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=o,this.listener=c,this.state=0,this.Wo=0,this.Go=null,this.zo=null,this.stream=null,this.jo=new ya(t,e)}Ho(){return 1===this.state||5===this.state||this.Jo()}Jo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Yo()}async stop(){this.Ho()&&await this.close(0)}Zo(){this.state=0,this.jo.reset()}Xo(){this.Jo()&&null===this.Go&&(this.Go=this.oi.enqueueAfterDelay(this.$o,6e4,(()=>this.e_())))}t_(t){this.n_(),this.stream.send(t)}async e_(){if(this.Jo())return this.close(0)}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}async close(t,e){this.n_(),this.r_(),this.jo.cancel(),this.Wo++,4!==t?this.jo.reset():e&&e.code===D.RESOURCE_EXHAUSTED?(_(e.toString()),_("Using maximum backoff delay to prevent overloading the backend."),this.jo.ko()):e&&e.code===D.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.i_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.To(e)}i_(){}auth(){this.state=1;const t=this.s_(this.Wo),e=this.Wo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Wo===e&&this.o_(t,n)}),(e=>{t((()=>{const t=new A(D.UNKNOWN,"Fetching auth token failed: "+e.message);return this.__(t)}))}))}o_(t,e){const n=this.s_(this.Wo);this.stream=this.a_(t,e),this.stream.Po((()=>{n((()=>(this.state=2,this.zo=this.oi.enqueueAfterDelay(this.Uo,1e4,(()=>(this.Jo()&&(this.state=3),Promise.resolve()))),this.listener.Po())))})),this.stream.To((t=>{n((()=>this.__(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Yo(){this.state=5,this.jo.qo((async()=>{this.state=0,this.start()}))}__(t){return v("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}s_(t){return e=>{this.oi.enqueueAndForget((()=>this.Wo===t?e():(v("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class va extends wa{constructor(t,e,n,r,i,s){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,s),this.serializer=i}a_(t,e){return this.connection.Fo("Listen",t,e)}onMessage(t){this.jo.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:T()}(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],s=function(t,e){return t.useProto3Json?(S(void 0===e||"string"==typeof e),me.fromBase64String(e||"")):(S(void 0===e||e instanceof Uint8Array),me.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,c=o&&function(t){const e=void 0===t.code?D.UNKNOWN:$r(t.code);return new A(e,t.message||"")}(o);n=new ss(r,i,s,c||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const i=Is(t,r.document.name),s=ys(r.document.updateTime),o=r.document.createTime?ys(r.document.createTime):$.min(),c=new Ke({mapValue:{fields:r.document.fields}}),a=Qe.newFoundDocument(i,s,o,c),u=r.targetIds||[],h=r.removedTargetIds||[];n=new ns(u,h,a.key,a)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const i=Is(t,r.document),s=r.readTime?ys(r.readTime):$.min(),o=Qe.newNoDocument(i,s),c=r.removedTargetIds||[];n=new ns([],c,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const i=Is(t,r.document),s=r.removedTargetIds||[];n=new ns([],s,i,null)}else{if(!("filter"in e))return T();{e.filter;const t=e.filter;t.targetId;const{count:r=0,unchangedNames:i}=t,s=new Br(r,i),o=t.targetId;n=new rs(o,s)}}return n}(this.serializer,t),n=function(t){if(!("targetChange"in t))return $.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?$.min():e.readTime?ys(e.readTime):$.min()}(t);return this.listener.u_(e,n)}c_(t){const e={};e.database=Ss(this.serializer),e.addTarget=function(t,e){let n;const r=e.target;if(n=En(r)?{documents:ks(t,r)}:{query:Os(t,r).ut},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0){n.resumeToken=gs(t,e.resumeToken);const r=fs(t,e.expectedCount);null!==r&&(n.expectedCount=r)}else if(e.snapshotVersion.compareTo($.min())>0){n.readTime=ms(t,e.snapshotVersion.toTimestamp());const r=fs(t,e.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,t);const n=function(t,e){const n=function(t){switch(t){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return T()}}(e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,t);n&&(e.labels=n),this.t_(e)}l_(t){const e={};e.database=Ss(this.serializer),e.removeTarget=t,this.t_(e)}}class ba extends wa{constructor(t,e,n,r,i,s){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,s),this.serializer=i,this.h_=!1}get P_(){return this.h_}start(){this.h_=!1,this.lastStreamToken=void 0,super.start()}i_(){this.h_&&this.I_([])}a_(t,e){return this.connection.Fo("Write",t,e)}onMessage(t){if(S(!!t.streamToken),this.lastStreamToken=t.streamToken,this.h_){this.jo.reset();const e=function(t,e){return t&&t.length>0?(S(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?ys(t.updateTime):ys(e);return n.isEqual($.min())&&(n=ys(e)),new Er(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=ys(t.commitTime);return this.listener.T_(n,e)}return S(!t.writeResults||0===t.writeResults.length),this.h_=!0,this.listener.E_()}d_(){const t={};t.database=Ss(this.serializer),this.t_(t)}I_(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>As(this.serializer,t)))};this.t_(e)}}class _a extends class{}{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=r,this.A_=!1}R_(){if(this.A_)throw new A(D.FAILED_PRECONDITION,"The client has already been terminated.")}So(t,e,n,r){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,s])=>this.connection.So(t,vs(e,n),r,i,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===D.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new A(D.UNKNOWN,t.toString())}))}vo(t,e,n,r,i){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,o])=>this.connection.vo(t,vs(e,n),r,s,o,i))).catch((t=>{throw"FirebaseError"===t.name?(t.code===D.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new A(D.UNKNOWN,t.toString())}))}terminate(){this.A_=!0,this.connection.terminate()}}class Ia{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.m_=0,this.f_=null,this.g_=!0}p_(){0===this.m_&&(this.y_("Unknown"),this.f_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.f_=null,this.w_("Backend didn't respond within 10 seconds."),this.y_("Offline"),Promise.resolve()))))}S_(t){"Online"===this.state?this.y_("Unknown"):(this.m_++,this.m_>=1&&(this.b_(),this.w_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.y_("Offline")))}set(t){this.b_(),this.m_=0,"Online"===t&&(this.g_=!1),this.y_(t)}y_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}w_(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.g_?(_(e),this.g_=!1):v("OnlineStateTracker",e)}b_(){null!==this.f_&&(this.f_.cancel(),this.f_=null)}}class Ea{constructor(t,e,n,r,i){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.D_=[],this.C_=new Map,this.v_=new Set,this.F_=[],this.M_=i,this.M_.io((t=>{n.enqueueAndForget((async()=>{Oa(this)&&(v("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=C(t);e.v_.add(4),await Sa(e),e.x_.set("Unknown"),e.v_.delete(4),await Ta(e)}(this))}))})),this.x_=new Ia(n,r)}}async function Ta(t){if(Oa(t))for(const e of t.F_)await e(!0)}async function Sa(t){for(const e of t.F_)await e(!1)}function xa(t,e){const n=C(t);n.C_.has(e.targetId)||(n.C_.set(e.targetId,e),ka(n)?Na(n):Ya(n).Jo()&&Da(n,e))}function Ca(t,e){const n=C(t),r=Ya(n);n.C_.delete(e),r.Jo()&&Aa(n,e),0===n.C_.size&&(r.Jo()?r.Xo():Oa(n)&&n.x_.set("Unknown"))}function Da(t,e){if(t.O_.Oe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo($.min())>0){const n=t.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(n)}Ya(t).c_(e)}function Aa(t,e){t.O_.Oe(e),Ya(t).l_(e)}function Na(t){t.O_=new os({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),_t:e=>t.C_.get(e)||null,nt:()=>t.datastore.serializer.databaseId}),Ya(t).start(),t.x_.p_()}function ka(t){return Oa(t)&&!Ya(t).Ho()&&t.C_.size>0}function Oa(t){return 0===C(t).v_.size}function Ra(t){t.O_=void 0}async function Ma(t){t.C_.forEach(((e,n)=>{Da(t,e)}))}async function Pa(t,e){Ra(t),ka(t)?(t.x_.S_(e),Na(t)):t.x_.set("Unknown")}async function Fa(t,e,n){if(t.x_.set("Online"),e instanceof ss&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.C_.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.C_.delete(r),t.O_.removeTarget(r))}(t,e)}catch(n){v("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await La(t,n)}else if(e instanceof ns?t.O_.$e(e):e instanceof rs?t.O_.Je(e):t.O_.Ge(e),!n.isEqual($.min()))try{const e=await jo(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.O_.it(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const i=t.C_.get(r);i&&t.C_.set(r,i.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach(((e,n)=>{const r=t.C_.get(e);if(!r)return;t.C_.set(e,r.withResumeToken(me.EMPTY_BYTE_STRING,r.snapshotVersion)),Aa(t,e);const i=new Gs(r.target,e,n,r.sequenceNumber);Da(t,i)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){v("RemoteStore","Failed to raise snapshot:",e),await La(t,e)}}async function La(t,e,n){if(!yt(e))throw e;t.v_.add(1),await Sa(t),t.x_.set("Offline"),n||(n=()=>jo(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{v("RemoteStore","Retrying IndexedDB access"),await n(),t.v_.delete(1),await Ta(t)}))}function Va(t,e){return e().catch((n=>La(t,n,e)))}async function qa(t){const e=C(t),n=Xa(e);let r=e.D_.length>0?e.D_[e.D_.length-1].batchId:-1;for(;ja(e);)try{const t=await Bo(e.localStore,r);if(null===t){0===e.D_.length&&n.Xo();break}r=t.batchId,Ua(e,t)}catch(t){await La(e,t)}Ba(e)&&Ga(e)}function ja(t){return Oa(t)&&t.D_.length<10}function Ua(t,e){t.D_.push(e);const n=Xa(t);n.Jo()&&n.P_&&n.I_(e.mutations)}function Ba(t){return Oa(t)&&!Xa(t).Ho()&&t.D_.length>0}function Ga(t){Xa(t).start()}async function za(t){Xa(t).d_()}async function Ka(t){const e=Xa(t);for(const n of t.D_)e.I_(n.mutations)}async function $a(t,e,n){const r=t.D_.shift(),i=jr.from(r,e,n);await Va(t,(()=>t.remoteSyncer.applySuccessfulWrite(i))),await qa(t)}async function Qa(t,e){e&&Xa(t).P_&&await async function(t,e){if(function(t){return Kr(t)&&t!==D.ABORTED}(e.code)){const n=t.D_.shift();Xa(t).Zo(),await Va(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await qa(t)}}(t,e),Ba(t)&&Ga(t)}async function Wa(t,e){const n=C(t);n.asyncQueue.verifyOperationInProgress(),v("RemoteStore","RemoteStore received new credentials");const r=Oa(n);n.v_.add(3),await Sa(n),r&&n.x_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.v_.delete(3),await Ta(n)}async function Ha(t,e){const n=C(t);e?(n.v_.delete(2),await Ta(n)):e||(n.v_.add(2),await Sa(n),n.x_.set("Unknown"))}function Ya(t){return t.N_||(t.N_=function(t,e,n){const r=C(t);return r.R_(),new va(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Po:Ma.bind(null,t),To:Pa.bind(null,t),u_:Fa.bind(null,t)}),t.F_.push((async e=>{e?(t.N_.Zo(),ka(t)?Na(t):t.x_.set("Unknown")):(await t.N_.stop(),Ra(t))}))),t.N_}function Xa(t){return t.L_||(t.L_=function(t,e,n){const r=C(t);return r.R_(),new ba(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Po:za.bind(null,t),To:Qa.bind(null,t),E_:Ka.bind(null,t),T_:$a.bind(null,t)}),t.F_.push((async e=>{e?(t.L_.Zo(),await qa(t)):(await t.L_.stop(),t.D_.length>0&&(v("RemoteStore",`Stopping write stream with ${t.D_.length} pending writes`),t.D_=[]))}))),t.L_}class Ja{constructor(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new N,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,r,i){const s=Date.now()+n,o=new Ja(t,e,s,r,i);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new A(D.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Za(t,e){if(_("AsyncQueue",`${e}: ${t}`),yt(t))return new A(D.UNAVAILABLE,`${e}: ${t}`);throw t}class tu{constructor(t){this.comparator=t?(e,n)=>t(e,n)||X.comparator(e.key,n.key):(t,e)=>X.comparator(t.key,e.key),this.keyedMap=Wn(),this.sortedSet=new ie(this.comparator)}static emptySet(t){return new tu(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof tu))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new tu;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class eu{constructor(){this.B_=new ie(X.comparator)}track(t){const e=t.doc.key,n=this.B_.get(e);n?0!==t.type&&3===n.type?this.B_=this.B_.insert(e,t):3===t.type&&1!==n.type?this.B_=this.B_.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.B_=this.B_.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.B_=this.B_.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.B_=this.B_.remove(e):1===t.type&&2===n.type?this.B_=this.B_.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.B_=this.B_.insert(e,{type:2,doc:t.doc}):T():this.B_=this.B_.insert(e,t)}k_(){const t=[];return this.B_.inorderTraversal(((e,n)=>{t.push(n)})),t}}class nu{constructor(t,e,n,r,i,s,o,c,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=o,this.excludesMetadataChanges=c,this.hasCachedResults=a}static fromInitialDocuments(t,e,n,r,i){const s=[];return e.forEach((t=>{s.push({type:0,doc:t})})),new nu(t,e,tu.emptySet(e),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ln(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class ru{constructor(){this.q_=void 0,this.Q_=[]}K_(){return this.Q_.some((t=>t.U_()))}}class su{constructor(){this.queries=new zn((t=>Vn(t)),Ln),this.onlineState="Unknown",this.W_=new Set}}async function iu(t,e){const n=C(t);let r=3;const i=e.query;let s=n.queries.get(i);s?!s.K_()&&e.U_()&&(r=2):(s=new ru,r=e.U_()?0:1);try{switch(r){case 0:s.q_=await n.onListen(i,!0);break;case 1:s.q_=await n.onListen(i,!1);break;case 2:await n.onFirstRemoteStoreListen(i)}}catch(t){const n=Za(t,`Initialization of query '${qn(e.query)}' failed`);return void e.onError(n)}n.queries.set(i,s),s.Q_.push(e),e.G_(n.onlineState),s.q_&&e.z_(s.q_)&&cu(n)}async function ou(t,e){const n=C(t),r=e.query;let i=3;const s=n.queries.get(r);if(s){const t=s.Q_.indexOf(e);t>=0&&(s.Q_.splice(t,1),0===s.Q_.length?i=e.U_()?0:1:!s.K_()&&e.U_()&&(i=2))}switch(i){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function au(t,e){const n=C(t);let r=!1;for(const t of e){const e=t.query,i=n.queries.get(e);if(i){for(const e of i.Q_)e.z_(t)&&(r=!0);i.q_=t}}r&&cu(n)}function uu(t,e,n){const r=C(t),i=r.queries.get(e);if(i)for(const t of i.Q_)t.onError(n);r.queries.delete(e)}function cu(t){t.W_.forEach((t=>{t.next()}))}var hu,lu;(lu=hu||(hu={})).j_="default",lu.Cache="cache";class du{constructor(t,e,n){this.query=t,this.H_=e,this.J_=!1,this.Y_=null,this.onlineState="Unknown",this.options=n||{}}z_(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new nu(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.J_?this.Z_(t)&&(this.H_.next(t),e=!0):this.X_(t,this.onlineState)&&(this.ea(t),e=!0),this.Y_=t,e}onError(t){this.H_.error(t)}G_(t){this.onlineState=t;let e=!1;return this.Y_&&!this.J_&&this.X_(this.Y_,t)&&(this.ea(this.Y_),e=!0),e}X_(t,e){if(!t.fromCache)return!0;if(!this.U_())return!0;const n="Offline"!==e;return(!this.options.ta||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||"Offline"===e)}Z_(t){if(t.docChanges.length>0)return!0;const e=this.Y_&&this.Y_.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}ea(t){t=nu.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.J_=!0,this.H_.next(t)}U_(){return this.options.source!==hu.Cache}}class fu{constructor(t,e){this.na=t,this.byteLength=e}ra(){return"metadata"in this.na}}class mu{constructor(t){this.serializer=t}Ps(t){return Is(this.serializer,t)}Is(t){return t.metadata.exists?Ds(this.serializer,t.document,!1):Qe.newNoDocument(this.Ps(t.metadata.name),this.Ts(t.metadata.readTime))}Ts(t){return ys(t)}}class gu{constructor(t,e,n){this.ia=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=pu(t)}sa(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.na.namedQuery)this.queries.push(t.na.namedQuery);else if(t.na.documentMetadata){this.documents.push({metadata:t.na.documentMetadata}),t.na.documentMetadata.exists||++e;const n=W.fromString(t.na.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.na.document&&(this.documents[this.documents.length-1].document=t.na.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}oa(t){const e=new Map,n=new mu(this.serializer);for(const r of t)if(r.metadata.queries){const t=n.Ps(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||nr()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const i=C(t);let s=nr(),o=$n();for(const t of n){const n=e.Ps(t.metadata.name);t.document&&(s=s.add(n));const r=e.Is(t);r.setReadTime(e.Ts(t.metadata.readTime)),o=o.insert(n,r)}const c=i.os.newChangeBuffer({trackRemovals:!0}),a=await Go(i,function(t){return Rn(An(W.fromString(`__bundle__/docs/${t}`)))}(r));return i.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Uo(t,c,o).next((e=>(c.apply(t),e))).next((e=>i.Qr.removeMatchingKeysForTargetId(t,a.targetId).next((()=>i.Qr.addMatchingKeys(t,s,a.targetId))).next((()=>i.localDocuments.getLocalViewOfDocuments(t,e.cs,e.ls))).next((()=>e.cs))))))}(this.localStore,new mu(this.serializer),this.documents,this.ia.id),e=this.oa(this.documents);for(const t of this.queries)await Ho(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,_a:this.collectionGroups,aa:t}}}function pu(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class yu{constructor(t){this.key=t}}class wu{constructor(t){this.key=t}}class vu{constructor(t,e){this.query=t,this.ua=e,this.ca=null,this.hasCachedResults=!1,this.current=!1,this.la=nr(),this.mutatedKeys=nr(),this.ha=Bn(t),this.Pa=new tu(this.ha)}get Ia(){return this.ua}Ta(t,e){const n=e?e.Ea:new eu,r=e?e.Pa:this.Pa;let i=e?e.mutatedKeys:this.mutatedKeys,s=r,o=!1;const c="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,a="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const u=r.get(t),h=jn(this.query,e)?e:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.da(u,h)||(n.track({type:2,doc:h}),f=!0,(c&&this.ha(h,c)>0||a&&this.ha(h,a)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(c||a)&&(o=!0)),f&&(h?(s=s.add(h),i=d?i.add(t):i.delete(t)):(s=s.delete(t),i=i.delete(t)))})),null!==this.query.limit)for(;s.size>this.query.limit;){const t="F"===this.query.limitType?s.last():s.first();s=s.delete(t.key),i=i.delete(t.key),n.track({type:1,doc:t})}return{Pa:s,Ea:n,Xi:o,mutatedKeys:i}}da(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n,r){const i=this.Pa;this.Pa=t.Pa,this.mutatedKeys=t.mutatedKeys;const s=t.Ea.k_();s.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return T()}};return n(t)-n(e)}(t.type,e.type)||this.ha(t.doc,e.doc))),this.Aa(n),r=null!=r&&r;const o=e&&!r?this.Ra():[],c=0===this.la.size&&this.current&&!r?1:0,a=c!==this.ca;return this.ca=c,0!==s.length||a?{snapshot:new nu(this.query,t.Pa,i,s,t.mutatedKeys,0===c,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),Va:o}:{Va:o}}G_(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Pa:this.Pa,Ea:new eu,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{Va:[]}}ma(t){return!this.ua.has(t)&&!!this.Pa.has(t)&&!this.Pa.get(t).hasLocalMutations}Aa(t){t&&(t.addedDocuments.forEach((t=>this.ua=this.ua.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.ua=this.ua.delete(t))),this.current=t.current)}Ra(){if(!this.current)return[];const t=this.la;this.la=nr(),this.Pa.forEach((t=>{this.ma(t.key)&&(this.la=this.la.add(t.key))}));const e=[];return t.forEach((t=>{this.la.has(t)||e.push(new wu(t))})),this.la.forEach((n=>{t.has(n)||e.push(new yu(n))})),e}fa(t){this.ua=t.hs,this.la=nr();const e=this.Ta(t.documents);return this.applyChanges(e,!0)}ga(){return nu.fromInitialDocuments(this.query,this.Pa,this.mutatedKeys,0===this.ca,this.hasCachedResults)}}class bu{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class _u{constructor(t){this.key=t,this.pa=!1}}class Iu{constructor(t,e,n,r,i,s){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.ya={},this.wa=new zn((t=>Vn(t)),Ln),this.Sa=new Map,this.ba=new Set,this.Da=new ie(X.comparator),this.Ca=new Map,this.va=new wo,this.Fa={},this.Ma=new Map,this.xa=$i.Ln(),this.onlineState="Unknown",this.Oa=void 0}get isPrimaryClient(){return!0===this.Oa}}async function Eu(t,e,n=!0){const r=Ju(t);let i;const s=r.wa.get(e);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ga()):i=await Su(r,e,n,!0),i}async function Tu(t,e){const n=Ju(t);await Su(n,e,!0,!1)}async function Su(t,e,n,r){const i=await Go(t.localStore,Rn(e)),s=i.targetId,o=n?t.sharedClientState.addLocalQueryTarget(s):"not-current";let c;return r&&(c=await xu(t,e,s,"current"===o,i.resumeToken)),t.isPrimaryClient&&n&&xa(t.remoteStore,i),c}async function xu(t,e,n,r,i){t.Na=(e,n,r)=>async function(t,e,n,r){let i=e.view.Ta(n);i.Xi&&(i=await Ko(t.localStore,e.query,!1).then((({documents:t})=>e.view.Ta(t,i))));const s=r&&r.targetChanges.get(e.targetId),o=r&&null!=r.targetMismatches.get(e.targetId),c=e.view.applyChanges(i,t.isPrimaryClient,s,o);return Vu(t,e.targetId,c.Va),c.snapshot}(t,e,n,r);const s=await Ko(t.localStore,e,!0),o=new vu(e,s.hs),c=o.Ta(s.documents),a=es.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState,i),u=o.applyChanges(c,t.isPrimaryClient,a);Vu(t,n,u.Va);const h=new bu(e,n,o);return t.wa.set(e,h),t.Sa.has(n)?t.Sa.get(n).push(e):t.Sa.set(n,[e]),u.snapshot}async function Cu(t,e,n){const r=C(t),i=r.wa.get(e),s=r.Sa.get(i.targetId);if(s.length>1)return r.Sa.set(i.targetId,s.filter((t=>!Ln(t,e)))),void r.wa.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||await zo(r.localStore,i.targetId,!1).then((()=>{r.sharedClientState.clearQueryState(i.targetId),n&&Ca(r.remoteStore,i.targetId),Fu(r,i.targetId)})).catch(ht)):(Fu(r,i.targetId),await zo(r.localStore,i.targetId,!0))}async function Du(t,e){const n=C(t),r=n.wa.get(e),i=n.Sa.get(r.targetId);n.isPrimaryClient&&1===i.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),Ca(n.remoteStore,r.targetId))}async function Au(t,e){const n=C(t);try{const t=await function(t,e){const n=C(t),r=e.snapshotVersion;let i=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const s=n.os.newChangeBuffer({trackRemovals:!0});i=n.ns;const o=[];e.targetChanges.forEach(((s,c)=>{const a=i.get(c);if(!a)return;o.push(n.Qr.removeMatchingKeys(t,s.removedDocuments,c).next((()=>n.Qr.addMatchingKeys(t,s.addedDocuments,c))));let u=a.withSequenceNumber(t.currentSequenceNumber);null!==e.targetMismatches.get(c)?u=u.withResumeToken(me.EMPTY_BYTE_STRING,$.min()).withLastLimboFreeSnapshotVersion($.min()):s.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(s.resumeToken,r)),i=i.insert(c,u),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(a,u,s)&&o.push(n.Qr.updateTargetData(t,u))}));let c=$n(),a=nr();if(e.documentUpdates.forEach((r=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(Uo(t,s,e.documentUpdates).next((t=>{c=t.cs,a=t.ls}))),!r.isEqual($.min())){const e=n.Qr.getLastRemoteSnapshotVersion(t).next((e=>n.Qr.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return lt.waitFor(o).next((()=>s.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,c,a))).next((()=>c))})).then((t=>(n.ns=i,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.Ca.get(e);r&&(S(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.pa=!0:t.modifiedDocuments.size>0?S(r.pa):t.removedDocuments.size>0&&(S(r.pa),r.pa=!1))})),await Uu(n,t,e)}catch(t){await ht(t)}}function Nu(t,e,n){const r=C(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.wa.forEach(((n,r)=>{const i=r.view.G_(e);i.snapshot&&t.push(i.snapshot)})),function(t,e){const n=C(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const t of n.Q_)t.G_(e)&&(r=!0)})),r&&cu(n)}(r.eventManager,e),t.length&&r.ya.u_(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function ku(t,e,n){const r=C(t);r.sharedClientState.updateQueryState(e,"rejected",n);const i=r.Ca.get(e),s=i&&i.key;if(s){let t=new ie(X.comparator);t=t.insert(s,Qe.newNoDocument(s,$.min()));const n=nr().add(s),i=new ts($.min(),new Map,new ie(B),t,n);await Au(r,i),r.Da=r.Da.remove(s),r.Ca.delete(e),ju(r)}else await zo(r.localStore,e,!1).then((()=>Fu(r,e,n))).catch(ht)}async function Ou(t,e){const n=C(t),r=e.batch.batchId;try{const t=await function(t,e){const n=C(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),i=n.os.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const i=n.batch,s=i.keys();let o=lt.resolve();return s.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const s=n.docVersions.get(t);S(null!==s),e.version.compareTo(s)<0&&(i.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),r.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,i)))}(n,t,e,i).next((()=>i.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=nr();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(n.localStore,e);Pu(n,r,null),Mu(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Uu(n,t)}catch(t){await ht(t)}}async function Ru(t,e,n){const r=C(t);try{const t=await function(t,e){const n=C(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(S(null!==e),r=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,r))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(r.localStore,e);Pu(r,e,n),Mu(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await Uu(r,t)}catch(n){await ht(n)}}function Mu(t,e){(t.Ma.get(e)||[]).forEach((t=>{t.resolve()})),t.Ma.delete(e)}function Pu(t,e,n){const r=C(t);let i=r.Fa[r.currentUser.toKey()];if(i){const t=i.get(e);t&&(n?t.reject(n):t.resolve(),i=i.remove(e)),r.Fa[r.currentUser.toKey()]=i}}function Fu(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.Sa.get(e))t.wa.delete(r),n&&t.ya.La(r,n);t.Sa.delete(e),t.isPrimaryClient&&t.va.Vr(e).forEach((e=>{t.va.containsKey(e)||Lu(t,e)}))}function Lu(t,e){t.ba.delete(e.path.canonicalString());const n=t.Da.get(e);null!==n&&(Ca(t.remoteStore,n),t.Da=t.Da.remove(e),t.Ca.delete(n),ju(t))}function Vu(t,e,n){for(const r of n)r instanceof yu?(t.va.addReference(r.key,e),qu(t,r)):r instanceof wu?(v("SyncEngine","Document no longer in limbo: "+r.key),t.va.removeReference(r.key,e),t.va.containsKey(r.key)||Lu(t,r.key)):T()}function qu(t,e){const n=e.key,r=n.path.canonicalString();t.Da.get(n)||t.ba.has(r)||(v("SyncEngine","New document in limbo: "+n),t.ba.add(r),ju(t))}function ju(t){for(;t.ba.size>0&&t.Da.size<t.maxConcurrentLimboResolutions;){const e=t.ba.values().next().value;t.ba.delete(e);const n=new X(W.fromString(e)),r=t.xa.next();t.Ca.set(r,new _u(n)),t.Da=t.Da.insert(n,r),xa(t.remoteStore,new Gs(Rn(An(n.path)),r,"TargetPurposeLimboResolution",Tt._e))}}async function Uu(t,e,n){const r=C(t),i=[],s=[],o=[];r.wa.isEmpty()||(r.wa.forEach(((t,c)=>{o.push(r.Na(c,e,n).then((t=>{if((t||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(c.targetId,(null==t?void 0:t.fromCache)?"not-current":"current"),t){i.push(t);const e=Mo.Ki(c.targetId,t);s.push(e)}})))})),await Promise.all(o),r.ya.u_(i),await async function(t,e){const n=C(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>lt.forEach(e,(e=>lt.forEach(e.qi,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>lt.forEach(e.Qi,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!yt(t))throw t;v("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.ns.get(e),r=t.snapshotVersion,i=t.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(e,i)}}}(r.localStore,s))}async function Bu(t,e){const n=C(t);if(!n.currentUser.isEqual(e)){v("SyncEngine","User change. New user:",e.toKey());const t=await qo(n.localStore,e);n.currentUser=e,function(t,e){t.Ma.forEach((t=>{t.forEach((t=>{t.reject(new A(D.CANCELLED,e))}))})),t.Ma.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Uu(n,t.us)}}function Gu(t,e){const n=C(t),r=n.Ca.get(e);if(r&&r.pa)return nr().add(r.key);{let t=nr();const r=n.Sa.get(e);if(!r)return t;for(const e of r){const r=n.wa.get(e);t=t.unionWith(r.view.Ia)}return t}}async function zu(t,e){const n=C(t),r=await Ko(n.localStore,e.query,!0),i=e.view.fa(r);return n.isPrimaryClient&&Vu(n,e.targetId,i.Va),i}async function Ku(t,e){const n=C(t);return Qo(n.localStore,e).then((t=>Uu(n,t)))}async function $u(t,e,n,r){const i=C(t),s=await function(t,e){const n=C(t),r=C(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.vn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):lt.resolve(null)))))}(i.localStore,e);null!==s?("pending"===n?await qa(i.remoteStore):"acknowledged"===n||"rejected"===n?(Pu(i,e,r||null),Mu(i,e),function(t,e){C(C(t).mutationQueue).Mn(e)}(i.localStore,e)):T(),await Uu(i,s)):v("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Qu(t,e,n){const r=C(t),i=[],s=[];for(const t of e){let e;const n=r.Sa.get(t);if(n&&0!==n.length){e=await Go(r.localStore,Rn(n[0]));for(const t of n){const e=r.wa.get(t),n=await zu(r,e);n.snapshot&&s.push(n.snapshot)}}else{const n=await $o(r.localStore,t);e=await Go(r.localStore,n),await xu(r,Wu(n),t,!1,e.resumeToken)}i.push(e)}return r.ya.u_(s),i}function Wu(t){return Dn(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Hu(t){return function(t){return C(C(t).persistence).Bi()}(C(t).localStore)}async function Yu(t,e,n,r){const i=C(t);if(i.Oa)return void v("SyncEngine","Ignoring unexpected query state notification.");const s=i.Sa.get(e);if(s&&s.length>0)switch(n){case"current":case"not-current":{const t=await Qo(i.localStore,Un(s[0])),r=ts.createSynthesizedRemoteEventForCurrentChange(e,"current"===n,me.EMPTY_BYTE_STRING);await Uu(i,t,r);break}case"rejected":await zo(i.localStore,e,!0),Fu(i,e,r);break;default:T()}}async function Xu(t,e,n){const r=Ju(t);if(r.Oa){for(const t of e){if(r.Sa.has(t)&&r.sharedClientState.isActiveQueryTarget(t)){v("SyncEngine","Adding an already active target "+t);continue}const e=await $o(r.localStore,t),n=await Go(r.localStore,e);await xu(r,Wu(e),n.targetId,!1,n.resumeToken),xa(r.remoteStore,n)}for(const t of n)r.Sa.has(t)&&await zo(r.localStore,t,!1).then((()=>{Ca(r.remoteStore,t),Fu(r,t)})).catch(ht)}}function Ju(t){const e=C(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Au.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Gu.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=ku.bind(null,e),e.ya.u_=au.bind(null,e.eventManager),e.ya.La=uu.bind(null,e.eventManager),e}function Zu(t){const e=C(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Ou.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Ru.bind(null,e),e}class tc{constructor(){this.synchronizeTabs=!1}async initialize(t){this.serializer=pa(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),await this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return Vo(this.persistence,new Fo,t.initialUser,this.serializer)}createPersistence(t){return new To(xo.Hr,this.serializer)}createSharedClientState(t){return new ia}async terminate(){var t,e;null===(t=this.gcScheduler)||void 0===t||t.stop(),null===(e=this.indexBackfillerScheduler)||void 0===e||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ec extends tc{constructor(t,e,n){super(),this.ka=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.ka.initialize(this,t),await Zu(this.ka.syncEngine),await qa(this.ka.remoteStore),await this.persistence.fi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(t){return Vo(this.persistence,new Fo,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new Zi(n,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){const n=new Et(e,this.persistence);return new It(t.asyncQueue,n)}createPersistence(t){const e=Ro(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Vi.withCacheSize(this.cacheSizeBytes):Vi.DEFAULT;return new No(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,ma(),ga(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new ia}}class nc extends ec{constructor(t,e){super(t,e,!1),this.ka=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.ka.syncEngine;this.sharedClientState instanceof sa&&(this.sharedClientState.syncEngine={Zs:$u.bind(null,e),Xs:Yu.bind(null,e),eo:Xu.bind(null,e),Bi:Hu.bind(null,e),Ys:Ku.bind(null,e)},await this.sharedClientState.start()),await this.persistence.fi((async t=>{await async function(t,e){const n=C(t);if(Ju(n),Zu(n),!0===e&&!0!==n.Oa){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Qu(n,t.toArray());n.Oa=!0,await Ha(n.remoteStore,!0);for(const t of e)xa(n.remoteStore,t)}else if(!1===e&&!1!==n.Oa){const t=[];let e=Promise.resolve();n.Sa.forEach(((r,i)=>{n.sharedClientState.isLocalQueryTarget(i)?t.push(i):e=e.then((()=>(Fu(n,i),zo(n.localStore,i,!0)))),Ca(n.remoteStore,i)})),await e,await Qu(n,t),function(t){const e=C(t);e.Ca.forEach(((t,n)=>{Ca(e.remoteStore,n)})),e.va.mr(),e.Ca=new Map,e.Da=new ie(X.comparator)}(n),n.Oa=!1,await Ha(n.remoteStore,!1)}}(this.ka.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}createSharedClientState(t){const e=ma();if(!sa.D(e))throw new A(D.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Ro(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new sa(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class rc{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Nu(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=Bu.bind(null,this.syncEngine),await Ha(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new su}createDatastore(t){const e=pa(t.databaseInfo.databaseId),n=function(t){return new fa(t)}(t.databaseInfo);return function(t,e,n,r){return new _a(t,e,n,r)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return function(t,e,n,r,i){return new Ea(t,e,n,r,i)}(this.localStore,this.datastore,t.asyncQueue,(t=>Nu(this.syncEngine,t,0)),aa.D()?new aa:new oa)}createSyncEngine(t,e){return function(t,e,n,r,i,s,o){const c=new Iu(t,e,n,r,i,s);return o&&(c.Oa=!0),c}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t;await async function(t){const e=C(t);v("RemoteStore","RemoteStore shutting down."),e.v_.add(5),await Sa(e),e.M_.shutdown(),e.x_.set("Unknown")}(this.remoteStore),null===(t=this.datastore)||void 0===t||t.terminate()}}function sc(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class ic{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.qa(this.observer.next,t)}error(t){this.observer.error?this.qa(this.observer.error,t):_("Uncaught Error in snapshot listener:",t.toString())}Qa(){this.muted=!0}qa(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class oc{constructor(t,e){this.Ka=t,this.serializer=e,this.metadata=new N,this.buffer=new Uint8Array,this.$a=new TextDecoder("utf-8"),this.Ua().then((t=>{t&&t.ra()?this.metadata.resolve(t.na.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.na)}`))}),(t=>this.metadata.reject(t)))}close(){return this.Ka.cancel()}async getMetadata(){return this.metadata.promise}async Ba(){return await this.getMetadata(),this.Ua()}async Ua(){const t=await this.Wa();if(null===t)return null;const e=this.$a.decode(t),n=Number(e);isNaN(n)&&this.Ga(`length string (${e}) is not valid number`);const r=await this.za(n);return new fu(JSON.parse(r),t.length+n)}ja(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Wa(){for(;this.ja()<0&&!await this.Ha(););if(0===this.buffer.length)return null;const t=this.ja();t<0&&this.Ga("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async za(t){for(;this.buffer.length<t;)await this.Ha()&&this.Ga("Reached the end of bundle when more is expected.");const e=this.$a.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}Ga(t){throw this.Ka.cancel(),new Error(`Invalid bundle format: ${t}`)}async Ha(){const t=await this.Ka.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class ac{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new A(D.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const e=await async function(t,e){const n=C(t),r={documents:e.map((t=>_s(n.serializer,t)))},i=await n.vo("BatchGetDocuments",n.serializer.databaseId,W.emptyPath(),r,e.length),s=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){S(!!e.found),e.found.name,e.found.updateTime;const n=Is(t,e.found.name),r=ys(e.found.updateTime),i=e.found.createTime?ys(e.found.createTime):$.min(),s=new Ke({mapValue:{fields:e.found.fields}});return Qe.newFoundDocument(n,r,i,s)}(t,e):"missing"in e?function(t,e){S(!!e.missing),S(!!e.readTime);const n=Is(t,e.missing),r=ys(e.readTime);return Qe.newNoDocument(n,r)}(t,e):T()}(n.serializer,t);s.set(e.key.toString(),e)}));const o=[];return e.forEach((t=>{const e=s.get(t.toString());S(!!e),o.push(e)})),o}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastTransactionError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Lr(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=X.fromPath(e);this.mutations.push(new Vr(n,this.precondition(n)))})),await async function(t,e){const n=C(t),r={writes:e.map((t=>As(n.serializer,t)))};await n.So("Commit",n.serializer.databaseId,W.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw T();e=$.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new A(D.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual($.min())?Tr.exists(!1):Tr.updateTime(e):Tr.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual($.min()))throw new A(D.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Tr.updateTime(e)}return Tr.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class uc{constructor(t,e,n,r,i){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=r,this.deferred=i,this.Ja=n.maxAttempts,this.jo=new ya(this.asyncQueue,"transaction_retry")}Ya(){this.Ja-=1,this.Za()}Za(){this.jo.qo((async()=>{const t=new ac(this.datastore),e=this.Xa(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.eu(t)}))))})).catch((t=>{this.eu(t)}))}))}Xa(t){try{const e=this.updateFunction(t);return!St(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}eu(t){this.Ja>0&&this.tu(t)?(this.Ja-=1,this.asyncQueue.enqueueAndForget((()=>(this.Za(),Promise.resolve())))):this.deferred.reject(t)}tu(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!Kr(e)}return!1}}class cc{constructor(t,e,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=f.UNAUTHENTICATED,this.clientId=U.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{v("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(v("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new A(D.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new N;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=Za(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function hc(t,e){t.asyncQueue.verifyOperationInProgress(),v("FirestoreClient","Initializing OfflineComponentProvider");const n=t.configuration;await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await qo(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t._offlineComponents=e}async function lc(t,e){t.asyncQueue.verifyOperationInProgress();const n=await fc(t);v("FirestoreClient","Initializing OnlineComponentProvider"),await e.initialize(n,t.configuration),t.setCredentialChangeListener((t=>Wa(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>Wa(e.remoteStore,n))),t._onlineComponents=e}function dc(t){return"FirebaseError"===t.name?t.code===D.FAILED_PRECONDITION||t.code===D.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}async function fc(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){v("FirestoreClient","Using user provided OfflineComponentProvider");try{await hc(t,t._uninitializedComponentsProvider._offline)}catch(e){const n=e;if(!dc(n))throw n;I("Error using user provided cache. Falling back to memory cache: "+n),await hc(t,new tc)}}else v("FirestoreClient","Using default OfflineComponentProvider"),await hc(t,new tc);return t._offlineComponents}async function mc(t){return t._onlineComponents||(t._uninitializedComponentsProvider?(v("FirestoreClient","Using user provided OnlineComponentProvider"),await lc(t,t._uninitializedComponentsProvider._online)):(v("FirestoreClient","Using default OnlineComponentProvider"),await lc(t,new rc))),t._onlineComponents}function gc(t){return fc(t).then((t=>t.persistence))}function pc(t){return fc(t).then((t=>t.localStore))}function yc(t){return mc(t).then((t=>t.remoteStore))}function wc(t){return mc(t).then((t=>t.syncEngine))}function vc(t){return mc(t).then((t=>t.datastore))}async function bc(t){const e=await mc(t),n=e.eventManager;return n.onListen=Eu.bind(null,e.syncEngine),n.onUnlisten=Cu.bind(null,e.syncEngine),n.onFirstRemoteStoreListen=Tu.bind(null,e.syncEngine),n.onLastRemoteStoreUnlisten=Du.bind(null,e.syncEngine),n}function _c(t,e,n={}){const r=new N;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,i){const s=new ic({next:s=>{e.enqueueAndForget((()=>ou(t,o)));const c=s.docs.has(n);!c&&s.fromCache?i.reject(new A(D.UNAVAILABLE,"Failed to get document because the client is offline.")):c&&s.fromCache&&r&&"server"===r.source?i.reject(new A(D.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(s)},error:t=>i.reject(t)}),o=new du(An(n.path),s,{includeMetadataChanges:!0,ta:!0});return iu(t,o)}(await bc(t),t.asyncQueue,e,n,r))),r.promise}function Ic(t,e,n={}){const r=new N;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,i){const s=new ic({next:n=>{e.enqueueAndForget((()=>ou(t,o))),n.fromCache&&"server"===r.source?i.reject(new A(D.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:t=>i.reject(t)}),o=new du(n,s,{includeMetadataChanges:!0,ta:!0});return iu(t,o)}(await bc(t),t.asyncQueue,e,n,r))),r.promise}function Ec(t,e,n,r){const i=function(t,e){let n;return n="string"==typeof t?Wr().encode(t):t,function(t,e){return new oc(t,e)}(function(t,e){if(t instanceof Uint8Array)return sc(t,e);if(t instanceof ArrayBuffer)return sc(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,pa(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=C(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=C(t),r=ys(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.$r.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(pu(r));const i=new gu(r,t.localStore,e.serializer);let s=await e.Ba();for(;s;){const t=await i.sa(s);t&&n._updateProgress(t),s=await e.Ba()}const o=await i.complete();return await Uu(t,o.aa,void 0),await function(t,e){const n=C(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.$r.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress),Promise.resolve(o._a)}catch(t){return I("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(r,e,n).then((t=>{r.sharedClientState.notifyBundleLoaded(t)}))}(await wc(t),i,r)}))}function Tc(t){const e={};return void 0!==t.timeoutSeconds&&(e.timeoutSeconds=t.timeoutSeconds),e}const Sc=new Map;function xc(t,e,n){if(!n)throw new A(D.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Cc(t,e,n,r){if(!0===e&&!0===r)throw new A(D.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Dc(t){if(!X.isDocumentKey(t))throw new A(D.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Ac(t){if(X.isDocumentKey(t))throw new A(D.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Nc(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":T()}function kc(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new A(D.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Nc(t);throw new A(D.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Oc(t,e){if(e<=0)throw new A(D.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Rc{constructor(t){var e,n;if(void 0===t.host){if(void 0!==t.ssl)throw new A(D.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new A(D.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Cc("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===t.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Tc(null!==(n=t.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(t){if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new A(D.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new A(D.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(t.timeoutSeconds>30)throw new A(D.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(t,e){return t.timeoutSeconds===e.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Mc{constructor(t,e,n,r){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Rc({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new A(D.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new A(D.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Rc(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new O;switch(t.type){case"firstParty":return new F(t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new A(D.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Sc.get(t);e&&(v("ComponentProvider","Removing Datastore"),Sc.delete(t),e.terminate())}(this),Promise.resolve()}}function Pc(t,e,n,r={}){var i;const s=(t=kc(t,Mc))._getSettings(),o=`${e}:${n}`;if("firestore.googleapis.com"!==s.host&&s.host!==o&&I("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),t._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=f.MOCK_USER;else{e=Object(h.g)(r.mockUserToken,null===(i=t._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new A(D.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new f(s)}t._authCredentials=new R(new k(e,n))}}class Fc{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Fc(this.firestore,t,this._query)}}class Lc{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Vc(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Lc(this.firestore,t,this._key)}}class Vc extends Fc{constructor(t,e,n){super(t,e,An(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Lc(this.firestore,null,new X(t))}withConverter(t){return new Vc(this.firestore,t,this._path)}}function qc(t,e,...n){if(t=Object(h.p)(t),xc("collection","path",e),t instanceof Mc){const r=W.fromString(e,...n);return Ac(r),new Vc(t,null,r)}{if(!(t instanceof Lc||t instanceof Vc))throw new A(D.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(W.fromString(e,...n));return Ac(r),new Vc(t.firestore,null,r)}}function jc(t,e){if(t=kc(t,Mc),xc("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new A(D.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Fc(t,null,function(t){return new Cn(W.emptyPath(),t)}(e))}function Uc(t,e,...n){if(t=Object(h.p)(t),1===arguments.length&&(e=U.newId()),xc("doc","path",e),t instanceof Mc){const r=W.fromString(e,...n);return Dc(r),new Lc(t,null,new X(r))}{if(!(t instanceof Lc||t instanceof Vc))throw new A(D.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(W.fromString(e,...n));return Dc(r),new Lc(t.firestore,t instanceof Vc?t.converter:null,new X(r))}}function Bc(t,e){return t=Object(h.p)(t),e=Object(h.p)(e),(t instanceof Lc||t instanceof Vc)&&(e instanceof Lc||e instanceof Vc)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Gc(t,e){return t=Object(h.p)(t),e=Object(h.p)(e),t instanceof Fc&&e instanceof Fc&&t.firestore===e.firestore&&Ln(t._query,e._query)&&t.converter===e.converter}class zc{constructor(){this.nu=Promise.resolve(),this.ru=[],this.iu=!1,this.su=[],this.ou=null,this._u=!1,this.au=!1,this.uu=[],this.jo=new ya(this,"async_queue_retry"),this.cu=()=>{const t=ga();t&&v("AsyncQueue","Visibility state changed to "+t.visibilityState),this.jo.Ko()};const t=ga();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.cu)}get isShuttingDown(){return this.iu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.lu(),this.hu(t)}enterRestrictedMode(t){if(!this.iu){this.iu=!0,this.au=t||!1;const e=ga();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.cu)}}enqueue(t){if(this.lu(),this.iu)return new Promise((()=>{}));const e=new N;return this.hu((()=>this.iu&&this.au?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.ru.push(t),this.Pu())))}async Pu(){if(0!==this.ru.length){try{await this.ru[0](),this.ru.shift(),this.jo.reset()}catch(t){if(!yt(t))throw t;v("AsyncQueue","Operation failed with retryable error: "+t)}this.ru.length>0&&this.jo.qo((()=>this.Pu()))}}hu(t){const e=this.nu.then((()=>(this._u=!0,t().catch((t=>{this.ou=t,this._u=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw _("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this._u=!1,t))))));return this.nu=e,e}enqueueAfterDelay(t,e,n){this.lu(),this.uu.indexOf(t)>-1&&(e=0);const r=Ja.createAndSchedule(this,t,e,n,(t=>this.Iu(t)));return this.su.push(r),r}lu(){this.ou&&T()}verifyOperationInProgress(){}async Tu(){let t;do{t=this.nu,await t}while(t!==this.nu)}Eu(t){for(const e of this.su)if(e.timerId===t)return!0;return!1}du(t){return this.Tu().then((()=>{this.su.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.su)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Tu()}))}Au(t){this.uu.push(t)}Iu(t){const e=this.su.indexOf(t);this.su.splice(e,1)}}function Kc(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of e)if(t in n&&"function"==typeof n[t])return!0;return!1}(t,["next","error","complete"])}class $c{constructor(){this._progressObserver={},this._taskCompletionResolver=new N,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const Qc=-1;class Wc extends Mc{constructor(t,e,n,r){super(t,e,n,r),this.type="firestore",this._queue=new zc,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Yc(this),this._firestoreClient.terminate()}}function Hc(t){return t._firestoreClient||Yc(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Yc(t){var e,n,r;const i=t._freezeSettings(),s=function(t,e,n,r){return new Ie(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,Tc(r.experimentalLongPollingOptions),r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,i);t._firestoreClient=new cc(t._authCredentials,t._appCheckCredentials,t._queue,s),(null===(n=i.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=i.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(t._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function Xc(t,e){ah(t=kc(t,Wc));const n=Hc(t);if(n._uninitializedComponentsProvider)throw new A(D.FAILED_PRECONDITION,"SDK cache is already specified.");I("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=t._freezeSettings(),i=new rc;return Zc(n,i,new ec(i,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function Jc(t){ah(t=kc(t,Wc));const e=Hc(t);if(e._uninitializedComponentsProvider)throw new A(D.FAILED_PRECONDITION,"SDK cache is already specified.");I("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=t._freezeSettings(),r=new rc;return Zc(e,r,new nc(r,n.cacheSizeBytes))}function Zc(t,e,n){const r=new N;return t.asyncQueue.enqueue((async()=>{try{await hc(t,n),await lc(t,e),r.resolve()}catch(t){const e=t;if(!dc(e))throw e;I("Error enabling indexeddb cache. Falling back to memory cache: "+e),r.reject(e)}})).then((()=>r.promise))}function eh(t){if(t._initialized&&!t._terminated)throw new A(D.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new N;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!mt.D())return Promise.resolve();const e=t+"main";await mt.delete(e)}(Ro(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function nh(t){return function(t){const e=new N;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=C(t);Oa(n.remoteStore)||v("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=C(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const r=n.Ma.get(t)||[];r.push(e),n.Ma.set(t,r)}catch(t){const n=Za(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await wc(t),e))),e.promise}(Hc(t=kc(t,Wc)))}function rh(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await gc(t),n=await yc(t);return e.setNetworkEnabled(!0),function(t){const e=C(t);return e.v_.delete(0),Ta(e)}(n)}))}(Hc(t=kc(t,Wc)))}function sh(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await gc(t),n=await yc(t);return e.setNetworkEnabled(!1),async function(t){const e=C(t);e.v_.add(0),await Sa(e),e.x_.set("Offline")}(n)}))}(Hc(t=kc(t,Wc)))}function ih(t,e){const n=Hc(t=kc(t,Wc)),r=new $c;return Ec(n,t._databaseId,e,r),r}function oh(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=C(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.$r.getNamedQuery(t,e)))}(await pc(t),e)))}(Hc(t=kc(t,Wc)),e).then((e=>e?new Fc(t,null,e.query):null))}function ah(t){if(t._initialized||t._terminated)throw new A(D.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class uh{constructor(t){this._byteString=t}static fromBase64String(t){try{return new uh(me.fromBase64String(t))}catch(t){throw new A(D.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new uh(me.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class ch{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new A(D.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Y(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}class hh{constructor(t){this._methodName=t}}class lh{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new A(D.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new A(D.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return B(this._lat,t._lat)||B(this._long,t._long)}}const dh=/^__.*__$/;class fh{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Rr(t,this.data,this.fieldMask,e,this.fieldTransforms):new Or(t,this.data,e,this.fieldTransforms)}}class mh{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Rr(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function gh(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw T()}}class ph{constructor(t,e,n,r,i,s){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Ru(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Vu(){return this.settings.Vu}mu(t){return new ph(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}fu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.mu({path:n,gu:!1});return r.pu(t),r}yu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.mu({path:n,gu:!1});return r.Ru(),r}wu(t){return this.mu({path:void 0,gu:!0})}Su(t){return Fh(t,this.settings.methodName,this.settings.bu||!1,this.path,this.settings.Du)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}Ru(){if(this.path)for(let t=0;t<this.path.length;t++)this.pu(this.path.get(t))}pu(t){if(0===t.length)throw this.Su("Document fields must not be empty");if(gh(this.Vu)&&dh.test(t))throw this.Su('Document fields cannot begin and end with "__"')}}class yh{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||pa(t)}Cu(t,e,n,r=!1){return new ph({Vu:t,methodName:e,Du:n,path:Y.emptyPath(),gu:!1,bu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function wh(t){const e=t._freezeSettings(),n=pa(t._databaseId);return new yh(t._databaseId,!!e.ignoreUndefinedProperties,n)}function vh(t,e,n,r,i,s={}){const o=t.Cu(s.merge||s.mergeFields?2:0,e,n,i);Oh("Data must be an object, but it was:",o,r);const c=Nh(r,o);let a,u;if(s.merge)a=new le(o.fieldMask),u=o.fieldTransforms;else if(s.mergeFields){const t=[];for(const r of s.mergeFields){const i=Rh(e,r,n);if(!o.contains(i))throw new A(D.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);Lh(t,i)||t.push(i)}a=new le(t),u=o.fieldTransforms.filter((t=>a.covers(t.field)))}else a=null,u=o.fieldTransforms;return new fh(new Ke(c),a,u)}class bh extends hh{_toFieldTransform(t){if(2!==t.Vu)throw 1===t.Vu?t.Su(`${this._methodName}() can only appear at the top level of your update data`):t.Su(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof bh}}function _h(t,e,n){return new ph({Vu:3,Du:e.settings.Du,methodName:t._methodName,gu:n},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class Ih extends hh{_toFieldTransform(t){return new Ir(t.path,new fr)}isEqual(t){return t instanceof Ih}}class Eh extends hh{constructor(t,e){super(t),this.vu=e}_toFieldTransform(t){const e=_h(this,t,!0),n=this.vu.map((t=>Ah(t,e))),r=new mr(n);return new Ir(t.path,r)}isEqual(t){return t instanceof Eh&&Object(h.i)(this.vu,t.vu)}}class Th extends hh{constructor(t,e){super(t),this.vu=e}_toFieldTransform(t){const e=_h(this,t,!0),n=this.vu.map((t=>Ah(t,e))),r=new pr(n);return new Ir(t.path,r)}isEqual(t){return t instanceof Th&&Object(h.i)(this.vu,t.vu)}}class Sh extends hh{constructor(t,e){super(t),this.Fu=e}_toFieldTransform(t){const e=new wr(t.serializer,ar(t.serializer,this.Fu));return new Ir(t.path,e)}isEqual(t){return t instanceof Sh&&this.Fu===t.Fu}}function xh(t,e,n,r){const i=t.Cu(1,e,n);Oh("Data must be an object, but it was:",i,r);const s=[],o=Ke.empty();re(r,((t,r)=>{const c=Ph(e,t,n);r=Object(h.p)(r);const a=i.yu(c);if(r instanceof bh)s.push(c);else{const t=Ah(r,a);null!=t&&(s.push(c),o.set(c,t))}}));const c=new le(s);return new mh(o,c,i.fieldTransforms)}function Ch(t,e,n,r,i,s){const o=t.Cu(1,e,n),c=[Rh(e,r,n)],a=[i];if(s.length%2!=0)throw new A(D.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<s.length;t+=2)c.push(Rh(e,s[t])),a.push(s[t+1]);const u=[],l=Ke.empty();for(let t=c.length-1;t>=0;--t)if(!Lh(u,c[t])){const e=c[t];let n=a[t];n=Object(h.p)(n);const r=o.yu(e);if(n instanceof bh)u.push(e);else{const t=Ah(n,r);null!=t&&(u.push(e),l.set(e,t))}}const d=new le(u);return new mh(l,d,o.fieldTransforms)}function Dh(t,e,n,r=!1){return Ah(n,t.Cu(r?4:3,e))}function Ah(t,e){if(kh(t=Object(h.p)(t)))return Oh("Unsupported field value:",e,t),Nh(t,e);if(t instanceof hh)return function(t,e){if(!gh(e.Vu))throw e.Su(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Su(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.gu&&4!==e.Vu)throw e.Su("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const i of t){let t=Ah(i,e.wu(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=Object(h.p)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return ar(e.serializer,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=K.fromDate(t);return{timestampValue:ms(e.serializer,n)}}if(t instanceof K){const n=new K(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:ms(e.serializer,n)}}if(t instanceof lh)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof uh)return{bytesValue:gs(e.serializer,t._byteString)};if(t instanceof Lc){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.Su(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:ws(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Su(`Unsupported field value: ${Nc(t)}`)}(t,e)}function Nh(t,e){const n={};return se(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):re(t,((t,r)=>{const i=Ah(r,e.fu(t));null!=i&&(n[t]=i)})),{mapValue:{fields:n}}}function kh(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof K||t instanceof lh||t instanceof uh||t instanceof Lc||t instanceof hh)}function Oh(t,e,n){if(!kh(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=Nc(n);throw"an object"===r?e.Su(t+" a custom object"):e.Su(t+" "+r)}}function Rh(t,e,n){if((e=Object(h.p)(e))instanceof ch)return e._internalPath;if("string"==typeof e)return Ph(t,e);throw Fh("Field path arguments must be of type string or ",t,!1,void 0,n)}const Mh=new RegExp("[~\\*/\\[\\]]");function Ph(t,e,n){if(e.search(Mh)>=0)throw Fh(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new ch(...e.split("."))._internalPath}catch(r){throw Fh(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Fh(t,e,n,r,i){const s=r&&!r.isEmpty(),o=void 0!==i;let c=`Function ${e}() called with invalid data`;n&&(c+=" (via `toFirestore()`)"),c+=". ";let a="";return(s||o)&&(a+=" (found",s&&(a+=` in field ${r}`),o&&(a+=` in document ${i}`),a+=")"),new A(D.INVALID_ARGUMENT,c+t+a)}function Lh(t,e){return t.some((t=>t.isEqual(e)))}class Vh{constructor(t,e,n,r,i){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Lc(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new qh(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(jh("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class qh extends Vh{data(){return super.data()}}function jh(t,e){return"string"==typeof e?Ph(t,e):e instanceof ch?e._internalPath:e._delegate._internalPath}function Uh(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new A(D.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Bh{}class Gh extends Bh{}function zh(t,e,...n){let r=[];e instanceof Bh&&r.push(e),r=r.concat(n),function(t){const e=t.filter((t=>t instanceof Qh)).length,n=t.filter((t=>t instanceof Kh)).length;if(e>1||e>0&&n>0)throw new A(D.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const e of r)t=e._apply(t);return t}class Kh extends Gh{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new Kh(t,e,n)}_apply(t){const e=this._parse(t);return hl(t._query,e),new Fc(t.firestore,t.converter,Pn(t._query,e))}_parse(t){const e=wh(t.firestore),n=function(t,e,n,r,i,s,o){let c;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new A(D.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){cl(o,s);const e=[];for(const n of o)e.push(al(r,t,n));c={arrayValue:{values:e}}}else c=al(r,t,o)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||cl(o,s),c=Dh(n,e,o,"in"===s||"not-in"===s);return tn.create(i,s,c)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value);return n}}function $h(t,e,n){const r=e,i=jh("where",t);return Kh._create(i,r,n)}class Qh extends Bh{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new Qh(t,e)}_parse(t){const e=this._queryConstraints.map((e=>e._parse(t))).filter((t=>t.getFilters().length>0));return 1===e.length?e[0]:en.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return 0===e.getFilters().length?t:(function(t,e){let n=t;const r=e.getFlattenedFilters();for(const t of r)hl(n,t),n=Pn(n,t)}(t._query,e),new Fc(t.firestore,t.converter,Pn(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Wh extends Gh{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new Wh(t,e)}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new A(D.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new A(D.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Xe(e,n)}(t._query,this._field,this._direction);return new Fc(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new Cn(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function Hh(t,e="asc"){const n=e,r=jh("orderBy",t);return Wh._create(r,n)}class Yh extends Gh{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new Yh(t,e,n)}_apply(t){return new Fc(t.firestore,t.converter,Fn(t._query,this._limit,this._limitType))}}function Xh(t){return Oc("limit",t),Yh._create("limit",t,"F")}function Jh(t){return Oc("limitToLast",t),Yh._create("limitToLast",t,"L")}class Zh extends Gh{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new Zh(t,e,n)}_apply(t){const e=il(t,this.type,this._docOrFields,this._inclusive);return new Fc(t.firestore,t.converter,function(t,e){return new Cn(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function tl(...t){return Zh._create("startAt",t,!0)}function el(...t){return Zh._create("startAfter",t,!1)}class nl extends Gh{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new nl(t,e,n)}_apply(t){const e=il(t,this.type,this._docOrFields,this._inclusive);return new Fc(t.firestore,t.converter,function(t,e){return new Cn(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function rl(...t){return nl._create("endBefore",t,!1)}function sl(...t){return nl._create("endAt",t,!0)}function il(t,e,n,r){if(n[0]=Object(h.p)(n[0]),n[0]instanceof Vh)return function(t,e,n,r,i){if(!r)throw new A(D.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const s=[];for(const n of On(t))if(n.field.isKeyField())s.push(Re(e,r.key));else{const t=r.data.field(n.field);if(ve(t))throw new A(D.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new A(D.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}s.push(t)}return new We(s,i)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const i=wh(t.firestore);return function(t,e,n,r,i,s){const o=t.explicitOrderBy;if(i.length>o.length)throw new A(D.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const c=[];for(let s=0;s<i.length;s++){const a=i[s];if(o[s].field.isKeyField()){if("string"!=typeof a)throw new A(D.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof a}`);if(!kn(t)&&-1!==a.indexOf("/"))throw new A(D.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${a}' contains a slash.`);const n=t.path.child(W.fromString(a));if(!X.isDocumentKey(n))throw new A(D.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new X(n);c.push(Re(e,i))}else{const t=Dh(n,r,a);c.push(t)}}return new We(c,s)}(t._query,t.firestore._databaseId,i,e,n,r)}}function al(t,e,n){if("string"==typeof(n=Object(h.p)(n))){if(""===n)throw new A(D.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!kn(e)&&-1!==n.indexOf("/"))throw new A(D.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(W.fromString(n));if(!X.isDocumentKey(r))throw new A(D.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Re(t,new X(r))}if(n instanceof Lc)return Re(t,n._key);throw new A(D.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Nc(n)}.`)}function cl(t,e){if(!Array.isArray(t)||0===t.length)throw new A(D.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function hl(t,e){const n=function(t,e){for(const n of t)for(const t of n.getFlattenedFilters())if(e.indexOf(t.op)>=0)return t.op;return null}(t.filters,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new A(D.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new A(D.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}class ll{convertValue(t,e="none"){switch(xe(t)){case 0:return null;case 1:return t.booleanValue;case 2:return ye(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(we(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw T()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const n={};return re(t,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertGeoPoint(t){return new lh(ye(t.latitude),ye(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=be(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(_e(t));default:return null}}convertTimestamp(t){const e=pe(t);return new K(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=W.fromString(t);S(Bs(n));const r=new Ee(n.get(1),n.get(3)),i=new X(n.popFirst(5));return r.isEqual(e)||_(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),i}}function fl(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class ml extends ll{constructor(t){super(),this.firestore=t}convertBytes(t){return new uh(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Lc(this.firestore,null,e)}}class gl{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class pl extends Vh{constructor(t,e,n,r,i,s){super(t,e,n,r,s),this._firestore=t,this._firestoreImpl=t,this.metadata=i}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new yl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(jh("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class yl extends pl{data(t={}){return super.data(t)}}class wl{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new gl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new yl(this._firestore,this._userDataWriter,n.key,n,new gl(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new A(D.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>{const r=new yl(t._firestore,t._userDataWriter,n.doc.key,n.doc,new gl(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:e++}}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new yl(t._firestore,t._userDataWriter,e.doc.key,e.doc,new gl(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let i=-1,s=-1;return 0!==e.type&&(i=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),s=n.indexOf(e.doc.key)),{type:vl(e.type),doc:r,oldIndex:i,newIndex:s}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function vl(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return T()}}function bl(t,e){return t instanceof pl&&e instanceof pl?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof wl&&e instanceof wl&&t._firestore===e._firestore&&Gc(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function _l(t){t=kc(t,Lc);const e=kc(t.firestore,Wc);return _c(Hc(e),t._key).then((n=>Pl(e,t,n)))}class Il extends ll{constructor(t){super(),this.firestore=t}convertBytes(t){return new uh(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Lc(this.firestore,null,e)}}function El(t){t=kc(t,Lc);const e=kc(t.firestore,Wc),n=Hc(e),r=new Il(e);return function(t,e){const n=new N;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=C(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new A(D.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=Za(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await pc(t),e,n))),n.promise}(n,t._key).then((n=>new pl(e,r,t._key,n,new gl(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Tl(t){t=kc(t,Lc);const e=kc(t.firestore,Wc);return _c(Hc(e),t._key,{source:"server"}).then((n=>Pl(e,t,n)))}function Sl(t){t=kc(t,Fc);const e=kc(t.firestore,Wc),n=Hc(e),r=new Il(e);return Uh(t._query),Ic(n,t._query).then((n=>new wl(e,r,t,n)))}function xl(t){t=kc(t,Fc);const e=kc(t.firestore,Wc),n=Hc(e),r=new Il(e);return function(t,e){const n=new N;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await Ko(t,e,!0),i=new vu(e,r.hs),s=i.Ta(r.documents),o=i.applyChanges(s,!1);n.resolve(o.snapshot)}catch(t){const r=Za(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await pc(t),e,n))),n.promise}(n,t._query).then((n=>new wl(e,r,t,n)))}function Cl(t){t=kc(t,Fc);const e=kc(t.firestore,Wc),n=Hc(e),r=new Il(e);return Ic(n,t._query,{source:"server"}).then((n=>new wl(e,r,t,n)))}function Dl(t,e,n){t=kc(t,Lc);const r=kc(t.firestore,Wc),i=fl(t.converter,e,n);return Ml(r,[vh(wh(r),"setDoc",t._key,i,null!==t.converter,n).toMutation(t._key,Tr.none())])}function Al(t,e,n,...r){t=kc(t,Lc);const i=kc(t.firestore,Wc),s=wh(i);let o;return o="string"==typeof(e=Object(h.p)(e))||e instanceof ch?Ch(s,"updateDoc",t._key,e,n,r):xh(s,"updateDoc",t._key,e),Ml(i,[o.toMutation(t._key,Tr.exists(!0))])}function Nl(t){return Ml(kc(t.firestore,Wc),[new Lr(t._key,Tr.none())])}function kl(t,e){const n=kc(t.firestore,Wc),r=Uc(t),i=fl(t.converter,e);return Ml(n,[vh(wh(t.firestore),"addDoc",r._key,i,null!==t.converter,{}).toMutation(r._key,Tr.exists(!1))]).then((()=>r))}function Ol(t,...e){var n,r,i;t=Object(h.p)(t);let s={includeMetadataChanges:!1,source:"default"},o=0;"object"!=typeof e[o]||Kc(e[o])||(s=e[o],o++);const c={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(Kc(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[o+2]=null===(i=t.complete)||void 0===i?void 0:i.bind(t)}let a,u,l;if(t instanceof Lc)u=kc(t.firestore,Wc),l=An(t._key.path),a={next:n=>{e[o]&&e[o](Pl(u,t,n))},error:e[o+1],complete:e[o+2]};else{const n=kc(t,Fc);u=kc(n.firestore,Wc),l=n._query;const r=new Il(u);a={next:t=>{e[o]&&e[o](new wl(u,r,n,t))},error:e[o+1],complete:e[o+2]},Uh(t._query)}return function(t,e,n,r){const i=new ic(r),s=new du(e,i,n);return t.asyncQueue.enqueueAndForget((async()=>iu(await bc(t),s))),()=>{i.Qa(),t.asyncQueue.enqueueAndForget((async()=>ou(await bc(t),s)))}}(Hc(u),l,c,a)}function Rl(t,e){return function(t,e){const n=new ic(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){C(t).W_.add(e),e.next()}(await bc(t),n))),()=>{n.Qa(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){C(t).W_.delete(e)}(await bc(t),n)))}}(Hc(t=kc(t,Wc)),Kc(e)?e:{next:e})}function Ml(t,e){return function(t,e){const n=new N;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=Zu(t);try{const t=await function(t,e){const n=C(t),r=K.now(),i=e.reduce(((t,e)=>t.add(e.key)),nr());let s,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let c=$n(),a=nr();return n.os.getEntries(t,i).next((t=>{c=t,c.forEach(((t,e)=>{e.isValidDocument()||(a=a.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,c))).next((i=>{s=i;const o=[];for(const t of e){const e=Nr(t,s.get(t.key).overlayedDocument);null!=e&&o.push(new Rr(t.key,e,$e(e.value.mapValue),Tr.exists(!0)))}return n.mutationQueue.addMutationBatch(t,r,o,e)})).next((e=>{o=e;const r=e.applyToLocalDocumentSet(s,a);return n.documentOverlayCache.saveOverlays(t,e.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Hn(s)})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.Fa[t.currentUser.toKey()];r||(r=new ie(B)),r=r.insert(e,n),t.Fa[t.currentUser.toKey()]=r}(r,t.batchId,n),await Uu(r,t.changes),await qa(r.remoteStore)}catch(t){const e=Za(t,"Failed to persist write");n.reject(e)}}(await wc(t),e,n))),n.promise}(Hc(t),e)}function Pl(t,e,n){const r=n.docs.get(e._key),i=new Il(t);return new pl(t,i,e._key,r,new gl(n.hasPendingWrites,n.fromCache),e.converter)}const Fl={maxAttempts:5};class Ll{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=wh(t)}set(t,e,n){this._verifyNotCommitted();const r=Vl(t,this._firestore),i=fl(r.converter,e,n),s=vh(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,Tr.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const i=Vl(t,this._firestore);let s;return s="string"==typeof(e=Object(h.p)(e))||e instanceof ch?Ch(this._dataReader,"WriteBatch.update",i._key,e,n,r):xh(this._dataReader,"WriteBatch.update",i._key,e),this._mutations.push(s.toMutation(i._key,Tr.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Vl(t,this._firestore);return this._mutations=this._mutations.concat(new Lr(e._key,Tr.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new A(D.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Vl(t,e){if((t=Object(h.p)(t)).firestore!==e)throw new A(D.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class ql extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=wh(t)}get(t){const e=Vl(t,this._firestore),n=new ml(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return T();const r=t[0];if(r.isFoundDocument())return new Vh(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new Vh(this._firestore,n,e._key,null,e.converter);throw T()}))}set(t,e,n){const r=Vl(t,this._firestore),i=fl(r.converter,e,n),s=vh(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(t,e,n,...r){const i=Vl(t,this._firestore);let s;return s="string"==typeof(e=Object(h.p)(e))||e instanceof ch?Ch(this._dataReader,"Transaction.update",i._key,e,n,r):xh(this._dataReader,"Transaction.update",i._key,e),this._transaction.update(i._key,s),this}delete(t){const e=Vl(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Vl(t,this._firestore),n=new Il(this._firestore);return super.get(t).then((t=>new pl(this._firestore,n,e._key,t._document,new gl(!1,!1),e.converter)))}}function jl(t,e,n){t=kc(t,Wc);const r=Object.assign(Object.assign({},Fl),n);return function(t){if(t.maxAttempts<1)throw new A(D.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,e,n){const r=new N;return t.asyncQueue.enqueueAndForget((async()=>{const i=await vc(t);new uc(t.asyncQueue,i,n,e,r).Ya()})),r.promise}(Hc(t),(n=>e(new ql(t,n))),r)}function Ul(){return new bh("deleteField")}function Bl(){return new Ih("serverTimestamp")}function Gl(...t){return new Eh("arrayUnion",t)}function zl(...t){return new Th("arrayRemove",t)}function Kl(t){return new Sh("increment",t)}new WeakMap;!function(t,e=!0){!function(t){m=t}(r.SDK_VERSION),Object(r._registerComponent)(new o.a("firestore",((t,{instanceIdentifier:n,options:r})=>{const i=t.getProvider("app").getImmediate(),s=new Wc(new M(t.getProvider("auth-internal")),new V(t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new A(D.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ee(t.options.projectId,e)}(i,n),i);return r=Object.assign({useFetchStreams:e},r),s._setSettings(r),s}),"PUBLIC").setMultipleInstances(!0)),Object(r.registerVersion)(d,"4.5.1",t),Object(r.registerVersion)(d,"4.5.1","esm2017")}()}).call(this,n(201))},507:function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return _r})),n.d(e,"b",(function(){return Er})),n.d(e,"c",(function(){return Ir})),n.d(e,"d",(function(){return Dr})),n.d(e,"e",(function(){return Cr})),n.d(e,"f",(function(){return Tr})),n.d(e,"g",(function(){return Sr})),n.d(e,"h",(function(){return xr})),n.d(e,"i",(function(){return wr})),n.d(e,"j",(function(){return vr}));var r,o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{},c={},h=h||{},l=o||self;function d(a){var b=typeof a;return"array"==(b="object"!=b?b:a?Array.isArray(a)?"array":b:"null")||"object"==b&&"number"==typeof a.length}function p(a){var b=typeof a;return"object"==b&&null!=a||"function"==b}var f="closure_uid_"+(1e9*Math.random()>>>0),m=0;function y(a,b,t){return a.call.apply(a.bind,arguments)}function w(a,b,t){if(!a)throw Error();if(2<arguments.length){var e=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,e),a.apply(b,t)}}return function(){return a.apply(b,arguments)}}function q(a,b,t){return(q=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?y:w).apply(null,arguments)}function v(a,b){var t=Array.prototype.slice.call(arguments,1);return function(){var e=t.slice();return e.push.apply(e,arguments),a.apply(this,e)}}function _(a,b){function t(){}t.prototype=b.prototype,a.$=b.prototype,a.prototype=new t,a.prototype.constructor=a,a.ac=function(t,e,n){for(var r=Array(arguments.length-2),o=2;o<arguments.length;o++)r[o-2]=arguments[o];return b.prototype[e].apply(t,r)}}function I(){this.s=this.s,this.o=this.o}I.prototype.s=!1,I.prototype.sa=function(){var a;!this.s&&(this.s=!0,this.N(),0)&&(a=this,Object.prototype.hasOwnProperty.call(a,f)&&a[f]||(a[f]=++m))},I.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const E=Array.prototype.indexOf?function(a,b){return Array.prototype.indexOf.call(a,b,void 0)}:function(a,b){if("string"==typeof a)return"string"!=typeof b||1!=b.length?-1:a.indexOf(b,0);for(let t=0;t<a.length;t++)if(t in a&&a[t]===b)return t;return-1};function T(a){const b=a.length;if(0<b){const t=Array(b);for(let e=0;e<b;e++)t[e]=a[e];return t}return[]}function S(a,b){for(let t=1;t<arguments.length;t++){const e=arguments[t];if(d(e)){const t=a.length||0,n=e.length||0;a.length=t+n;for(let r=0;r<n;r++)a[t+r]=e[r]}else a.push(e)}}function x(a,b){this.type=a,this.g=this.target=b,this.defaultPrevented=!1}x.prototype.h=function(){this.defaultPrevented=!0};var C=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var a=!1,b=Object.defineProperty({},"passive",{get:function(){a=!0}});try{const t=()=>{};l.addEventListener("test",t,b),l.removeEventListener("test",t,b)}catch(t){}return a}();function D(a){return/^[\s\xa0]*$/.test(a)}function A(){var a=l.navigator;return a&&(a=a.userAgent)?a:""}function N(a){return-1!=A().indexOf(a)}function k(a){return k[" "](a),a}k[" "]=function(){};var O,a,R,M=N("Opera"),P=N("Trident")||N("MSIE"),F=N("Edge"),L=F||P,V=N("Gecko")&&!(-1!=A().toLowerCase().indexOf("webkit")&&!N("Edge"))&&!(N("Trident")||N("MSIE"))&&!N("Edge"),j=-1!=A().toLowerCase().indexOf("webkit")&&!N("Edge");function U(){var a=l.document;return a?a.documentMode:void 0}t:{var B="",G=(a=A(),V?/rv:([^\);]+)(\)|;)/.exec(a):F?/Edge\/([\d\.]+)/.exec(a):P?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(a):j?/WebKit\/(\S+)/.exec(a):M?/(?:Version)[ \/]?(\S+)/.exec(a):void 0);if(G&&(B=G?G[1]:""),P){var z=U();if(null!=z&&z>parseFloat(B)){O=String(z);break t}}O=B}if(l.document&&P){var K=U();R=K||(parseInt(O,10)||void 0)}else R=void 0;var $=R;function Q(a,b){if(x.call(this,a?a.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,a){var t=this.type=a.type,e=a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:null;if(this.target=a.target||a.srcElement,this.g=b,b=a.relatedTarget){if(V){t:{try{k(b.nodeName);var n=!0;break t}catch(t){}n=!1}n||(b=null)}}else"mouseover"==t?b=a.fromElement:"mouseout"==t&&(b=a.toElement);this.relatedTarget=b,e?(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0):(this.clientX=void 0!==a.clientX?a.clientX:a.pageX,this.clientY=void 0!==a.clientY?a.clientY:a.pageY,this.screenX=a.screenX||0,this.screenY=a.screenY||0),this.button=a.button,this.key=a.key||"",this.ctrlKey=a.ctrlKey,this.altKey=a.altKey,this.shiftKey=a.shiftKey,this.metaKey=a.metaKey,this.pointerId=a.pointerId||0,this.pointerType="string"==typeof a.pointerType?a.pointerType:W[a.pointerType]||"",this.state=a.state,this.i=a,a.defaultPrevented&&Q.$.h.call(this)}}_(Q,x);var W={2:"touch",3:"pen",4:"mouse"};Q.prototype.h=function(){Q.$.h.call(this);var a=this.i;a.preventDefault?a.preventDefault():a.returnValue=!1};var H="closure_listenable_"+(1e6*Math.random()|0),Y=0;function X(a,b,t,e,n){this.listener=a,this.proxy=null,this.src=b,this.type=t,this.capture=!!e,this.la=n,this.key=++Y,this.fa=this.ia=!1}function J(a){a.fa=!0,a.listener=null,a.proxy=null,a.src=null,a.la=null}function Z(a,b,t){for(const e in a)b.call(t,a[e],e,a)}function tt(a){const b={};for(const t in a)b[t]=a[t];return b}const et="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function nt(a,b){let t,e;for(let n=1;n<arguments.length;n++){for(t in e=arguments[n],e)a[t]=e[t];for(let n=0;n<et.length;n++)t=et[n],Object.prototype.hasOwnProperty.call(e,t)&&(a[t]=e[t])}}function st(a){this.src=a,this.g={},this.h=0}function it(a,b){var t=b.type;if(t in a.g){var e,n=a.g[t],r=E(n,b);(e=0<=r)&&Array.prototype.splice.call(n,r,1),e&&(J(b),0==a.g[t].length&&(delete a.g[t],a.h--))}}function ot(a,b,t,e){for(var n=0;n<a.length;++n){var r=a[n];if(!r.fa&&r.listener==b&&r.capture==!!t&&r.la==e)return n}return-1}st.prototype.add=function(a,b,t,e,n){var r=a.toString();(a=this.g[r])||(a=this.g[r]=[],this.h++);var o=ot(a,b,e,n);return-1<o?(b=a[o],t||(b.ia=!1)):((b=new X(b,this.src,r,!!e,n)).ia=t,a.push(b)),b};var at="closure_lm_"+(1e6*Math.random()|0),ut={};function ct(a,b,t,e,n){if(e&&e.once)return lt(a,b,t,e,n);if(Array.isArray(b)){for(var r=0;r<b.length;r++)ct(a,b[r],t,e,n);return null}return t=vt(t),a&&a[H]?a.O(b,t,p(e)?!!e.capture:!!e,n):ht(a,b,t,!1,e,n)}function ht(a,b,t,e,n,r){if(!b)throw Error("Invalid event type");var o=p(n)?!!n.capture:!!n,c=yt(a);if(c||(a[at]=c=new st(a)),(t=c.add(b,t,e,o,r)).proxy)return t;if(e=function(){function a(t){return b.call(a.src,a.listener,t)}const b=pt;return a}(),t.proxy=e,e.src=a,e.listener=t,a.addEventListener)C||(n=o),void 0===n&&(n=!1),a.addEventListener(b.toString(),e,n);else if(a.attachEvent)a.attachEvent(gt(b.toString()),e);else{if(!a.addListener||!a.removeListener)throw Error("addEventListener and attachEvent are unavailable.");a.addListener(e)}return t}function lt(a,b,t,e,n){if(Array.isArray(b)){for(var r=0;r<b.length;r++)lt(a,b[r],t,e,n);return null}return t=vt(t),a&&a[H]?a.P(b,t,p(e)?!!e.capture:!!e,n):ht(a,b,t,!0,e,n)}function ft(a,b,t,e,n){if(Array.isArray(b))for(var r=0;r<b.length;r++)ft(a,b[r],t,e,n);else e=p(e)?!!e.capture:!!e,t=vt(t),a&&a[H]?(a=a.i,(b=String(b).toString())in a.g&&(-1<(t=ot(r=a.g[b],t,e,n))&&(J(r[t]),Array.prototype.splice.call(r,t,1),0==r.length&&(delete a.g[b],a.h--)))):a&&(a=yt(a))&&(b=a.g[b.toString()],a=-1,b&&(a=ot(b,t,e,n)),(t=-1<a?b[a]:null)&&mt(t))}function mt(a){if("number"!=typeof a&&a&&!a.fa){var b=a.src;if(b&&b[H])it(b.i,a);else{var t=a.type,e=a.proxy;b.removeEventListener?b.removeEventListener(t,e,a.capture):b.detachEvent?b.detachEvent(gt(t),e):b.addListener&&b.removeListener&&b.removeListener(e),(t=yt(b))?(it(t,a),0==t.h&&(t.src=null,b[at]=null)):J(a)}}}function gt(a){return a in ut?ut[a]:ut[a]="on"+a}function pt(a,b){if(a.fa)a=!0;else{b=new Q(b,this);var t=a.listener,e=a.la||a.src;a.ia&&mt(a),a=t.call(e,b)}return a}function yt(a){return(a=a[at])instanceof st?a:null}var wt="__closure_events_fn_"+(1e9*Math.random()>>>0);function vt(a){return"function"==typeof a?a:(a[wt]||(a[wt]=function(b){return a.handleEvent(b)}),a[wt])}function bt(){I.call(this),this.i=new st(this),this.S=this,this.J=null}function _t(a,b){var t,e=a.J;if(e)for(t=[];e;e=e.J)t.push(e);if(a=a.S,e=b.type||b,"string"==typeof b)b=new x(b,a);else if(b instanceof x)b.target=b.target||a;else{var n=b;nt(b=new x(e,a),n)}if(n=!0,t)for(var r=t.length-1;0<=r;r--){var o=b.g=t[r];n=It(o,e,!0,b)&&n}if(n=It(o=b.g=a,e,!0,b)&&n,n=It(o,e,!1,b)&&n,t)for(r=0;r<t.length;r++)n=It(o=b.g=t[r],e,!1,b)&&n}function It(a,b,t,e){if(!(b=a.i.g[String(b)]))return!0;b=b.concat();for(var n=!0,r=0;r<b.length;++r){var o=b[r];if(o&&!o.fa&&o.capture==t){var c=o.listener,h=o.la||o.src;o.ia&&it(a.i,o),n=!1!==c.call(h,e)&&n}}return n&&!e.defaultPrevented}_(bt,I),bt.prototype[H]=!0,bt.prototype.removeEventListener=function(a,b,t,e){ft(this,a,b,t,e)},bt.prototype.N=function(){if(bt.$.N.call(this),this.i){var t,a=this.i;for(t in a.g){for(var e=a.g[t],n=0;n<e.length;n++)J(e[n]);delete a.g[t],a.h--}}this.J=null},bt.prototype.O=function(a,b,t,e){return this.i.add(String(a),b,!1,t,e)},bt.prototype.P=function(a,b,t,e){return this.i.add(String(a),b,!0,t,e)};var Et=l.JSON.stringify;function Tt(){var a=kt;let b=null;return a.g&&(b=a.g,a.g=a.g.next,a.g||(a.h=null),b.next=null),b}var St=new class{constructor(a,b){this.i=a,this.j=b,this.h=0,this.g=null}get(){let a;return 0<this.h?(this.h--,a=this.g,this.g=a.next,a.next=null):a=this.i(),a}}((()=>new xt),(a=>a.reset()));class xt{constructor(){this.next=this.g=this.h=null}set(a,b){this.h=a,this.g=b,this.next=null}reset(){this.next=this.g=this.h=null}}function Ct(a){var b=1;a=a.split(":");const t=[];for(;0<b&&a.length;)t.push(a.shift()),b--;return a.length&&t.push(a.join(":")),t}function Dt(a){l.setTimeout((()=>{throw a}),0)}let At,Nt=!1,kt=new class{constructor(){this.h=this.g=null}add(a,b){const t=St.get();t.set(a,b),this.h?this.h.next=t:this.g=t,this.h=t}},Ot=()=>{const a=l.Promise.resolve(void 0);At=()=>{a.then(Rt)}};var Rt=()=>{for(var a;a=Tt();){try{a.h.call(a.g)}catch(t){Dt(t)}var b=St;b.j(a),100>b.h&&(b.h++,a.next=b.g,b.g=a)}Nt=!1};function Mt(a,b){bt.call(this),this.h=a||1,this.g=b||l,this.j=q(this.qb,this),this.l=Date.now()}function Pt(a){a.ga=!1,a.T&&(a.g.clearTimeout(a.T),a.T=null)}function Ft(a,b,t){if("function"==typeof a)t&&(a=q(a,t));else{if(!a||"function"!=typeof a.handleEvent)throw Error("Invalid listener argument");a=q(a.handleEvent,a)}return 2147483647<Number(b)?-1:l.setTimeout(a,b||0)}function Lt(a){a.g=Ft((()=>{a.g=null,a.i&&(a.i=!1,Lt(a))}),a.j);const b=a.h;a.h=null,a.m.apply(null,b)}_(Mt,bt),(r=Mt.prototype).ga=!1,r.T=null,r.qb=function(){if(this.ga){var a=Date.now()-this.l;0<a&&a<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-a):(this.T&&(this.g.clearTimeout(this.T),this.T=null),_t(this,"tick"),this.ga&&(Pt(this),this.start()))}},r.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},r.N=function(){Mt.$.N.call(this),Pt(this),delete this.g};class Vt extends I{constructor(a,b){super(),this.m=a,this.j=b,this.h=null,this.i=!1,this.g=null}l(a){this.h=arguments,this.g?this.i=!0:Lt(this)}N(){super.N(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function qt(a){I.call(this),this.h=a,this.g={}}_(qt,I);var jt=[];function Ut(a,b,t,e){Array.isArray(t)||(t&&(jt[0]=t.toString()),t=jt);for(var n=0;n<t.length;n++){var r=ct(b,t[n],e||a.handleEvent,!1,a.h||a);if(!r)break;a.g[r.key]=r}}function Bt(a){Z(a.g,(function(b,t){this.g.hasOwnProperty(t)&&mt(b)}),a),a.g={}}function Gt(){this.g=!0}function zt(a,b,t,e){a.info((function(){return"XMLHTTP TEXT ("+b+"): "+function(a,b){if(!a.g)return b;if(!b)return null;try{var t=JSON.parse(b);if(t)for(a=0;a<t.length;a++)if(Array.isArray(t[a])){var e=t[a];if(!(2>e.length)){var n=e[1];if(Array.isArray(n)&&!(1>n.length)){var r=n[0];if("noop"!=r&&"stop"!=r&&"close"!=r)for(var o=1;o<n.length;o++)n[o]=""}}}return Et(t)}catch(t){return b}}(a,t)+(e?" "+e:"")}))}qt.prototype.N=function(){qt.$.N.call(this),Bt(this)},qt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Gt.prototype.Ea=function(){this.g=!1},Gt.prototype.info=function(){};var Kt={},$t=null;function Qt(){return $t=$t||new bt}function Wt(a){x.call(this,Kt.Ta,a)}function Ht(a){const b=Qt();_t(b,new Wt(b))}function Yt(a,b){x.call(this,Kt.STAT_EVENT,a),this.stat=b}function Xt(a){const b=Qt();_t(b,new Yt(b,a))}function Jt(a,b){x.call(this,Kt.Ua,a),this.size=b}function Zt(a,b){if("function"!=typeof a)throw Error("Fn must not be null and must be a function");return l.setTimeout((function(){a()}),b)}Kt.Ta="serverreachability",_(Wt,x),Kt.STAT_EVENT="statevent",_(Yt,x),Kt.Ua="timingevent",_(Jt,x);var te={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},ee={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function ne(){}function re(a){return a.h||(a.h=a.i())}function se(){}ne.prototype.h=null;var ie,oe={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function ae(){x.call(this,"d")}function ue(){x.call(this,"c")}function ce(){}function he(a,b,t,e){this.l=a,this.j=b,this.m=t,this.W=e||1,this.U=new qt(this),this.P=de,a=L?125:void 0,this.V=new Mt(a),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new le}function le(){this.i=null,this.g="",this.h=!1}_(ae,x),_(ue,x),_(ce,ne),ce.prototype.g=function(){return new XMLHttpRequest},ce.prototype.i=function(){return{}},ie=new ce;var de=45e3,fe={},me={};function ge(a,b,t){a.L=1,a.A=Me(Ae(b)),a.u=t,a.S=!0,pe(a,null)}function pe(a,b){a.G=Date.now(),be(a),a.B=Ae(a.A);var t=a.B,e=a.W;Array.isArray(e)||(e=[String(e)]),Qe(t.i,"t",e),a.o=0,t=a.l.J,a.h=new le,a.g=zn(a.l,t?b:null,!a.u),0<a.O&&(a.M=new Vt(q(a.Pa,a,a.g),a.O)),Ut(a.U,a.g,"readystatechange",a.nb),b=a.I?tt(a.I):{},a.u?(a.v||(a.v="POST"),b["Content-Type"]="application/x-www-form-urlencoded",a.g.ha(a.B,a.v,a.u,b)):(a.v="GET",a.g.ha(a.B,a.v,null,b)),Ht(),function(a,b,t,e,n,r){a.info((function(){if(a.g)if(r)for(var o="",c=r.split("&"),h=0;h<c.length;h++){var l=c[h].split("=");if(1<l.length){var u=l[0];l=l[1];var d=u.split("_");o=2<=d.length&&"type"==d[1]?o+(u+"=")+l+"&":o+(u+"=redacted&")}}else o=null;else o=r;return"XMLHTTP REQ ("+e+") [attempt "+n+"]: "+b+"\n"+t+"\n"+o}))}(a.j,a.v,a.B,a.m,a.W,a.u)}function ye(a){return!!a.g&&("GET"==a.v&&2!=a.L&&a.l.Ha)}function we(a,b,t){let e,n=!0;for(;!a.J&&a.o<t.length;){if(e=ve(a,t),e==me){4==b&&(a.s=4,Xt(14),n=!1),zt(a.j,a.m,null,"[Incomplete Response]");break}if(e==fe){a.s=4,Xt(15),zt(a.j,a.m,t,"[Invalid Chunk]"),n=!1;break}zt(a.j,a.m,e,null),Se(a,e)}ye(a)&&0!=a.o&&(a.h.g=a.h.g.slice(a.o),a.o=0),4!=b||0!=t.length||a.h.h||(a.s=1,Xt(16),n=!1),a.i=a.i&&n,n?0<t.length&&!a.ba&&(a.ba=!0,(b=a.l).g==a&&b.ca&&!b.M&&(b.l.info("Great, no buffering proxy detected. Bytes received: "+t.length),Fn(b),b.M=!0,Xt(11))):(zt(a.j,a.m,t,"[Invalid Chunked Response]"),Te(a),Ee(a))}function ve(a,b){var t=a.o,e=b.indexOf("\n",t);return-1==e?me:(t=Number(b.substring(t,e)),isNaN(t)?fe:(e+=1)+t>b.length?me:(b=b.slice(e,e+t),a.o=e+t,b))}function be(a){a.Y=Date.now()+a.P,_e(a,a.P)}function _e(a,b){if(null!=a.C)throw Error("WatchDog timer not null");a.C=Zt(q(a.lb,a),b)}function Ie(a){a.C&&(l.clearTimeout(a.C),a.C=null)}function Ee(a){0==a.l.H||a.J||qn(a.l,a)}function Te(a){Ie(a);var b=a.M;b&&"function"==typeof b.sa&&b.sa(),a.M=null,Pt(a.V),Bt(a.U),a.g&&(b=a.g,a.g=null,b.abort(),b.sa())}function Se(a,b){try{var t=a.l;if(0!=t.H&&(t.g==a||Je(t.i,a)))if(!a.K&&Je(t.i,a)&&3==t.H){try{var e=t.Ja.g.parse(b)}catch(t){e=null}if(Array.isArray(e)&&3==e.length){var n=e;if(0==n[0]){t:if(!t.u){if(t.g){if(!(t.g.G+3e3<a.G))break t;Vn(t),Dn(t)}Pn(t),Xt(18)}}else t.Fa=n[1],0<t.Fa-t.V&&37500>n[2]&&t.G&&0==t.A&&!t.v&&(t.v=Zt(q(t.ib,t),6e3));if(1>=Xe(t.i)&&t.oa){try{t.oa()}catch(t){}t.oa=void 0}}else Un(t,11)}else if((a.K||t.g==a)&&Vn(t),!D(b))for(n=t.Ja.g.parse(b),b=0;b<n.length;b++){let l=n[b];if(t.V=l[0],l=l[1],2==t.H)if("c"==l[0]){t.K=l[1],t.pa=l[2];const u=l[3];null!=u&&(t.ra=u,t.l.info("VER="+t.ra));const n=l[4];null!=n&&(t.Ga=n,t.l.info("SVER="+t.Ga));const d=l[5];null!=d&&"number"==typeof d&&0<d&&(e=1.5*d,t.L=e,t.l.info("backChannelRequestTimeoutMs_="+e)),e=t;const f=a.g;if(f){const t=f.g?f.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var r=e.i;r.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(r.j=r.l,r.g=new Set,r.h&&(Ze(r,r.h),r.h=null))}if(e.F){const t=f.g?f.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(e.Da=t,Re(e.I,e.F,t))}}t.H=3,t.h&&t.h.Ba(),t.ca&&(t.S=Date.now()-a.G,t.l.info("Handshake RTT: "+t.S+"ms"));var o=a;if((e=t).wa=Gn(e,e.J?e.pa:null,e.Y),o.K){tn(e.i,o);var c=o,h=e.L;h&&c.setTimeout(h),c.C&&(Ie(c),be(c)),e.g=o}else Mn(e);0<t.j.length&&Nn(t)}else"stop"!=l[0]&&"close"!=l[0]||Un(t,7);else 3==t.H&&("stop"==l[0]||"close"==l[0]?"stop"==l[0]?Un(t,7):Cn(t):"noop"!=l[0]&&t.h&&t.h.Aa(l),t.A=0)}Ht()}catch(t){}}function xe(a,b){if(a.forEach&&"function"==typeof a.forEach)a.forEach(b,void 0);else if(d(a)||"string"==typeof a)Array.prototype.forEach.call(a,b,void 0);else for(var t=function(a){if(a.ta&&"function"==typeof a.ta)return a.ta();if(!a.Z||"function"!=typeof a.Z){if("undefined"!=typeof Map&&a instanceof Map)return Array.from(a.keys());if(!("undefined"!=typeof Set&&a instanceof Set)){if(d(a)||"string"==typeof a){var b=[];a=a.length;for(var t=0;t<a;t++)b.push(t);return b}b=[],t=0;for(const e in a)b[t++]=e;return b}}}(a),e=function(a){if(a.Z&&"function"==typeof a.Z)return a.Z();if("undefined"!=typeof Map&&a instanceof Map||"undefined"!=typeof Set&&a instanceof Set)return Array.from(a.values());if("string"==typeof a)return a.split("");if(d(a)){for(var b=[],t=a.length,e=0;e<t;e++)b.push(a[e]);return b}for(e in b=[],t=0,a)b[t++]=a[e];return b}(a),n=e.length,r=0;r<n;r++)b.call(void 0,e[r],t&&t[r],a)}(r=he.prototype).setTimeout=function(a){this.P=a},r.nb=function(a){a=a.target;const b=this.M;b&&3==_n(a)?b.l():this.Pa(a)},r.Pa=function(a){try{if(a==this.g)t:{const u=_n(this.g);var b=this.g.Ia();this.g.da();if(!(3>u)&&(3!=u||L||this.g&&(this.h.h||this.g.ja()||In(this.g)))){this.J||4!=u||7==b||Ht(),Ie(this);var t=this.g.da();this.ca=t;e:if(ye(this)){var e=In(this.g);a="";var n=e.length,r=4==_n(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Te(this),Ee(this);var o="";break e}this.h.i=new l.TextDecoder}for(b=0;b<n;b++)this.h.h=!0,a+=this.h.i.decode(e[b],{stream:r&&b==n-1});e.length=0,this.h.g+=a,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=200==t,function(a,b,t,e,n,r,o){a.info((function(){return"XMLHTTP RESP ("+e+") [ attempt "+n+"]: "+b+"\n"+t+"\n"+r+" "+o}))}(this.j,this.v,this.B,this.m,this.W,u,t),this.i){if(this.aa&&!this.K){e:{if(this.g){var c,h=this.g;if((c=h.g?h.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!D(c)){var d=c;break e}}d=null}if(!(t=d)){this.i=!1,this.s=3,Xt(12),Te(this),Ee(this);break t}zt(this.j,this.m,t,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Se(this,t)}this.S?(we(this,u,o),L&&this.i&&3==u&&(Ut(this.U,this.V,"tick",this.mb),this.V.start())):(zt(this.j,this.m,o,null),Se(this,o)),4==u&&Te(this),this.i&&!this.J&&(4==u?qn(this.l,this):(this.i=!1,be(this)))}else(function(a){const b={};a=(a.g&&2<=_n(a)&&a.g.getAllResponseHeaders()||"").split("\r\n");for(let e=0;e<a.length;e++){if(D(a[e]))continue;var t=Ct(a[e]);const n=t[0];if("string"!=typeof(t=t[1]))continue;t=t.trim();const r=b[n]||[];b[n]=r,r.push(t)}!function(a,b){for(const t in a)b.call(void 0,a[t],t,a)}(b,(function(t){return t.join(", ")}))})(this.g),400==t&&0<o.indexOf("Unknown SID")?(this.s=3,Xt(12)):(this.s=0,Xt(13)),Te(this),Ee(this)}}}catch(t){}},r.mb=function(){if(this.g){var a=_n(this.g),b=this.g.ja();this.o<b.length&&(Ie(this),we(this,a,b),this.i&&4!=a&&be(this))}},r.cancel=function(){this.J=!0,Te(this)},r.lb=function(){this.C=null;const a=Date.now();0<=a-this.Y?(function(a,b){a.info((function(){return"TIMEOUT: "+b}))}(this.j,this.B),2!=this.L&&(Ht(),Xt(17)),Te(this),this.s=2,Ee(this)):_e(this,this.Y-a)};var Ce=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function De(a){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,a instanceof De){this.h=a.h,Ne(this,a.j),this.s=a.s,this.g=a.g,ke(this,a.m),this.l=a.l;var b=a.i,t=new Ge;t.i=b.i,b.g&&(t.g=new Map(b.g),t.h=b.h),Oe(this,t),this.o=a.o}else a&&(b=String(a).match(Ce))?(this.h=!1,Ne(this,b[1]||"",!0),this.s=Pe(b[2]||""),this.g=Pe(b[3]||"",!0),ke(this,b[4]),this.l=Pe(b[5]||"",!0),Oe(this,b[6]||"",!0),this.o=Pe(b[7]||"")):(this.h=!1,this.i=new Ge(null,this.h))}function Ae(a){return new De(a)}function Ne(a,b,t){a.j=t?Pe(b,!0):b,a.j&&(a.j=a.j.replace(/:$/,""))}function ke(a,b){if(b){if(b=Number(b),isNaN(b)||0>b)throw Error("Bad port number "+b);a.m=b}else a.m=null}function Oe(a,b,t){b instanceof Ge?(a.i=b,function(a,b){b&&!a.j&&(ze(a),a.i=null,a.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(Ke(this,e),Qe(this,n,t))}),a)),a.j=b}(a.i,a.h)):(t||(b=Fe(b,Ue)),a.i=new Ge(b,a.h))}function Re(a,b,t){a.i.set(b,t)}function Me(a){return Re(a,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),a}function Pe(a,b){return a?b?decodeURI(a.replace(/%25/g,"%2525")):decodeURIComponent(a):""}function Fe(a,b,t){return"string"==typeof a?(a=encodeURI(a).replace(b,Le),t&&(a=a.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),a):null}function Le(a){return"%"+((a=a.charCodeAt(0))>>4&15).toString(16)+(15&a).toString(16)}De.prototype.toString=function(){var a=[],b=this.j;b&&a.push(Fe(b,Ve,!0),":");var t=this.g;return(t||"file"==b)&&(a.push("//"),(b=this.s)&&a.push(Fe(b,Ve,!0),"@"),a.push(encodeURIComponent(String(t)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(t=this.m)&&a.push(":",String(t))),(t=this.l)&&(this.g&&"/"!=t.charAt(0)&&a.push("/"),a.push(Fe(t,"/"==t.charAt(0)?je:qe,!0))),(t=this.i.toString())&&a.push("?",t),(t=this.o)&&a.push("#",Fe(t,Be)),a.join("")};var Ve=/[#\/\?@]/g,qe=/[#\?:]/g,je=/[#\?]/g,Ue=/[#\?@]/g,Be=/#/g;function Ge(a,b){this.h=this.g=null,this.i=a||null,this.j=!!b}function ze(a){a.g||(a.g=new Map,a.h=0,a.i&&function(a,b){if(a){a=a.split("&");for(var t=0;t<a.length;t++){var e=a[t].indexOf("="),n=null;if(0<=e){var r=a[t].substring(0,e);n=a[t].substring(e+1)}else r=a[t];b(r,n?decodeURIComponent(n.replace(/\+/g," ")):"")}}}(a.i,(function(b,t){a.add(decodeURIComponent(b.replace(/\+/g," ")),t)})))}function Ke(a,b){ze(a),b=We(a,b),a.g.has(b)&&(a.i=null,a.h-=a.g.get(b).length,a.g.delete(b))}function $e(a,b){return ze(a),b=We(a,b),a.g.has(b)}function Qe(a,b,t){Ke(a,b),0<t.length&&(a.i=null,a.g.set(We(a,b),T(t)),a.h+=t.length)}function We(a,b){return b=String(b),a.j&&(b=b.toLowerCase()),b}(r=Ge.prototype).add=function(a,b){ze(this),this.i=null,a=We(this,a);var t=this.g.get(a);return t||this.g.set(a,t=[]),t.push(b),this.h+=1,this},r.forEach=function(a,b){ze(this),this.g.forEach((function(t,e){t.forEach((function(t){a.call(b,t,e,this)}),this)}),this)},r.ta=function(){ze(this);const a=Array.from(this.g.values()),b=Array.from(this.g.keys()),t=[];for(let e=0;e<b.length;e++){const n=a[e];for(let r=0;r<n.length;r++)t.push(b[e])}return t},r.Z=function(a){ze(this);let b=[];if("string"==typeof a)$e(this,a)&&(b=b.concat(this.g.get(We(this,a))));else{a=Array.from(this.g.values());for(let t=0;t<a.length;t++)b=b.concat(a[t])}return b},r.set=function(a,b){return ze(this),this.i=null,$e(this,a=We(this,a))&&(this.h-=this.g.get(a).length),this.g.set(a,[b]),this.h+=1,this},r.get=function(a,b){return a&&0<(a=this.Z(a)).length?String(a[0]):b},r.toString=function(){if(this.i)return this.i;if(!this.g)return"";const a=[],b=Array.from(this.g.keys());for(var t=0;t<b.length;t++){var e=b[t];const r=encodeURIComponent(String(e)),o=this.Z(e);for(e=0;e<o.length;e++){var n=r;""!==o[e]&&(n+="="+encodeURIComponent(String(o[e]))),a.push(n)}}return this.i=a.join("&")};function He(a){this.l=a||dd,l.PerformanceNavigationTiming?a=0<(a=l.performance.getEntriesByType("navigation")).length&&("hq"==a[0].nextHopProtocol||"h2"==a[0].nextHopProtocol):a=!!(l.g&&l.g.Ka&&l.g.Ka()&&l.g.Ka().dc),this.j=a?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var dd=10;function Ye(a){return!!a.h||!!a.g&&a.g.size>=a.j}function Xe(a){return a.h?1:a.g?a.g.size:0}function Je(a,b){return a.h?a.h==b:!!a.g&&a.g.has(b)}function Ze(a,b){a.g?a.g.add(b):a.h=b}function tn(a,b){a.h&&a.h==b?a.h=null:a.g&&a.g.has(b)&&a.g.delete(b)}function en(a){if(null!=a.h)return a.i.concat(a.h.F);if(null!=a.g&&0!==a.g.size){let b=a.i;for(const t of a.g.values())b=b.concat(t.F);return b}return T(a.i)}He.prototype.cancel=function(){if(this.i=en(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const a of this.g.values())a.cancel();this.g.clear()}};function nn(){this.g=new class{stringify(a){return l.JSON.stringify(a,void 0)}parse(a){return l.JSON.parse(a,void 0)}}}function rn(a,b,t){const e=t||"";try{xe(a,(function(t,n){let r=t;p(t)&&(r=Et(t)),b.push(e+n+"="+encodeURIComponent(r))}))}catch(t){throw b.push(e+"type="+encodeURIComponent("_badmap")),t}}function sn(a,b,t,e,n){try{b.onload=null,b.onerror=null,b.onabort=null,b.ontimeout=null,n(e)}catch(t){}}function on(a){this.l=a.ec||null,this.j=a.ob||!1}function an(a,b){bt.call(this),this.F=a,this.u=b,this.m=void 0,this.readyState=un,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}_(on,ne),on.prototype.g=function(){return new an(this.l,this.j)},on.prototype.i=function(a){return function(){return a}}({}),_(an,bt);var un=0;function cn(a){a.j.read().then(a.Xa.bind(a)).catch(a.ka.bind(a))}function hn(a){a.readyState=4,a.l=null,a.j=null,a.A=null,ln(a)}function ln(a){a.onreadystatechange&&a.onreadystatechange.call(a)}(r=an.prototype).open=function(a,b){if(this.readyState!=un)throw this.abort(),Error("Error reopening a connection");this.C=a,this.B=b,this.readyState=1,ln(this)},r.send=function(a){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const b={headers:this.v,method:this.C,credentials:this.m,cache:void 0};a&&(b.body=a),(this.F||l).fetch(new Request(this.B,b)).then(this.$a.bind(this),this.ka.bind(this))},r.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,hn(this)),this.readyState=un},r.$a=function(a){if(this.g&&(this.l=a,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=a.headers,this.readyState=2,ln(this)),this.g&&(this.readyState=3,ln(this),this.g)))if("arraybuffer"===this.responseType)a.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==l.ReadableStream&&"body"in a){if(this.j=a.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;cn(this)}else a.text().then(this.Za.bind(this),this.ka.bind(this))},r.Xa=function(a){if(this.g){if(this.u&&a.value)this.response.push(a.value);else if(!this.u){var b=a.value?a.value:new Uint8Array(0);(b=this.A.decode(b,{stream:!a.done}))&&(this.response=this.responseText+=b)}a.done?hn(this):ln(this),3==this.readyState&&cn(this)}},r.Za=function(a){this.g&&(this.response=this.responseText=a,hn(this))},r.Ya=function(a){this.g&&(this.response=a,hn(this))},r.ka=function(){this.g&&hn(this)},r.setRequestHeader=function(a,b){this.v.append(a,b)},r.getResponseHeader=function(a){return this.h&&this.h.get(a.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";const a=[],b=this.h.entries();for(var t=b.next();!t.done;)t=t.value,a.push(t[0]+": "+t[1]),t=b.next();return a.join("\r\n")},Object.defineProperty(an.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(a){this.m=a?"include":"same-origin"}});var dn=l.JSON.parse;function fn(a){bt.call(this),this.headers=new Map,this.u=a||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=mn,this.L=this.M=!1}_(fn,bt);var mn="",td=/^https?$/i,gn=["POST","PUT"];function pn(a,b){a.h=!1,a.g&&(a.l=!0,a.g.abort(),a.l=!1),a.j=b,a.m=5,yn(a),vn(a)}function yn(a){a.F||(a.F=!0,_t(a,"complete"),_t(a,"error"))}function wn(a){if(a.h&&void 0!==h&&(!a.C[1]||4!=_n(a)||2!=a.da()))if(a.v&&4==_n(a))Ft(a.La,0,a);else if(_t(a,"readystatechange"),4==_n(a)){a.h=!1;try{const o=a.da();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var b=!0;break t;default:b=!1}var t;if(!(t=b)){var e;if(e=0===o){var n=String(a.I).match(Ce)[1]||null;!n&&l.self&&l.self.location&&(n=l.self.location.protocol.slice(0,-1)),e=!td.test(n?n.toLowerCase():"")}t=e}if(t)_t(a,"complete"),_t(a,"success");else{a.m=6;try{var r=2<_n(a)?a.g.statusText:""}catch(t){r=""}a.j=r+" ["+a.da()+"]",yn(a)}}finally{vn(a)}}}function vn(a,b){if(a.g){bn(a);const t=a.g,e=a.C[0]?()=>{}:null;a.g=null,a.C=null,b||_t(a,"ready");try{t.onreadystatechange=e}catch(t){}}}function bn(a){a.g&&a.L&&(a.g.ontimeout=null),a.A&&(l.clearTimeout(a.A),a.A=null)}function _n(a){return a.g?a.g.readyState:0}function In(a){try{if(!a.g)return null;if("response"in a.g)return a.g.response;switch(a.K){case mn:case"text":return a.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in a.g)return a.g.mozResponseArrayBuffer}return null}catch(t){return null}}function En(a){let b="";return Z(a,(function(t,e){b+=e,b+=":",b+=t,b+="\r\n"})),b}function Tn(a,b,t){t:{for(e in t){var e=!1;break t}e=!0}e||(t=En(t),"string"==typeof a?null!=t&&encodeURIComponent(String(t)):Re(a,b,t))}function Sn(a,b,t){return t&&t.internalChannelParams&&t.internalChannelParams[a]||b}function xn(a){this.Ga=0,this.j=[],this.l=new Gt,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=Sn("failFast",!1,a),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=Sn("baseRetryDelayMs",5e3,a),this.hb=Sn("retryDelaySeedMs",1e4,a),this.eb=Sn("forwardChannelMaxRetries",2,a),this.xa=Sn("forwardChannelRequestTimeoutMs",2e4,a),this.va=a&&a.xmlHttpFactory||void 0,this.Ha=a&&a.useFetchStreams||!1,this.L=void 0,this.J=a&&a.supportsCrossDomainXhr||!1,this.K="",this.i=new He(a&&a.concurrentRequestLimit),this.Ja=new nn,this.P=a&&a.fastHandshake||!1,this.O=a&&a.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=a&&a.bc||!1,a&&a.Ea&&this.l.Ea(),a&&a.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&a&&a.detectBufferingProxy||!1,this.qa=void 0,a&&a.longPollingTimeout&&0<a.longPollingTimeout&&(this.qa=a.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Cn(a){if(An(a),3==a.H){var b=a.W++,t=Ae(a.I);if(Re(t,"SID",a.K),Re(t,"RID",b),Re(t,"TYPE","terminate"),On(a,t),(b=new he(a,a.l,b)).L=2,b.A=Me(Ae(t)),t=!1,l.navigator&&l.navigator.sendBeacon)try{t=l.navigator.sendBeacon(b.A.toString(),"")}catch(t){}!t&&l.Image&&((new Image).src=b.A,t=!0),t||(b.g=zn(b.l,null),b.g.ha(b.A)),b.G=Date.now(),be(b)}Bn(a)}function Dn(a){a.g&&(Fn(a),a.g.cancel(),a.g=null)}function An(a){Dn(a),a.u&&(l.clearTimeout(a.u),a.u=null),Vn(a),a.i.cancel(),a.m&&("number"==typeof a.m&&l.clearTimeout(a.m),a.m=null)}function Nn(a){if(!Ye(a.i)&&!a.m){a.m=!0;var b=a.Na;At||Ot(),Nt||(At(),Nt=!0),kt.add(b,a),a.C=0}}function kn(a,b){var t;t=b?b.m:a.W++;const e=Ae(a.I);Re(e,"SID",a.K),Re(e,"RID",t),Re(e,"AID",a.V),On(a,e),a.o&&a.s&&Tn(e,a.o,a.s),t=new he(a,a.l,t,a.C+1),null===a.o&&(t.I=a.s),b&&(a.j=b.F.concat(a.j)),b=Rn(a,t,1e3),t.setTimeout(Math.round(.5*a.xa)+Math.round(.5*a.xa*Math.random())),Ze(a.i,t),ge(t,e,b)}function On(a,b){a.na&&Z(a.na,(function(t,e){Re(b,e,t)})),a.h&&xe({},(function(t,e){Re(b,e,t)}))}function Rn(a,b,t){t=Math.min(a.j.length,t);var e=a.h?q(a.h.Va,a.h,a):null;t:{var n=a.j;let r=-1;for(;;){const o=["count="+t];-1==r?0<t?(r=n[0].g,o.push("ofs="+r)):r=0:o.push("ofs="+r);let c=!0;for(let h=0;h<t;h++){let t=n[h].g;const u=n[h].map;if(t-=r,0>t)r=Math.max(0,n[h].g-100),c=!1;else try{rn(u,o,"req"+t+"_")}catch(t){e&&e(u)}}if(c){e=o.join("&");break t}}}return a=a.j.splice(0,t),b.F=a,e}function Mn(a){if(!a.g&&!a.u){a.ba=1;var b=a.Ma;At||Ot(),Nt||(At(),Nt=!0),kt.add(b,a),a.A=0}}function Pn(a){return!(a.g||a.u||3<=a.A)&&(a.ba++,a.u=Zt(q(a.Ma,a),jn(a,a.A)),a.A++,!0)}function Fn(a){null!=a.B&&(l.clearTimeout(a.B),a.B=null)}function Ln(a){a.g=new he(a,a.l,"rpc",a.ba),null===a.o&&(a.g.I=a.s),a.g.O=0;var b=Ae(a.wa);Re(b,"RID","rpc"),Re(b,"SID",a.K),Re(b,"AID",a.V),Re(b,"CI",a.G?"0":"1"),!a.G&&a.qa&&Re(b,"TO",a.qa),Re(b,"TYPE","xmlhttp"),On(a,b),a.o&&a.s&&Tn(b,a.o,a.s),a.L&&a.g.setTimeout(a.L);var t=a.g;a=a.pa,t.L=1,t.A=Me(Ae(b)),t.u=null,t.S=!0,pe(t,a)}function Vn(a){null!=a.v&&(l.clearTimeout(a.v),a.v=null)}function qn(a,b){var t=null;if(a.g==b){Vn(a),Fn(a),a.g=null;var e=2}else{if(!Je(a.i,b))return;t=b.F,tn(a.i,b),e=1}if(0!=a.H)if(b.i)if(1==e){t=b.u?b.u.length:0,b=Date.now()-b.G;var n=a.C;_t(e=Qt(),new Jt(e,t)),Nn(a)}else Mn(a);else if(3==(n=b.s)||0==n&&0<b.ca||!(1==e&&function(a,b){return!(Xe(a.i)>=a.i.j-(a.m?1:0)||(a.m?(a.j=b.F.concat(a.j),0):1==a.H||2==a.H||a.C>=(a.cb?0:a.eb)||(a.m=Zt(q(a.Na,a,b),jn(a,a.C)),a.C++,0)))}(a,b)||2==e&&Pn(a)))switch(t&&0<t.length&&(b=a.i,b.i=b.i.concat(t)),n){case 1:Un(a,5);break;case 4:Un(a,10);break;case 3:Un(a,6);break;default:Un(a,2)}}function jn(a,b){let t=a.ab+Math.floor(Math.random()*a.hb);return a.isActive()||(t*=2),t*b}function Un(a,b){if(a.l.info("Error code "+b),2==b){var t=null;a.h&&(t=null);var e=q(a.pb,a);t||(t=new De("//www.google.com/images/cleardot.gif"),l.location&&"http"==l.location.protocol||Ne(t,"https"),Me(t)),function(a,b){const t=new Gt;if(l.Image){const e=new Image;e.onload=v(sn,t,e,"TestLoadImage: loaded",!0,b),e.onerror=v(sn,t,e,"TestLoadImage: error",!1,b),e.onabort=v(sn,t,e,"TestLoadImage: abort",!1,b),e.ontimeout=v(sn,t,e,"TestLoadImage: timeout",!1,b),l.setTimeout((function(){e.ontimeout&&e.ontimeout()}),1e4),e.src=a}else b(!1)}(t.toString(),e)}else Xt(2);a.H=0,a.h&&a.h.za(b),Bn(a),An(a)}function Bn(a){if(a.H=0,a.ma=[],a.h){const b=en(a.i);0==b.length&&0==a.j.length||(S(a.ma,b),S(a.ma,a.j),a.i.i.length=0,T(a.j),a.j.length=0),a.h.ya()}}function Gn(a,b,t){var e=t instanceof De?Ae(t):new De(t);if(""!=e.g)b&&(e.g=b+"."+e.g),ke(e,e.m);else{var n=l.location;e=n.protocol,b=b?b+"."+n.hostname:n.hostname,n=+n.port;var r=new De(null);e&&Ne(r,e),b&&(r.g=b),n&&ke(r,n),t&&(r.l=t),e=r}return t=a.F,b=a.Da,t&&b&&Re(e,t,b),Re(e,"VER",a.ra),On(a,e),e}function zn(a,b,t){if(b&&!a.J)throw Error("Can't create secondary domain capable XhrIo object.");return(b=a.Ha&&!a.va?new fn(new on({ob:t})):new fn(a.va)).Oa(a.J),b}function Kn(){}function $n(){if(P&&!(10<=Number($)))throw Error("Environmental error: no available transport.")}function Qn(a,b){bt.call(this),this.g=new xn(b),this.l=a,this.h=b&&b.messageUrlParams||null,a=b&&b.messageHeaders||null,b&&b.clientProtocolHeaderRequired&&(a?a["X-Client-Protocol"]="webchannel":a={"X-Client-Protocol":"webchannel"}),this.g.s=a,a=b&&b.initMessageHeaders||null,b&&b.messageContentType&&(a?a["X-WebChannel-Content-Type"]=b.messageContentType:a={"X-WebChannel-Content-Type":b.messageContentType}),b&&b.Ca&&(a?a["X-WebChannel-Client-Profile"]=b.Ca:a={"X-WebChannel-Client-Profile":b.Ca}),this.g.U=a,(a=b&&b.cc)&&!D(a)&&(this.g.o=a),this.A=b&&b.supportsCrossDomainXhr||!1,this.v=b&&b.sendRawJson||!1,(b=b&&b.httpSessionIdParam)&&!D(b)&&(this.g.F=b,null!==(a=this.h)&&b in a&&(b in(a=this.h)&&delete a[b])),this.j=new Yn(this)}function Wn(a){ae.call(this),a.__headers__&&(this.headers=a.__headers__,this.statusCode=a.__status__,delete a.__headers__,delete a.__status__);var b=a.__sm__;if(b){t:{for(const t in b){a=t;break t}a=void 0}(this.i=a)&&(a=this.i,b=null!==b&&a in b?b[a]:void 0),this.data=b}else this.data=a}function Hn(){ue.call(this),this.status=1}function Yn(a){this.g=a}function Xn(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Jn(a,b,t){t||(t=0);var e=Array(16);if("string"==typeof b)for(var n=0;16>n;++n)e[n]=b.charCodeAt(t++)|b.charCodeAt(t++)<<8|b.charCodeAt(t++)<<16|b.charCodeAt(t++)<<24;else for(n=0;16>n;++n)e[n]=b[t++]|b[t++]<<8|b[t++]<<16|b[t++]<<24;b=a.g[0],t=a.g[1],n=a.g[2];var r=a.g[3],o=b+(r^t&(n^r))+e[0]+3614090360&4294967295;o=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=(t=(n=(r=(b=t+(o<<7&4294967295|o>>>25))+((o=r+(n^b&(t^n))+e[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=n+(t^r&(b^t))+e[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=t+(b^n&(r^b))+e[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=b+(r^t&(n^r))+e[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=r+(n^b&(t^n))+e[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=n+(t^r&(b^t))+e[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=t+(b^n&(r^b))+e[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=b+(r^t&(n^r))+e[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=r+(n^b&(t^n))+e[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=n+(t^r&(b^t))+e[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=t+(b^n&(r^b))+e[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=b+(r^t&(n^r))+e[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=r+(n^b&(t^n))+e[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=n+(t^r&(b^t))+e[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=t+(b^n&(r^b))+e[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=b+(n^r&(t^n))+e[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=r+(t^n&(b^t))+e[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=n+(b^t&(r^b))+e[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=t+(r^b&(n^r))+e[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=b+(n^r&(t^n))+e[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=r+(t^n&(b^t))+e[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=n+(b^t&(r^b))+e[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=t+(r^b&(n^r))+e[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=b+(n^r&(t^n))+e[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=r+(t^n&(b^t))+e[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=n+(b^t&(r^b))+e[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=t+(r^b&(n^r))+e[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=b+(n^r&(t^n))+e[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=r+(t^n&(b^t))+e[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=n+(b^t&(r^b))+e[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=t+(r^b&(n^r))+e[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=b+(t^n^r)+e[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=r+(b^t^n)+e[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=n+(r^b^t)+e[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=t+(n^r^b)+e[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=b+(t^n^r)+e[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=r+(b^t^n)+e[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=n+(r^b^t)+e[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=t+(n^r^b)+e[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=b+(t^n^r)+e[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=r+(b^t^n)+e[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=n+(r^b^t)+e[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=t+(n^r^b)+e[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=b+(t^n^r)+e[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=r+(b^t^n)+e[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=n+(r^b^t)+e[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=t+(n^r^b)+e[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=b+(n^(t|~r))+e[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=r+(t^(b|~n))+e[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=n+(b^(r|~t))+e[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=t+(r^(n|~b))+e[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=b+(n^(t|~r))+e[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=r+(t^(b|~n))+e[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=n+(b^(r|~t))+e[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=t+(r^(n|~b))+e[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=b+(n^(t|~r))+e[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=r+(t^(b|~n))+e[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=n+(b^(r|~t))+e[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=t+(r^(n|~b))+e[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((r=(b=t+((o=b+(n^(t|~r))+e[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=r+(t^(b|~n))+e[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((n=r+((o=n+(b^(r|~t))+e[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~b))+e[9]+3951481745&4294967295,a.g[0]=a.g[0]+b&4294967295,a.g[1]=a.g[1]+(n+(o<<21&4294967295|o>>>11))&4294967295,a.g[2]=a.g[2]+n&4294967295,a.g[3]=a.g[3]+r&4294967295}function Zn(a,b){this.h=b;for(var t=[],e=!0,n=a.length-1;0<=n;n--){var r=0|a[n];e&&r==b||(t[n]=r,e=!1)}this.g=t}(r=fn.prototype).Oa=function(a){this.M=a},r.ha=function(a,b,t,e){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+a);b=b?b.toUpperCase():"GET",this.I=a,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():ie.g(),this.C=this.u?re(this.u):re(ie),this.g.onreadystatechange=q(this.La,this);try{this.G=!0,this.g.open(b,String(a),!0),this.G=!1}catch(t){return void pn(this,t)}if(a=t||"",t=new Map(this.headers),e)if(Object.getPrototypeOf(e)===Object.prototype)for(var n in e)t.set(n,e[n]);else{if("function"!=typeof e.keys||"function"!=typeof e.get)throw Error("Unknown input type for opt_headers: "+String(e));for(const n of e.keys())t.set(n,e.get(n))}e=Array.from(t.keys()).find((t=>"content-type"==t.toLowerCase())),n=l.FormData&&a instanceof l.FormData,!(0<=E(gn,b))||e||n||t.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[e,n]of t)this.g.setRequestHeader(e,n);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{bn(this),0<this.B&&((this.L=function(a){return P&&"number"==typeof a.timeout&&void 0!==a.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=q(this.ua,this)):this.A=Ft(this.ua,this.B,this)),this.v=!0,this.g.send(a),this.v=!1}catch(t){pn(this,t)}},r.ua=function(){void 0!==h&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,_t(this,"timeout"),this.abort(8))},r.abort=function(a){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=a||7,_t(this,"complete"),_t(this,"abort"),vn(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),vn(this,!0)),fn.$.N.call(this)},r.La=function(){this.s||(this.G||this.v||this.l?wn(this):this.kb())},r.kb=function(){wn(this)},r.isActive=function(){return!!this.g},r.da=function(){try{return 2<_n(this)?this.g.status:-1}catch(t){return-1}},r.ja=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},r.Wa=function(a){if(this.g){var b=this.g.responseText;return a&&0==b.indexOf(a)&&(b=b.substring(a.length)),dn(b)}},r.Ia=function(){return this.m},r.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(r=xn.prototype).ra=8,r.H=1,r.Na=function(a){if(this.m)if(this.m=null,1==this.H){if(!a){this.W=Math.floor(1e5*Math.random()),a=this.W++;const n=new he(this,this.l,a);let r=this.s;if(this.U&&(r?(r=tt(r),nt(r,this.U)):r=this.U),null!==this.o||this.O||(n.I=r,r=null),this.P)t:{for(var b=0,t=0;t<this.j.length;t++){var e=this.j[t];if(void 0===(e="__data__"in e.map&&"string"==typeof(e=e.map.__data__)?e.length:void 0))break;if(4096<(b+=e)){b=t;break t}if(4096===b||t===this.j.length-1){b=t+1;break t}}b=1e3}else b=1e3;b=Rn(this,n,b),Re(t=Ae(this.I),"RID",a),Re(t,"CVER",22),this.F&&Re(t,"X-HTTP-Session-Id",this.F),On(this,t),r&&(this.O?b="headers="+encodeURIComponent(String(En(r)))+"&"+b:this.o&&Tn(t,this.o,r)),Ze(this.i,n),this.bb&&Re(t,"TYPE","init"),this.P?(Re(t,"$req",b),Re(t,"SID","null"),n.aa=!0,ge(n,t,null)):ge(n,t,b),this.H=2}}else 3==this.H&&(a?kn(this,a):0==this.j.length||Ye(this.i)||kn(this))},r.Ma=function(){if(this.u=null,Ln(this),this.ca&&!(this.M||null==this.g||0>=this.S)){var a=2*this.S;this.l.info("BP detection timer enabled: "+a),this.B=Zt(q(this.jb,this),a)}},r.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Xt(10),Dn(this),Ln(this))},r.ib=function(){null!=this.v&&(this.v=null,Dn(this),Pn(this),Xt(19))},r.pb=function(a){a?(this.l.info("Successfully pinged google.com"),Xt(2)):(this.l.info("Failed to ping google.com"),Xt(1))},r.isActive=function(){return!!this.h&&this.h.isActive(this)},(r=Kn.prototype).Ba=function(){},r.Aa=function(){},r.za=function(){},r.ya=function(){},r.isActive=function(){return!0},r.Va=function(){},$n.prototype.g=function(a,b){return new Qn(a,b)},_(Qn,bt),Qn.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var a=this.g,b=this.l,t=this.h||void 0;Xt(0),a.Y=b,a.na=t||{},a.G=a.aa,a.I=Gn(a,null,a.Y),Nn(a)},Qn.prototype.close=function(){Cn(this.g)},Qn.prototype.u=function(a){var b=this.g;if("string"==typeof a){var t={};t.__data__=a,a=t}else this.v&&((t={}).__data__=Et(a),a=t);b.j.push(new class{constructor(a,b){this.g=a,this.map=b}}(b.fb++,a)),3==b.H&&Nn(b)},Qn.prototype.N=function(){this.g.h=null,delete this.j,Cn(this.g),delete this.g,Qn.$.N.call(this)},_(Wn,ae),_(Hn,ue),_(Yn,Kn),Yn.prototype.Ba=function(){_t(this.g,"a")},Yn.prototype.Aa=function(a){_t(this.g,new Wn(a))},Yn.prototype.za=function(a){_t(this.g,new Hn)},Yn.prototype.ya=function(){_t(this.g,"b")},_(Xn,(function(){this.blockSize=-1})),Xn.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Xn.prototype.j=function(a,b){void 0===b&&(b=a.length);for(var t=b-this.blockSize,e=this.m,n=this.h,r=0;r<b;){if(0==n)for(;r<=t;)Jn(this,a,r),r+=this.blockSize;if("string"==typeof a){for(;r<b;)if(e[n++]=a.charCodeAt(r++),n==this.blockSize){Jn(this,e),n=0;break}}else for(;r<b;)if(e[n++]=a[r++],n==this.blockSize){Jn(this,e),n=0;break}}this.h=n,this.i+=b},Xn.prototype.l=function(){var a=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);a[0]=128;for(var b=1;b<a.length-8;++b)a[b]=0;var t=8*this.i;for(b=a.length-8;b<a.length;++b)a[b]=255&t,t/=256;for(this.j(a),a=Array(16),b=t=0;4>b;++b)for(var e=0;32>e;e+=8)a[t++]=this.g[b]>>>e&255;return a};var er={};function nr(a){return-128<=a&&128>a?function(a,b){var t=er;return Object.prototype.hasOwnProperty.call(t,a)?t[a]:t[a]=b(a)}(a,(function(b){return new Zn([0|b],0>b?-1:0)})):new Zn([0|a],0>a?-1:0)}function rr(a){if(isNaN(a)||!isFinite(a))return ir;if(0>a)return lr(rr(-a));for(var b=[],t=1,e=0;a>=t;e++)b[e]=a/t|0,t*=sr;return new Zn(b,0)}var sr=4294967296,ir=nr(0),or=nr(1),ar=nr(16777216);function ur(a){if(0!=a.h)return!1;for(var b=0;b<a.g.length;b++)if(0!=a.g[b])return!1;return!0}function cr(a){return-1==a.h}function lr(a){for(var b=a.g.length,t=[],e=0;e<b;e++)t[e]=~a.g[e];return new Zn(t,~a.h).add(or)}function dr(a,b){return a.add(lr(b))}function fr(a,b){for(;(65535&a[b])!=a[b];)a[b+1]+=a[b]>>>16,a[b]&=65535,b++}function mr(a,b){this.g=a,this.h=b}function gr(a,b){if(ur(b))throw Error("division by zero");if(ur(a))return new mr(ir,ir);if(cr(a))return b=gr(lr(a),b),new mr(lr(b.g),lr(b.h));if(cr(b))return b=gr(a,lr(b)),new mr(lr(b.g),b.h);if(30<a.g.length){if(cr(a)||cr(b))throw Error("slowDivide_ only works with positive integers.");for(var t=or,e=b;0>=e.X(a);)t=pr(t),e=pr(e);var n=yr(t,1),r=yr(e,1);for(e=yr(e,2),t=yr(t,2);!ur(e);){var o=r.add(e);0>=o.X(a)&&(n=n.add(t),r=o),e=yr(e,1),t=yr(t,1)}return b=dr(a,n.R(b)),new mr(n,b)}for(n=ir;0<=a.X(b);){for(t=Math.max(1,Math.floor(a.ea()/b.ea())),e=48>=(e=Math.ceil(Math.log(t)/Math.LN2))?1:Math.pow(2,e-48),o=(r=rr(t)).R(b);cr(o)||0<o.X(a);)o=(r=rr(t-=e)).R(b);ur(r)&&(r=or),n=n.add(r),a=dr(a,o)}return new mr(n,a)}function pr(a){for(var b=a.g.length+1,t=[],e=0;e<b;e++)t[e]=a.D(e)<<1|a.D(e-1)>>>31;return new Zn(t,a.h)}function yr(a,b){var t=b>>5;b%=32;for(var e=a.g.length-t,n=[],r=0;r<e;r++)n[r]=0<b?a.D(r+t)>>>b|a.D(r+t+1)<<32-b:a.D(r+t);return new Zn(n,a.h)}(r=Zn.prototype).ea=function(){if(cr(this))return-lr(this).ea();for(var a=0,b=1,t=0;t<this.g.length;t++){var e=this.D(t);a+=(0<=e?e:sr+e)*b,b*=sr}return a},r.toString=function(a){if(2>(a=a||10)||36<a)throw Error("radix out of range: "+a);if(ur(this))return"0";if(cr(this))return"-"+lr(this).toString(a);for(var b=rr(Math.pow(a,6)),t=this,e="";;){var n=gr(t,b).g,r=((0<(t=dr(t,n.R(b))).g.length?t.g[0]:t.h)>>>0).toString(a);if(ur(t=n))return r+e;for(;6>r.length;)r="0"+r;e=r+e}},r.D=function(a){return 0>a?0:a<this.g.length?this.g[a]:this.h},r.X=function(a){return cr(a=dr(this,a))?-1:ur(a)?0:1},r.abs=function(){return cr(this)?lr(this):this},r.add=function(a){for(var b=Math.max(this.g.length,a.g.length),t=[],e=0,n=0;n<=b;n++){var r=e+(65535&this.D(n))+(65535&a.D(n)),o=(r>>>16)+(this.D(n)>>>16)+(a.D(n)>>>16);e=o>>>16,r&=65535,o&=65535,t[n]=o<<16|r}return new Zn(t,-2147483648&t[t.length-1]?-1:0)},r.R=function(a){if(ur(this)||ur(a))return ir;if(cr(this))return cr(a)?lr(this).R(lr(a)):lr(lr(this).R(a));if(cr(a))return lr(this.R(lr(a)));if(0>this.X(ar)&&0>a.X(ar))return rr(this.ea()*a.ea());for(var b=this.g.length+a.g.length,t=[],e=0;e<2*b;e++)t[e]=0;for(e=0;e<this.g.length;e++)for(var n=0;n<a.g.length;n++){var r=this.D(e)>>>16,o=65535&this.D(e),c=a.D(n)>>>16,h=65535&a.D(n);t[2*e+2*n]+=o*h,fr(t,2*e+2*n),t[2*e+2*n+1]+=r*h,fr(t,2*e+2*n+1),t[2*e+2*n+1]+=o*c,fr(t,2*e+2*n+1),t[2*e+2*n+2]+=r*c,fr(t,2*e+2*n+2)}for(e=0;e<b;e++)t[e]=t[2*e+1]<<16|t[2*e];for(e=b;e<2*b;e++)t[e]=0;return new Zn(t,0)},r.gb=function(a){return gr(this,a).h},r.and=function(a){for(var b=Math.max(this.g.length,a.g.length),t=[],e=0;e<b;e++)t[e]=this.D(e)&a.D(e);return new Zn(t,this.h&a.h)},r.or=function(a){for(var b=Math.max(this.g.length,a.g.length),t=[],e=0;e<b;e++)t[e]=this.D(e)|a.D(e);return new Zn(t,this.h|a.h)},r.xor=function(a){for(var b=Math.max(this.g.length,a.g.length),t=[],e=0;e<b;e++)t[e]=this.D(e)^a.D(e);return new Zn(t,this.h^a.h)},$n.prototype.createWebChannel=$n.prototype.g,Qn.prototype.send=Qn.prototype.u,Qn.prototype.open=Qn.prototype.m,Qn.prototype.close=Qn.prototype.close,te.NO_ERROR=0,te.TIMEOUT=8,te.HTTP_ERROR=6,ee.COMPLETE="complete",se.EventType=oe,oe.OPEN="a",oe.CLOSE="b",oe.ERROR="c",oe.MESSAGE="d",bt.prototype.listen=bt.prototype.O,fn.prototype.listenOnce=fn.prototype.P,fn.prototype.getLastError=fn.prototype.Sa,fn.prototype.getLastErrorCode=fn.prototype.Ia,fn.prototype.getStatus=fn.prototype.da,fn.prototype.getResponseJson=fn.prototype.Wa,fn.prototype.getResponseText=fn.prototype.ja,fn.prototype.send=fn.prototype.ha,fn.prototype.setWithCredentials=fn.prototype.Oa,Xn.prototype.digest=Xn.prototype.l,Xn.prototype.reset=Xn.prototype.reset,Xn.prototype.update=Xn.prototype.j,Zn.prototype.add=Zn.prototype.add,Zn.prototype.multiply=Zn.prototype.R,Zn.prototype.modulo=Zn.prototype.gb,Zn.prototype.compare=Zn.prototype.X,Zn.prototype.toNumber=Zn.prototype.ea,Zn.prototype.toString=Zn.prototype.toString,Zn.prototype.getBits=Zn.prototype.D,Zn.fromNumber=rr,Zn.fromString=function t(a,b){if(0==a.length)throw Error("number format error: empty string");if(2>(b=b||10)||36<b)throw Error("radix out of range: "+b);if("-"==a.charAt(0))return lr(t(a.substring(1),b));if(0<=a.indexOf("-"))throw Error('number format error: interior "-" character');for(var e=rr(Math.pow(b,8)),n=ir,r=0;r<a.length;r+=8){var o=Math.min(8,a.length-r),c=parseInt(a.substring(r,r+o),b);8>o?(o=rr(Math.pow(b,o)),n=n.R(o).add(rr(c))):n=(n=n.R(e)).add(rr(c))}return n};var wr=c.createWebChannelTransport=function(){return new $n},vr=c.getStatEventTarget=function(){return Qt()},_r=c.ErrorCode=te,Ir=c.EventType=ee,Er=c.Event=Kt,Tr=c.Stat={xb:0,Ab:1,Bb:2,Ub:3,Zb:4,Wb:5,Xb:6,Vb:7,Tb:8,Yb:9,PROXY:10,NOPROXY:11,Rb:12,Nb:13,Ob:14,Mb:15,Pb:16,Qb:17,tb:18,sb:19,ub:20},Sr=(c.FetchXmlHttpFactory=on,c.WebChannel=se),xr=c.XhrIo=fn,Cr=c.Md5=Xn,Dr=c.Integer=Zn}).call(this,n(72))},514:function(t,e,n){"use strict";n.r(e);var r=n(448),o=n(506),c=n(444),h=n(446);function l(t,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new o.g("invalid-argument",`Invalid options passed to function ${t}(): You cannot specify both "merge" and "mergeFields".`);return e}function d(){if("undefined"==typeof Uint8Array)throw new o.g("unimplemented","Uint8Arrays are not available in this environment.")}function f(){if(!Object(o.r)())throw new o.g("unimplemented","Blobs are unavailable in Firestore in this environment.")}class m{constructor(t){this._delegate=t}static fromBase64String(t){return f(),new m(o.b.fromBase64String(t))}static fromUint8Array(t){return d(),new m(o.b.fromUint8Array(t))}toBase64(){return f(),this._delegate.toBase64()}toUint8Array(){return d(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function y(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const object=t;for(const t of e)if(t in object&&"function"==typeof object[t])return!0;return!1}(t,["next","error","complete"])}class w{enableIndexedDbPersistence(t,e){return Object(o.F)(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return Object(o.G)(t._delegate)}clearIndexedDbPersistence(t){return Object(o.x)(t._delegate)}}class v{constructor(t,e,n){this._delegate=e,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},t instanceof o.m||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){const e=this._delegate._getSettings();t.merge||e.host===t.host||Object(o.s)("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&delete(t=Object.assign(Object.assign({},e),t)).merge,this._delegate._setSettings(t)}useEmulator(t,e,n={}){Object(o.A)(this._delegate,t,e,n)}enableNetwork(){return Object(o.H)(this._delegate)}disableNetwork(){return Object(o.D)(this._delegate)}enablePersistence(t){let e=!1,n=!1;return t&&(e=!!t.synchronizeTabs,n=!!t.experimentalForceOwningTab,Object(o.t)("synchronizeTabs",e,"experimentalForceOwningTab",n)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Object(o.lb)(this._delegate)}onSnapshotsInSync(t){return Object(o.Y)(this._delegate,t)}get app(){if(!this._appCompat)throw new o.g("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new M(this,Object(o.y)(this._delegate,t))}catch(t){throw x(t,"collection()","Firestore.collection()")}}doc(t){try{return new S(this,Object(o.E)(this._delegate,t))}catch(t){throw x(t,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new k(this,Object(o.z)(this._delegate,t))}catch(t){throw x(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Object(o.db)(this._delegate,(e=>t(new I(this,e))))}batch(){return Object(o.K)(this._delegate),new E(new o.l(this._delegate,(t=>Object(o.L)(this._delegate,t))))}loadBundle(t){return Object(o.V)(this._delegate,t)}namedQuery(t){return Object(o.W)(this._delegate,t).then((t=>t?new k(this,t):null))}}class _ extends o.a{constructor(t){super(),this.firestore=t}convertBytes(t){return new m(new o.b(t))}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return S.forKey(e,this.firestore,null)}}class I{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new _(t)}get(t){const e=P(t);return this._delegate.get(e).then((t=>new A(this._firestore,new o.e(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,e.converter))))}set(t,data,e){const n=P(t);return e?(l("Transaction.set",e),this._delegate.set(n,data,e)):this._delegate.set(n,data),this}update(t,e,n,...r){const o=P(t);return 2===arguments.length?this._delegate.update(o,e):this._delegate.update(o,e,n,...r),this}delete(t){const e=P(t);return this._delegate.delete(e),this}}class E{constructor(t){this._delegate=t}set(t,data,e){const n=P(t);return e?(l("WriteBatch.set",e),this._delegate.set(n,data,e)):this._delegate.set(n,data),this}update(t,e,n,...r){const o=P(t);return 2===arguments.length?this._delegate.update(o,e):this._delegate.update(o,e,n,...r),this}delete(t){const e=P(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class T{constructor(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}fromFirestore(t,e){const n=new o.i(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new N(this._firestore,n),null!=e?e:{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){const n=T.INSTANCES;let r=n.get(t);r||(r=new WeakMap,n.set(t,r));let o=r.get(e);return o||(o=new T(t,new _(t),e),r.set(e,o)),o}}T.INSTANCES=new WeakMap;class S{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new _(t)}static forPath(path,t,e){if(path.length%2!=0)throw new o.g("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${path.canonicalString()} has ${path.length}`);return new S(t,new o.d(t._delegate,e,new o.n(path)))}static forKey(t,e,n){return new S(e,new o.d(e._delegate,n,t))}get id(){return this._delegate.id}get parent(){return new M(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new M(this.firestore,Object(o.y)(this._delegate,t))}catch(t){throw x(t,"collection()","DocumentReference.collection()")}}isEqual(t){return(t=Object(c.p)(t))instanceof o.d&&Object(o.cb)(this._delegate,t)}set(t,e){e=l("DocumentReference.set",e);try{return e?Object(o.fb)(this._delegate,t,e):Object(o.fb)(this._delegate,t)}catch(t){throw x(t,"setDoc()","DocumentReference.set()")}}update(t,e,...n){try{return 1===arguments.length?Object(o.kb)(this._delegate,t):Object(o.kb)(this._delegate,t,e,...n)}catch(t){throw x(t,"updateDoc()","DocumentReference.update()")}}delete(){return Object(o.B)(this._delegate)}onSnapshot(...t){const e=C(t),n=D(t,(t=>new A(this.firestore,new o.e(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter))));return Object(o.X)(this._delegate,e,n)}get(t){let e;return e="cache"===(null==t?void 0:t.source)?Object(o.N)(this._delegate):"server"===(null==t?void 0:t.source)?Object(o.O)(this._delegate):Object(o.M)(this._delegate),e.then((t=>new A(this.firestore,new o.e(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter))))}withConverter(t){return new S(this.firestore,t?this._delegate.withConverter(T.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function x(t,e,n){return t.message=t.message.replace(e,n),t}function C(t){for(const e of t)if("object"==typeof e&&!y(e))return e;return{}}function D(t,e){var n,r;let o;return o=y(t[0])?t[0]:y(t[1])?t[1]:"function"==typeof t[0]?{next:t[0],error:t[1],complete:t[2]}:{next:t[1],error:t[2],complete:t[3]},{next:t=>{o.next&&o.next(e(t))},error:null===(n=o.error)||void 0===n?void 0:n.bind(o),complete:null===(r=o.complete)||void 0===r?void 0:r.bind(o)}}class A{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new S(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return Object(o.hb)(this._delegate,t._delegate)}}class N extends A{data(t){const data=this._delegate.data(t);return this._delegate._converter||Object(o.q)(void 0!==data,"Document in a QueryDocumentSnapshot should exist"),data}}class k{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new _(t)}where(t,e,n){try{return new k(this.firestore,Object(o.ab)(this._delegate,Object(o.mb)(t,e,n)))}catch(t){throw x(t,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(t,e){try{return new k(this.firestore,Object(o.ab)(this._delegate,Object(o.Z)(t,e)))}catch(t){throw x(t,/(orderBy|where)\(\)/,"Query.$1()")}}limit(t){try{return new k(this.firestore,Object(o.ab)(this._delegate,Object(o.T)(t)))}catch(t){throw x(t,"limit()","Query.limit()")}}limitToLast(t){try{return new k(this.firestore,Object(o.ab)(this._delegate,Object(o.U)(t)))}catch(t){throw x(t,"limitToLast()","Query.limitToLast()")}}startAt(...t){try{return new k(this.firestore,Object(o.ab)(this._delegate,Object(o.jb)(...t)))}catch(t){throw x(t,"startAt()","Query.startAt()")}}startAfter(...t){try{return new k(this.firestore,Object(o.ab)(this._delegate,Object(o.ib)(...t)))}catch(t){throw x(t,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new k(this.firestore,Object(o.ab)(this._delegate,Object(o.J)(...t)))}catch(t){throw x(t,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new k(this.firestore,Object(o.ab)(this._delegate,Object(o.I)(...t)))}catch(t){throw x(t,"endAt()","Query.endAt()")}}isEqual(t){return Object(o.bb)(this._delegate,t._delegate)}get(t){let e;return e="cache"===(null==t?void 0:t.source)?Object(o.Q)(this._delegate):"server"===(null==t?void 0:t.source)?Object(o.R)(this._delegate):Object(o.P)(this._delegate),e.then((t=>new R(this.firestore,new o.j(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot))))}onSnapshot(...t){const e=C(t),n=D(t,(t=>new R(this.firestore,new o.j(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot))));return Object(o.X)(this._delegate,e,n)}withConverter(t){return new k(this.firestore,t?this._delegate.withConverter(T.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}class O{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new N(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class R{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new k(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map((t=>new N(this._firestore,t)))}docChanges(t){return this._delegate.docChanges(t).map((t=>new O(this._firestore,t)))}forEach(t,e){this._delegate.forEach((n=>{t.call(e,new N(this._firestore,n))}))}isEqual(t){return Object(o.hb)(this._delegate,t._delegate)}}class M extends k{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){const t=this._delegate.parent;return t?new S(this.firestore,t):null}doc(t){try{return new S(this.firestore,void 0===t?Object(o.E)(this._delegate):Object(o.E)(this._delegate,t))}catch(t){throw x(t,"doc()","CollectionReference.doc()")}}add(data){return Object(o.u)(this._delegate,data).then((t=>new S(this.firestore,t)))}isEqual(t){return Object(o.cb)(this._delegate,t._delegate)}withConverter(t){return new M(this.firestore,t?this._delegate.withConverter(T.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function P(t){return Object(o.p)(t,o.d)}class F{constructor(...t){this._delegate=new o.f(...t)}static documentId(){return new F(o.o.keyField().canonicalString())}isEqual(t){return(t=Object(c.p)(t))instanceof o.f&&this._delegate._internalPath.isEqual(t._internalPath)}}class L{constructor(t){this._delegate=t}static serverTimestamp(){const t=Object(o.eb)();return t._methodName="FieldValue.serverTimestamp",new L(t)}static delete(){const t=Object(o.C)();return t._methodName="FieldValue.delete",new L(t)}static arrayUnion(...t){const e=Object(o.w)(...t);return e._methodName="FieldValue.arrayUnion",new L(e)}static arrayRemove(...t){const e=Object(o.v)(...t);return e._methodName="FieldValue.arrayRemove",new L(e)}static increment(t){const e=Object(o.S)(t);return e._methodName="FieldValue.increment",new L(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}}const V={Firestore:v,GeoPoint:o.h,Timestamp:o.k,Blob:m,Transaction:I,WriteBatch:E,DocumentReference:S,DocumentSnapshot:A,Query:k,QueryDocumentSnapshot:N,QuerySnapshot:R,CollectionReference:M,FieldPath:F,FieldValue:L,setLogLevel:function(t){Object(o.gb)(t)},CACHE_SIZE_UNLIMITED:o.c};var j,U;j=r.a,U=(t,e)=>new v(t,e,new w),j.INTERNAL.registerComponent(new h.a("firestore-compat",(t=>{const e=t.getProvider("app-compat").getImmediate(),n=t.getProvider("firestore").getImmediate();return U(e,n)}),"PUBLIC").setServiceProps(Object.assign({},V))),j.registerVersion("@firebase/firestore-compat","0.3.28")}}]);